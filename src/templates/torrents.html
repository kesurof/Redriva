{% extends "base.html" %}

{% block title %}Torrents - Redriva Web{% endblock %}

{% block content %}
<!-- Messages de notification (copi√© depuis dashboard.html) -->
<div id="toast-container" class="toast-container"></div>

<style>
/* Animations pour le modal de rafra√Æchissement */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes progress {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}

/* Style pour les indicateurs de fra√Æcheur */
.refresh-indicator {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Animation pour les boutons de retry */
.retry-button:hover {
    transform: scale(1.05);
    transition: transform 0.2s ease;
}

/* STYLES COPI√âS DEPUIS DASHBOARD.HTML */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.toast {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 16px;
    margin-bottom: 10px;
    border-left: 4px solid;
    min-width: 300px;
    animation: slideIn 0.3s ease;
}

.toast.success { border-left-color: #28a745; }
.toast.error { border-left-color: #dc3545; }
.toast.info { border-left-color: #17a2b8; }
.toast.warning { border-left-color: #ffc107; }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>

<!-- En-t√™te avec actions -->
<div class="card filters-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: #333; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                üìã Gestion des torrents
            </h2>
        </div>
    </div>
    
    <!-- Filtres et recherche -->
    <div class="filters-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; margin-bottom: 0; border: 2px solid #e0e0e0;">
        <form method="GET" action="/torrents" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
            <!-- Pr√©server les param√®tres actuels -->
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="dir" value="{{ sort_dir }}">
            
            <!-- Recherche -->
            <div style="display: flex; align-items: center; gap: 12px;">
                <label for="search" style="font-weight: 600; color: #333; font-size: 14px;">Recherche:</label>
                <input type="text" 
                       id="search" 
                       name="search" 
                       value="{{ search }}" 
                       placeholder="Nom du torrent..." 
                       style="padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; min-width: 200px; font-size: 14px; transition: all 0.3s ease; background: white;">
            </div>
            
            <!-- Filtre par statut -->
            <div style="display: flex; align-items: center; gap: 12px;">
                <label for="status" style="font-weight: 600; color: #333; font-size: 14px;">Statut:</label>
                <select id="status" name="status" style="padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; transition: all 0.3s ease;">
                    <option value="">Tous les statuts</option>
                    {% for status_info in available_statuses %}
                    <option value="{{ status_info[0] }}" {% if status_filter == status_info[0] %}selected{% endif %}>
                        {{ status_info[0] }} ({{ status_info[1] }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary">üîç Filtrer</button>
            <a href="/torrents" class="btn btn-secondary">üóëÔ∏è Effacer</a>
        </form>
    </div>
</div>

<!-- Statistiques rapides -->
<div class="card stats-card">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
        <a href="{{ url_for('torrents') }}" class="stat-item" style="text-align: center; text-decoration: none; color: inherit; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 20px; border-radius: 12px; background: white; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border-left: 4px solid #3498db;">
            <div style="font-size: 2em; font-weight: 700; color: #3498db; margin-bottom: 8px;">{{ total_count }}</div>
            <div style="font-size: 14px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total</div>
        </a>
        {% for status_info in available_statuses %}
        <a href="{{ url_for('torrents', status=status_info[0]) }}" class="stat-item" style="text-align: center; text-decoration: none; color: inherit; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 20px; border-radius: 12px; background: white; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border-left: 4px solid {% if status_info[0] == 'downloaded' %}#4CAF50{% elif 'error' in status_info[0] %}#f44336{% else %}#9e9e9e{% endif %};">
            <div style="font-size: 1.8em; font-weight: 700; color: {% if status_info[0] == 'downloaded' %}#4CAF50{% elif 'error' in status_info[0] %}#f44336{% else %}#9e9e9e{% endif %}; margin-bottom: 8px;">
                {{ status_info[1] }}
            </div>
            <div style="font-size: 13px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">{{ status_info[0] }}</div>
        </a>
        {% endfor %}
    </div>
</div>

<!-- Actions de s√©lection -->
<div id="selectionActions" style="display: none; margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <strong id="selectionCount">0</strong> torrents s√©lectionn√©s
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="clearSelection()" class="btn btn-secondary btn-sm">D√©s√©lectionner</button>
            <button onclick="confirmBatchDeletion()" class="btn btn-danger">üóëÔ∏è Supprimer la s√©lection</button>
        </div>
    </div>
</div>

<!-- Table des torrents -->
<div class="card torrents-card">
    {% if torrents %}
    <div class="table-responsive">
        <table class="table table-striped table-hover" style="margin: 0; border-radius: 12px; overflow: hidden;">
            <thead style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); position: sticky; top: 0; z-index: 10;">
                <tr style="border: none;">
                    <th style="width: 3%; padding: 16px; font-weight: 600; color: #333; border: none;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" title="S√©lectionner tout">
                    </th>
                    <th style="width: 5%;">
                        <a href="{{ url_for('torrents', sort='id', dir='asc' if sort_by == 'id' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            ID {% if sort_by == 'id' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 40%;">
                        <a href="{{ url_for('torrents', sort='filename', dir='asc' if sort_by == 'filename' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Nom {% if sort_by == 'filename' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 12%;">
                        <a href="{{ url_for('torrents', sort='status', dir='asc' if sort_by == 'status' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Statut {% if sort_by == 'status' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 10%;">
                        <a href="{{ url_for('torrents', sort='bytes', dir='asc' if sort_by == 'bytes' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Taille {% if sort_by == 'bytes' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 12%;">
                        <a href="{{ url_for('torrents', sort='added_on', dir='asc' if sort_by == 'added_on' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Date ajout {% if sort_by == 'added_on' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 8%;">Progression</th>
                    <th style="width: 13%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for torrent in torrents %}
                <tr data-torrent-id="{{ torrent.id }}">
                    <td>
                        <input type="checkbox" class="torrent-checkbox" value="{{ torrent.id }}" onchange="updateSelectionActions()">
                    </td>
                    <td style="font-family: monospace; font-size: 0.9em;">{{ torrent.id }}</td>
                    <td>
                        <span onclick="copyTorrentName({{ torrent.display_name|tojson }})" title="Cliquer pour copier le nom" style="cursor: copy; text-decoration: none; color: inherit; display: inline-flex; align-items: center; gap: 5px;">
                            {{ torrent.display_name[:50] + ('...' if torrent.display_name|length > 50 else '') }} üìã
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-{{ 'success' if torrent.current_status == 'downloaded' else 'danger' if 'error' in torrent.current_status else 'warning' }}"
                              style="padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;
                                     background: {% if torrent.current_status == 'downloaded' %}#d4edda; color: #155724{% elif 'error' in torrent.current_status %}#f8d7da; color: #721c24{% else %}#fff3cd; color: #856404{% endif %};">
                            {{ torrent.current_status }}
                        </span>
                    </td>
                    <td style="text-align: right; font-family: monospace;">{{ torrent.size_formatted }}</td>
                    <td style="font-family: monospace; font-size: 0.9em;">{{ torrent.added_date }}</td>
                    <td>
                        {% if torrent.progress > 0 %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="min-width: 40px; font-weight: bold; font-size: 0.9em;">
                                {{ '{:.1f}%'.format(torrent.progress) }}
                            </span>
                            <div style="flex: 1; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #007bff, #28a745); border-radius: 4px; transition: width 0.3s ease; width: {{ torrent.progress }}%;"></div>
                            </div>
                        </div>
                        {% else %}
                        <span style="color: #6c757d; font-size: 0.8em;">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 3px; justify-content: center;">
                            <button onclick="showDetailsModal('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #007bff; background: transparent; color: #007bff; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;"
                                    title="Voir d√©tails"
                                    onmouseover="this.style.background='#007bff'; this.style.color='white';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#007bff';">
                                üîç
                            </button>
                            <button onclick="deleteTorrent('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #dc3545; background: transparent; color: #dc3545; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;"
                                    title="Supprimer"
                                    onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#dc3545';">
                                üóëÔ∏è
                            </button>
                            {% if torrent.current_status in ['error', 'virus', 'dead'] %}
                            <button onclick="reinsertTorrent('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #28a745; background: transparent; color: #28a745; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;"
                                    title="R√©ins√©rer"
                                    onmouseover="this.style.background='#28a745'; this.style.color='white';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#28a745';">
                                ‚ôªÔ∏è
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <div class="pagination-container" style="padding: 20px; border-top: 1px solid #dee2e6; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div class="pagination-info" style="color: #6c757d; font-size: 0.9em;">
            Affichage {{ pagination.start_item }}-{{ pagination.end_item }} sur {{ pagination.total }} torrents
        </div>
        
        <div class="pagination-nav" style="display: flex; gap: 5px; align-items: center;">
            {% if pagination.has_prev %}
            <a href="{{ url_for('torrents', page=1, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">‚ùÆ‚ùÆ</a>
            <a href="{{ url_for('torrents', page=pagination.prev_page, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">‚ùÆ</a>
            {% else %}
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">‚ùÆ‚ùÆ</span>
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">‚ùÆ</span>
            {% endif %}
            
            {% set start_page = [1, pagination.page - 2]|max %}
            {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
            
            {% if start_page > 1 %}
            <span style="margin: 0 5px;">...</span>
            {% endif %}
            
            {% for page_num in range(start_page, end_page + 1) %}
            <a href="{{ url_for('torrents', page=page_num, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" 
               class="btn btn-sm {% if page_num == pagination.page %}btn-primary{% else %}btn-outline-primary{% endif %}">
                {{ page_num }}
            </a>
            {% endfor %}
            
            {% if end_page < pagination.total_pages %}
            <span style="margin: 0 5px;">...</span>
            {% endif %}
            
            {% if pagination.has_next %}
            <a href="{{ url_for('torrents', page=pagination.next_page, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">‚ùØ</a>
            <a href="{{ url_for('torrents', page=pagination.total_pages, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">‚ùØ‚ùØ</a>
            {% else %}
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">‚ùØ</span>
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">‚ùØ‚ùØ</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- √âtat vide -->
    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #6c757d;">
        <div style="font-size: 4em; opacity: 0.3; margin-bottom: 20px;">üì≠</div>
        {% if search or status_filter %}
        <h3>Aucun r√©sultat trouv√©</h3>
        <p>Aucun torrent ne correspond aux crit√®res de recherche.</p>
        <a href="/torrents" class="btn btn-primary">Voir tous les torrents</a>
        {% else %}
        <h3>Aucun torrent</h3>
        <p>Commencez par synchroniser vos torrents depuis Real-Debrid.</p>
        <a href="/sync/torrents" class="btn btn-success">‚¨áÔ∏è Synchroniser</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Modal pour les d√©tails de torrent -->
<div id="torrentModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="modal-content" style="background: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 15px;">
            <h3 id="modalTitle">D√©tails du torrent</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="refreshTorrentData()" 
                        class="btn btn-sm btn-outline-primary retry-button" 
                        style="padding: 4px 8px; font-size: 0.8em; border: 1px solid #007bff; background: transparent; color: #007bff; border-radius: 4px; cursor: pointer;"
                        title="Actualiser les donn√©es depuis Real-Debrid"
                        onmouseover="this.style.background='#007bff'; this.style.color='white';"
                        onmouseout="this.style.background='transparent'; this.style.color='#007bff';">
                    üîÑ Actualiser
                </button>
                <button class="close" onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
        </div>
        
        <div id="modalLoading" style="text-align: center; padding: 50px;">
            <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
            <div>Chargement des d√©tails...</div>
        </div>
        
        <div id="modalContent" style="display: none;">
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #495057;">üìã Informations g√©n√©rales</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                            <div style="margin-bottom: 8px;"><strong>ID:</strong> <span id="modalId" style="font-family: monospace;"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Nom:</strong> <span id="modalName"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Statut:</strong> <span id="modalStatus"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Taille:</strong> <span id="modalSize"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Fichiers:</strong> <span id="modalFiles"></span></div>
                            <div><strong>Hash:</strong> <span id="modalHash" style="font-family: monospace; font-size: 0.9em;"></span></div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #495057;">üìä Progression</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Progression:</span>
                                    <span id="modalProgress">0%</span>
                                </div>
                                <div style="background: #e9ecef; border-radius: 10px; height: 10px; width: 100%; overflow: hidden;">
                                    <div id="modalProgressBar" style="background: linear-gradient(90deg, #007bff, #28a745); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;"><strong>H√©bergeur:</strong> <span id="modalHost"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Ajout√© le:</strong> <span id="modalAdded"></span></div>
                            <div id="modalErrorContainer" style="display: none; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px; margin-top: 10px;">
                                <strong>Erreur:</strong> <span id="modalError"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="modalLinksContainer" style="display: none;">
                    <h4 style="margin-bottom: 10px; color: #495057;">üîó Liens de t√©l√©chargement</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        <div id="modalLinks"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="modalError" style="display: none; text-align: center; padding: 50px; color: #dc3545;">
            <div style="font-size: 2em; margin-bottom: 10px;">‚ùå</div>
            <div id="modalErrorText">Erreur lors du chargement des d√©tails</div>
        </div>
    </div>
</div>

<!-- Modal de progression pour suppression en masse -->
<div id="batchProgressModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 15px;">
            <h3>üóëÔ∏è Suppression en cours</h3>
        </div>
        <div class="modal-body">
            <div id="batchProgressInfo" style="margin-bottom: 20px;">
                <div>Progression: <span id="batchProgress">0</span>/<span id="batchTotal">0</span></div>
                <div style="margin: 10px 0;">
                    <div style="background: #e9ecef; border-radius: 10px; height: 10px; overflow: hidden;">
                        <div id="batchProgressBar" style="background: linear-gradient(90deg, #dc3545, #28a745); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                <div style="font-size: 0.9em; color: #6c757d;">
                    ‚úÖ <span id="batchSuccess">0</span> succ√®s ‚Ä¢ 
                    ‚ùå <span id="batchFailed">0</span> √©checs
                </div>
            </div>
            
            <div id="batchErrors" style="display: none; max-height: 200px; overflow-y: auto; background: #f8d7da; padding: 10px; border-radius: 4px;">
                <h6>Erreurs rencontr√©es :</h6>
                <ul id="batchErrorsList" style="margin: 0; padding-left: 20px;"></ul>
            </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            <button id="batchCloseBtn" onclick="closeBatchModal()" class="btn btn-secondary" disabled>Fermer</button>
            <button id="batchCancelBtn" onclick="cancelBatch()" class="btn btn-danger">Annuler</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<style>
/* Material Design Cards - Style harmonis√© avec symlink_tool */
.card { 
    background: white; 
    border: none;
    border-radius: 12px; 
    margin-bottom: 20px; 
    padding: 24px; 
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border-left: 4px solid #3498db;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
}

/* Cards avec couleurs d'accent sp√©cifiques */
.card.filters-card {
    border-left-color: #2196F3;
}

.card.stats-card {
    border-left-color: #4CAF50;
}

.card.torrents-card {
    border-left-color: #FF9800;
}

.table-responsive { 
    overflow-x: auto; 
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
}

/* Tables modernis√©es */
.table {
    border-collapse: separate;
    border-spacing: 0;
}

.table th {
    font-weight: 600;
    color: #333;
    border: none;
    padding: 16px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table td {
    border: none;
    padding: 16px;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.3s ease;
}

.table tbody tr:hover {
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.05) 0%, rgba(33, 150, 243, 0.02) 100%);
    transform: scale(1.001);
}

.table tbody tr:hover td {
    border-bottom-color: #2196F3;
}

/* Statistiques modernis√©es */
.stat-item:hover { 
    transform: scale(1.05) translateY(-2px); 
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(33, 150, 243, 0.05) 100%); 
    border-radius: 8px; 
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
}
/* Modals avec Material Design */
.modal { 
    animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
}

@keyframes fadeIn { 
    from { opacity: 0; } 
    to { opacity: 1; } 
}

.modal-content { 
    animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 16px;
    border: none;
    box-shadow: 0 16px 64px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(8px);
}

@keyframes slideIn { 
    from { transform: translateY(-60px) scale(0.95); opacity: 0; } 
    to { transform: translateY(0) scale(1); opacity: 1; } 
}
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes progress { 0% { transform: translateX(-100%); } 50% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

/* Styles pour les toasts - Material Design harmonis√© */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.toast {
    background: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    border-left: 4px solid #e0e0e0;
    min-width: 300px;
    max-width: 350px;
    transform: translateX(380px);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #333;
    font-weight: 500;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.toast-success {
    border-left-color: #4CAF50;
    background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
    color: #2e7d32;
}

.toast.toast-error {
    border-left-color: #f44336;
    background: linear-gradient(135deg, #ffebee 0%, #fde7e7 100%);
    color: #c62828;
}

.toast.toast-warning {
    border-left-color: #FF9800;
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    color: #ef6c00;
}

.toast.toast-info {
    border-left-color: #2196F3;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
}

/* Formulaires modernis√©s - harmonis√©s avec symlink_tool */
input[type="text"], input[type="search"], select {
    border: 2px solid #e0e0e0 !important;
    border-radius: 8px !important;
    padding: 12px 16px !important;
    transition: all 0.3s ease !important;
    font-size: 14px !important;
    background: white !important;
}

input[type="text"]:focus, input[type="search"]:focus, select:focus {
    outline: none !important;
    border-color: #2196F3 !important;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1) !important;
}

/* Responsive */
@media (max-width: 768px) {
    .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
    }
    
    .toast {
        max-width: none;
    }
}

/* Styles pour les fichiers et informations m√©dia - Material Design */
.file-item {
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: white;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.file-item:hover {
    border-color: #2196F3;
    box-shadow: 0 4px 20px rgba(33, 150, 243, 0.15);
    transform: translateY(-1px);
}

.file-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #e0e0e0;
}

.file-name {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%;
    color: #333;
    font-size: 15px;
}

.file-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

.btn-action {
    font-size: 1.3em;
    text-decoration: none;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: white;
    color: #666;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-action:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    border-color: #2196F3;
    color: #2196F3;
}

.media-info-container {
    max-height: 0;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
}

.media-details h6 {
    margin: 16px 0 12px 0;
    font-size: 16px;
    color: #333;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 8px;
}

.media-details ul {
    list-style: none;
    padding: 0;
    margin: 0 0 20px 0;
}

.media-details li {
    padding: 12px 16px;
    margin-bottom: 8px;
    border-radius: 8px;
    font-size: 14px;
    border-left: 4px solid #e0e0e0;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.media-details li:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.loading-info, .error-info {
    text-align: center;
    padding: 24px;
    font-style: italic;
    font-size: 16px;
    border-radius: 12px;
    margin: 16px;
}

.loading-info {
    color: #666;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.error-info {
    color: #c62828;
    background: linear-gradient(135deg, #ffebee 0%, #fde7e7 100%);
}

/* Styles pour la s√©lection en masse - Material Design */
.torrent-checkbox {
    transform: scale(1.3);
    margin: 0;
    cursor: pointer;
    accent-color: #2196F3;
    border-radius: 4px;
}

#selectAll {
    transform: scale(1.3);
    cursor: pointer;
    accent-color: #2196F3;
    border-radius: 4px;
}

#selectionActions {
    animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #FF9800;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 16px rgba(255, 152, 0, 0.2);
}

@keyframes slideDown {
    from { 
        opacity: 0; 
        transform: translateY(-10px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.875rem;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

/* Boutons avec Material Design - harmonis√© avec symlink_tool */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 500;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    cursor: pointer;
    border: none;
    padding: 12px 24px;
    font-size: 14px;
    line-height: 1.5;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    text-decoration: none;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 12px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-danger {
    background: linear-gradient(135deg, #f44336 0%, #D32F2F 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
}

.btn-danger:hover {
    background: linear-gradient(135deg, #D32F2F 0%, #C62828 100%);
    box-shadow: 0 8px 20px rgba(244, 67, 54, 0.4);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #495057 0%, #343a40 100%);
    box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
    color: white;
}

.btn-primary {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
    box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.btn-success:hover {
    background: linear-gradient(135deg, #388E3C 0%, #2E7D32 100%);
    box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
    color: white;
}
</style>

<script>
// Syst√®me de notifications toast - Material Design
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    
    // D√©finir les couleurs selon le type
    const colors = {
        success: { border: '#4CAF50', bg: 'linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%)', color: '#2e7d32' },
        error: { border: '#f44336', bg: 'linear-gradient(135deg, #ffebee 0%, #fde7e7 100%)', color: '#c62828' },
        warning: { border: '#FF9800', bg: 'linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)', color: '#ef6c00' },
        info: { border: '#2196F3', bg: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', color: '#1565c0' }
    };
    
    const style = colors[type] || colors.info;
    
    toast.innerHTML = message;
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 2000;
        padding: 16px 20px; border-radius: 12px; font-size: 14px; font-weight: 500;
        background: ${style.bg}; color: ${style.color};
        border-left: 4px solid ${style.border};
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        min-width: 300px; max-width: 350px;
        transform: translateX(380px); opacity: 0;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    `;
    
    document.body.appendChild(toast);
    
    // Animation d'entr√©e
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
        toast.style.opacity = '1';
    }, 100);
    
    // Animation de sortie
    setTimeout(() => {
        toast.style.transform = 'translateX(380px)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 400);
    }, 3000);
}

// Indicateur de chargement global
function showLoading(show = true, message = 'Chargement...') {
    let loader = document.getElementById('global-loader');
    if (show) {
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
                align-items: center; justify-content: center; color: white;
                font-size: 16px; font-weight: bold;
            `;
            loader.innerHTML = `<div style="text-align: center;"><div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>${message}</div>`;
            document.body.appendChild(loader);
        }
    } else if (loader) {
        loader.remove();
    }
}

function deleteTorrent(torrentId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer ce torrent de Real-Debrid ?')) {
        showLoading(true, 'Suppression en cours...');
        fetch(`/api/torrent/delete/${torrentId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    // Supprimer dynamiquement la ligne du tableau
                    const row = document.querySelector(`tr[data-torrent-id="${torrentId}"]`);
                    if (row) {
                        row.style.opacity = '0.5';
                        setTimeout(() => row.remove(), 300);
                    }
                    showToast('‚úÖ Torrent supprim√© avec succ√®s', 'success');
                } else {
                    showToast('‚ùå Erreur: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showToast('‚ùå Erreur r√©seau', 'error');
                console.error('Erreur:', error);
            });
    }
}

function showDetailsModal(torrentId) {
    // Stocker l'ID du torrent pour le bouton d'actualisation
    currentTorrentId = torrentId;
    
    const modal = document.getElementById('torrentModal');
    const loading = document.getElementById('modalLoading');
    const content = document.getElementById('modalContent');
    const error = document.getElementById('modalError');
    
    // R√©initialiser l'√©tat du modal
    modal.style.display = 'block';
    loading.style.display = 'block';
    content.style.display = 'none';
    error.style.display = 'none';
    
    // Message de rafra√Æchissement avec animation
    loading.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 2em; margin-bottom: 15px; animation: spin 2s linear infinite;">üîÑ</div>
            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #007bff;">
                R√©cup√©ration des donn√©es actualis√©es...
            </div>
            <div style="font-size: 0.9em; color: #6c757d;">
                Synchronisation avec Real-Debrid en cours
            </div>
            <div style="margin-top: 15px; height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden;">
                <div style="height: 100%; width: 30%; background: linear-gradient(90deg, #007bff, #28a745); animation: progress 3s ease-in-out infinite;"></div>
            </div>
        </div>
    `;
    
    // D√©sactiver temporairement le bouton de fermeture
    const closeBtn = modal.querySelector('.close');
    closeBtn.style.opacity = '0.5';
    closeBtn.style.pointerEvents = 'none';
    
    // Appel API avec timeout √©tendu pour le rafra√Æchissement
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 secondes
    
    fetch(`/api/torrent/${torrentId}`, {
        signal: controller.signal
    })
        .then(response => response.json())
        .then(data => {
            clearTimeout(timeoutId);
            loading.style.display = 'none';
            
            // R√©activer le bouton de fermeture
            closeBtn.style.opacity = '1';
            closeBtn.style.pointerEvents = 'auto';
            
            if (data.success) {
                const torrent = data.torrent;
                
                // Remplir les informations g√©n√©rales
                document.getElementById('modalTitle').textContent = `${torrent.status_emoji} ${torrent.name || torrent.filename}`;
                document.getElementById('modalId').textContent = torrent.id;
                document.getElementById('modalName').textContent = torrent.name || torrent.filename;
                document.getElementById('modalStatus').innerHTML = `<span style="padding: 2px 8px; border-radius: 12px; font-size: 0.8em; background: ${torrent.detail_status === 'downloaded' ? '#d4edda; color: #155724' : (torrent.detail_status && torrent.detail_status.includes('error')) ? '#f8d7da; color: #721c24' : '#fff3cd; color: #856404'};">${torrent.status_emoji} ${torrent.detail_status || torrent.status}</span>`;
                document.getElementById('modalSize').textContent = torrent.size_formatted;
                document.getElementById('modalFiles').textContent = torrent.files_count ? `${torrent.files_count} fichier(s)` : 'N/A';
                document.getElementById('modalHash').textContent = torrent.hash || 'N/A';
                
                // Indicateur de fra√Æcheur des donn√©es
                const refreshIndicator = document.getElementById('refreshIndicator') || createRefreshIndicator();
                if (data.refreshed) {
                    refreshIndicator.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #d4edda; color: #155724; border-radius: 4px; font-size: 0.85em; margin-bottom: 15px;">
                            <span style="font-size: 1.2em;">‚úÖ</span>
                            <span><strong>Donn√©es actualis√©es</strong> - Derni√®re mise √† jour: ${torrent.last_updated}</span>
                        </div>
                    `;
                    showToast('‚úÖ Donn√©es mises √† jour depuis Real-Debrid', 'success');
                } else {
                    refreshIndicator.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff3cd; color: #856404; border-radius: 4px; font-size: 0.85em; margin-bottom: 15px;">
                            <span style="font-size: 1.2em;">‚ö†Ô∏è</span>
                            <span><strong>Donn√©es en cache</strong> - ${data.warning || 'Impossible de r√©cup√©rer les donn√©es fra√Æches'}</span>
                        </div>
                    `;
                    showToast('‚ö†Ô∏è Affichage des donn√©es en cache', 'warning');
                }
                
                // Progression
                const progress = torrent.progress || 0;
                document.getElementById('modalProgress').textContent = `${progress}%`;
                document.getElementById('modalProgressBar').style.width = `${progress}%`;
                
                document.getElementById('modalHost').textContent = torrent.host || 'N/A';
                document.getElementById('modalAdded').textContent = torrent.added_on ? new Date(torrent.added_on).toLocaleDateString('fr-FR') : 'N/A';
                
                // Gestion des erreurs
                const errorContainer = document.getElementById('modalErrorContainer');
                if (torrent.error) {
                    errorContainer.style.display = 'block';
                    document.getElementById('modalError').textContent = torrent.error;
                } else {
                    errorContainer.style.display = 'none';
                }
                
                // Liens de t√©l√©chargement et streaming
                // R√©cup√©ration des liens de streaming avec la nouvelle API
                console.log('üîç R√©cup√©ration des liens de streaming pour torrent:', torrent.id);
                
                const linksContainer = document.getElementById('modalLinksContainer');
                const linksDiv = document.getElementById('modalLinks');
                
                // Afficher un indicateur de chargement pour les liens
                linksContainer.style.display = 'block';
                linksDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <div style="font-size: 1.5em; margin-bottom: 10px; animation: spin 2s linear infinite;">üîÑ</div>
                        <div>R√©cup√©ration des liens de streaming...</div>
                    </div>
                `;
                
                // Appel √† notre nouvelle API pour r√©cup√©rer les liens am√©lior√©s avec timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 secondes timeout (augment√©)
                
                console.log('üöÄ D√©marrage fetch vers:', `/api/torrent/stream/${torrent.id}`);
                
                fetch(`/api/torrent/stream/${torrent.id}`, {
                    signal: controller.signal
                })
                    .then(response => {
                        console.log('üì° R√©ponse re√ßue:', response.status, response.ok);
                        clearTimeout(timeoutId);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(streamData => {
                        console.log('üìä Donn√©es re√ßues:', streamData);
                        console.log('üîç V√©rification conditions:', {
                            success: streamData.success,
                            files: streamData.files,
                            filesLength: streamData.files ? streamData.files.length : 0
                        });
                        
                        if (streamData.success && streamData.files && streamData.files.length > 0) {
                            console.log('‚úÖ Liens r√©cup√©r√©s:', streamData.files);
                            
                            linksDiv.innerHTML = streamData.files.map((file, index) => {
                                const hasError = file.error;
                                const hasStreaming = file.streaming_link && !hasError;
                                const hasDownload = file.download_link;
                                const hasMediaInfo = file.file_id && !hasError;
                                
                                // D√©terminer le nom du fichier
                                let displayName = file.filename || `Fichier ${index + 1}`;
                                if (displayName.length > 60) {
                                    displayName = displayName.substring(0, 60) + '...';
                                }
                                
                                // Formatage de la taille
                                let sizeText = 'Taille inconnue';
                                if (file.size > 0) {
                                    const sizeGB = (file.size / (1024**3)).toFixed(2);
                                    sizeText = `${sizeGB} GB`;
                                }
                                
                                return `
                                    <div class="file-item" id="file-item-${index}" style="border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; transition: all 0.2s ease-in-out; ${hasError ? 'border-color: #dc3545; background: #fff5f5;' : ''}">
                                        <div class="file-header" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background-color: ${hasError ? '#ffeaea' : '#f8f9fa'}; border-radius: 6px 6px 0 0;">
                                            <div style="flex: 1; min-width: 0;">
                                                <div class="file-name" style="font-weight: 500; margin-bottom: 4px;" title="${file.filename || `Fichier ${index + 1}`}">
                                                    üìÅ ${displayName}
                                                </div>
                                                <div style="font-size: 0.8em; color: #6c757d;">
                                                    ${sizeText} ‚Ä¢ ${file.mime_type || 'Type inconnu'}
                                                </div>
                                                ${hasError ? `<div style="font-size: 0.8em; color: #dc3545; margin-top: 4px;">‚ö†Ô∏è ${file.error}</div>` : ''}
                                            </div>
                                            <div class="file-actions" style="display: flex; gap: 8px; align-items: center; margin-left: 15px;">
                                                <a href="${hasStreaming ? file.streaming_link : '#'}" target="_blank" class="btn-action stream" 
                                                   style="font-size: 1.2em; text-decoration: none; color: ${hasStreaming ? '#28a745' : '#6c757d'}; cursor: ${hasStreaming ? 'pointer' : 'not-allowed'}; padding: 6px 10px; border-radius: 4px; ${hasStreaming ? 'background: #d4edda; border: 1px solid #c3e6cb;' : 'background: #f8f9fa; border: 1px solid #dee2e6;'}" 
                                                   title="${hasStreaming ? 'Lire en streaming' : hasError ? 'Streaming indisponible (erreur)' : 'Streaming non disponible'}"
                                                   ${!hasStreaming ? 'onclick="return false;"' : ''}>
                                                    üé¨
                                                </a>
                                                <a href="${hasDownload ? file.download_link : '#'}" target="_blank" class="btn-action download" 
                                                   style="font-size: 1.2em; text-decoration: none; color: ${hasDownload ? '#007bff' : '#6c757d'}; cursor: ${hasDownload ? 'pointer' : 'not-allowed'}; padding: 6px 10px; border-radius: 4px; ${hasDownload ? 'background: #e3f2fd; border: 1px solid #bbdefb;' : 'background: #f8f9fa; border: 1px solid #dee2e6;'}" 
                                                   title="${hasDownload ? 'T√©l√©charger' : 'T√©l√©chargement non disponible'}"
                                                   ${!hasDownload ? 'onclick="return false;"' : ''}>
                                                    üíæ
                                                </a>
                                                <a href="${hasDownload ? file.download_link : '#'}" target="_blank" class="btn-action direct-download" 
                                                   style="font-size: 1.2em; text-decoration: none; color: ${hasDownload ? '#ff6b35' : '#6c757d'}; cursor: ${hasDownload ? 'pointer' : 'not-allowed'}; padding: 6px 10px; border-radius: 4px; ${hasDownload ? 'background: #fff3e0; border: 1px solid #ffcc80;' : 'background: #f8f9fa; border: 1px solid #dee2e6;'}" 
                                                   title="${hasDownload ? 'Acc√©der √† la page Real-Debrid' : 'Page Real-Debrid non disponible'}"
                                                   ${!hasDownload ? 'onclick="return false;"' : ''}>
                                                    üåê
                                                </a>
                                                ${hasMediaInfo ? `
                                                    <button onclick="fetchMediaInfo('${file.file_id}', ${index})" class="btn-action info" 
                                                            style="font-size: 1.2em; color: #6c757d; cursor: pointer; background: #fff; border: 1px solid #dee2e6; padding: 6px 10px; border-radius: 4px;" 
                                                            title="Informations m√©dia d√©taill√©es">
                                                        ‚ÑπÔ∏è
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="media-info-container" id="media-info-${index}" style="max-height: 0; overflow: hidden; transition: all 0.3s ease-in-out; background: #fff;"></div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            console.log('‚ùå Aucun fichier trouv√© dans la r√©ponse');
                            linksDiv.innerHTML = `
                                <div style="text-align: center; padding: 20px; color: #6c757d;">
                                    <div style="font-size: 2em; margin-bottom: 10px;">üì≠</div>
                                    <div>Aucun fichier disponible</div>
                                    <div style="font-size: 0.9em; margin-top: 5px;">
                                        ${streamData.error || 'Ce torrent n\'a peut-√™tre pas √©t√© t√©l√©charg√© ou les liens ont expir√©'}
                                    </div>
                                </div>
                            `;
                        }
                    })
                    .catch(streamError => {
                        clearTimeout(timeoutId);
                        console.error('Erreur r√©cup√©ration liens streaming:', streamError);
                        
                        let errorMessage = 'Erreur r√©seau';
                        if (streamError.name === 'AbortError') {
                            errorMessage = 'Timeout - La r√©cup√©ration des liens a pris trop de temps';
                        } else if (streamError.message) {
                            errorMessage = streamError.message;
                        }
                        
                        linksDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #dc3545;">
                                <div style="font-size: 2em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                                <div>Erreur lors de la r√©cup√©ration des liens</div>
                                <div style="font-size: 0.9em; margin-top: 5px;">
                                    ${errorMessage}
                                </div>
                                <button onclick="location.reload()" class="btn btn-sm btn-primary" style="margin-top: 10px;">
                                    üîÑ R√©essayer
                                </button>
                            </div>
                        `;
                    });
                
                content.style.display = 'block';
            } else {
                error.style.display = 'block';
                document.getElementById('modalErrorText').textContent = data.error || 'Erreur inconnue';
                showToast('‚ùå Erreur lors du chargement des d√©tails', 'error');
            }
        })
        .catch(err => {
            clearTimeout(timeoutId);
            loading.style.display = 'none';
            
            // R√©activer le bouton de fermeture
            closeBtn.style.opacity = '1';
            closeBtn.style.pointerEvents = 'auto';
            
            if (err.name === 'AbortError') {
                error.style.display = 'block';
                document.getElementById('modalErrorText').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">‚è±Ô∏è</div>
                        <div style="font-weight: bold; margin-bottom: 8px;">Timeout lors de la r√©cup√©ration</div>
                        <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">
                            La r√©cup√©ration des donn√©es depuis Real-Debrid a pris trop de temps
                        </div>
                        <button onclick="showDetailsModal('${torrentId}')" class="btn btn-primary btn-sm">
                            üîÑ R√©essayer
                        </button>
                    </div>
                `;
                showToast('‚è±Ô∏è Timeout - R√©essayez ou consultez les donn√©es en cache', 'warning');
            } else {
                error.style.display = 'block';
                document.getElementById('modalErrorText').textContent = 'Erreur r√©seau: ' + err.message;
                showToast('‚ùå Erreur r√©seau lors du chargement', 'error');
            }
            console.error('Erreur:', err);
        });
}

function createRefreshIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'refreshIndicator';
    const modalContent = document.getElementById('modalContent');
    modalContent.insertBefore(indicator, modalContent.firstChild);
    return indicator;
}

function closeModal() {
    document.getElementById('torrentModal').style.display = 'none';
}

// Variable globale pour stocker l'ID du torrent actuellement affich√©
let currentTorrentId = null;

function refreshTorrentData() {
    if (currentTorrentId) {
        showDetailsModal(currentTorrentId);
    }
}

function reinsertTorrent(torrentId) {
    if (confirm('√ätes-vous s√ªr de vouloir r√©ins√©rer ce torrent sur Real-Debrid ?')) {
        showLoading(true, 'R√©insertion en cours...');
        fetch(`/api/torrent/reinsert/${torrentId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    showToast('‚úÖ Torrent r√©ins√©r√© avec succ√®s !', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('‚ùå Erreur lors de la r√©insertion: ' + (data.error || 'Erreur inconnue'), 'error');
                }
            })
            .catch(err => {
                showLoading(false);
                showToast('‚ùå Erreur r√©seau: ' + err.message, 'error');
                console.error('Erreur:', err);
            });
    }
}

function copyTorrentName(torrentName) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(torrentName).then(function() {
            showToast('üìã Nom copi√© dans le presse-papier !', 'success');
        }).catch(function() {
            // Fallback si l'API Clipboard √©choue
            copyToClipboardFallback(torrentName);
        });
    } else {
        // Fallback pour les navigateurs qui ne supportent pas l'API Clipboard
        copyToClipboardFallback(torrentName);
    }
}

function copyToClipboardFallback(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.cssText = 'position: fixed; top: -9999px; left: -9999px;';
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast('üìã Nom copi√© dans le presse-papier !', 'success');
    } catch (err) {
        showToast('‚ùå Impossible de copier. S√©lectionnez le texte manuellement.', 'error');
        console.error('Erreur copie:', err);
    }
    
    document.body.removeChild(textArea);
}

// NOUVELLE FONCTION POUR R√âCUP√âRER LES INFOS M√âDIA D√âTAILL√âES
function fetchMediaInfo(fileId, index) {
    const container = document.getElementById(`media-info-${index}`);
    const fileItem = document.getElementById(`file-item-${index}`);
    
    // Si d√©j√† ouvert, on le ferme
    if (container.style.maxHeight !== '0px' && container.innerHTML !== '') {
        container.style.maxHeight = '0px';
        container.style.padding = '0';
        fileItem.style.borderColor = '#e0e0e0';
        fileItem.style.boxShadow = 'none';
        setTimeout(() => {
            container.innerHTML = '';
        }, 300);
        return;
    }

    // Afficher l'indicateur de chargement
    container.innerHTML = `
        <div class="loading-info" style="padding: 15px; text-align: center; color: #6c757d;">
            <div style="font-size: 1.5em; margin-bottom: 8px; animation: spin 2s linear infinite;">üîÑ</div>
            <div>R√©cup√©ration des m√©tadonn√©es m√©dia...</div>
        </div>
    `;
    container.style.maxHeight = '200px';
    container.style.padding = '0';
    fileItem.style.borderColor = '#007bff';
    fileItem.style.boxShadow = '0 0 5px rgba(0,123,255,0.3)';

    // Appel √† l'API pour r√©cup√©rer les informations m√©dia
    fetch(`/api/media_info/${fileId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = '<div class="media-details" style="padding: 15px;">';
                
                // Informations g√©n√©rales
                if (data.filename || data.type || data.duration) {
                    html += '<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">';
                    if (data.filename) {
                        html += `<div style="margin-bottom: 5px;"><strong>üìÑ Nom:</strong> ${data.filename}</div>`;
                    }
                    if (data.type) {
                        const typeEmoji = data.type === 'movie' ? 'üé¨' : data.type === 'show' ? 'üì∫' : data.type === 'audio' ? 'üéµ' : 'üìÑ';
                        html += `<div style="margin-bottom: 5px;"><strong>üé≠ Type:</strong> ${typeEmoji} ${data.type}</div>`;
                    }
                    if (data.duration) {
                        const hours = Math.floor(data.duration / 3600);
                        const minutes = Math.floor((data.duration % 3600) / 60);
                        html += `<div style="margin-bottom: 5px;"><strong>‚è±Ô∏è Dur√©e:</strong> ${hours}h${minutes.toString().padStart(2, '0')}m</div>`;
                    }
                    if (data.size) {
                        const sizeGB = (data.size / (1024**3)).toFixed(2);
                        html += `<div><strong>üíæ Taille:</strong> ${sizeGB} GB</div>`;
                    }
                    html += '</div>';
                }
                
                // Pistes vid√©o
                if (data.video && data.video.length > 0) {
                    html += '<h6 style="margin: 10px 0 8px 0; color: #343a40; display: flex; align-items: center; gap: 6px;"><span>üé•</span> Pistes Vid√©o</h6>';
                    html += '<ul style="list-style: none; padding: 0; margin: 0 0 15px 0;">';
                    data.video.forEach((track, idx) => {
                        html += `<li style="background: #e8f4f8; padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #007bff;">`;
                        html += `<strong>Piste ${idx + 1}:</strong> `;
                        if (track.width && track.height) {
                            html += `${track.width}x${track.height} `;
                        }
                        if (track.codec) {
                            html += `‚Ä¢ ${track.codec.toUpperCase()} `;
                        }
                        if (track.colorspace) {
                            html += `‚Ä¢ ${track.colorspace}`;
                        }
                        html += `</li>`;
                    });
                    html += '</ul>';
                }

                // Pistes audio
                if (data.audio && data.audio.length > 0) {
                    html += '<h6 style="margin: 10px 0 8px 0; color: #343a40; display: flex; align-items: center; gap: 6px;"><span>üîä</span> Pistes Audio</h6>';
                    html += '<ul style="list-style: none; padding: 0; margin: 0 0 15px 0;">';
                    data.audio.forEach((track, idx) => {
                        html += `<li style="background: #f0f8e8; padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #28a745;">`;
                        html += `<strong>${track.lang || `Piste ${idx + 1}`}:</strong> `;
                        if (track.codec) {
                            html += `${track.codec.toUpperCase()} `;
                        }
                        if (track.channels) {
                            html += `‚Ä¢ ${track.channels} ch `;
                        }
                        if (track.sampling) {
                            html += `‚Ä¢ ${track.sampling} Hz`;
                        }
                        html += `</li>`;
                    });
                    html += '</ul>';
                }

                // Sous-titres
                if (data.subtitles && data.subtitles.length > 0) {
                    html += '<h6 style="margin: 10px 0 8px 0; color: #343a40; display: flex; align-items: center; gap: 6px;"><span>üí¨</span> Sous-titres</h6>';
                    html += '<ul style="list-style: none; padding: 0; margin: 0 0 10px 0;">';
                    data.subtitles.forEach((sub, idx) => {
                        html += `<li style="background: #fff3e0; padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #ff9800;">`;
                        html += `<strong>${sub.lang || `Sous-titre ${idx + 1}`}:</strong> `;
                        if (sub.type) {
                            html += `${sub.type.toUpperCase()}`;
                        }
                        html += `</li>`;
                    });
                    html += '</ul>';
                }

                // Message si aucune information d√©taill√©e
                if (!data.video?.length && !data.audio?.length && !data.subtitles?.length) {
                    html += '<div style="text-align: center; padding: 20px; color: #6c757d;">';
                    html += '<div style="font-size: 1.5em; margin-bottom: 8px;">üìã</div>';
                    html += '<div>Aucune information de pistes d√©taill√©e disponible</div>';
                    html += '<div style="font-size: 0.85em; margin-top: 5px;">Ce fichier pourrait ne pas √™tre un m√©dia vid√©o/audio</div>';
                    html += '</div>';
                }

                html += '</div>';
                container.innerHTML = html;
                container.style.maxHeight = '400px';
            } else {
                container.innerHTML = `
                    <div class="error-info" style="padding: 15px; text-align: center; color: #dc3545;">
                        <div style="font-size: 1.5em; margin-bottom: 8px;">‚ùå</div>
                        <div><strong>Erreur:</strong> ${data.error}</div>
                        <div style="font-size: 0.85em; margin-top: 5px; color: #6c757d;">
                            Les informations m√©dia ne sont pas disponibles pour ce fichier
                        </div>
                    </div>
                `;
                container.style.maxHeight = '150px';
            }
        })
        .catch(err => {
            console.error('Erreur fetchMediaInfo:', err);
            container.innerHTML = `
                <div class="error-info" style="padding: 15px; text-align: center; color: #dc3545;">
                    <div style="font-size: 1.5em; margin-bottom: 8px;">üåê</div>
                    <div><strong>Erreur r√©seau</strong></div>
                    <div style="font-size: 0.85em; margin-top: 5px; color: #6c757d;">
                        Impossible de r√©cup√©rer les informations m√©dia
                    </div>
                </div>
            `;
            container.style.maxHeight = '150px';
        });
}

// Fermer le modal en cliquant √† l'ext√©rieur
window.onclick = function(event) {
    const modal = document.getElementById('torrentModal');
    if (event.target === modal) {
        closeModal();
    }
}

// Fermer le modal avec Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

// ==========================================
// FONCTIONS DE SUPPRESSION EN MASSE
// ==========================================

let selectedTorrents = new Set();
let currentBatchId = null;
let batchPollingInterval = null;

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Initialisation de la page torrents');
    
    // S'assurer que toutes les s√©lections sont vides au chargement
    selectedTorrents.clear();
    
    // D√©cocher toutes les cases au chargement
    const allCheckboxes = document.querySelectorAll('.torrent-checkbox, #selectAll');
    allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.indeterminate = false;
    });
    
    // Masquer les actions de s√©lection
    const actionsDiv = document.getElementById('selectionActions');
    if (actionsDiv) {
        actionsDiv.style.display = 'none';
    }
    
    console.log('‚úÖ S√©lections r√©initialis√©es');
});

function toggleSelectAll(checkbox) {
    const torrentCheckboxes = document.querySelectorAll('.torrent-checkbox');
    torrentCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedTorrents.add(cb.value);
        } else {
            selectedTorrents.delete(cb.value);
        }
    });
    updateSelectionActions();
}

function updateSelectionActions() {
    const checkboxes = document.querySelectorAll('.torrent-checkbox');
    selectedTorrents.clear();
    
    checkboxes.forEach(cb => {
        if (cb.checked) {
            selectedTorrents.add(cb.value);
        }
    });
    
    const actionsDiv = document.getElementById('selectionActions');
    const countSpan = document.getElementById('selectionCount');
    
    if (selectedTorrents.size > 0) {
        actionsDiv.style.display = 'block';
        countSpan.textContent = selectedTorrents.size;
    } else {
        actionsDiv.style.display = 'none';
    }
    
    // Mettre √† jour la checkbox "tout s√©lectionner"
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkedCount = document.querySelectorAll('.torrent-checkbox:checked').length;
    const totalCount = checkboxes.length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === totalCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

function clearSelection() {
    console.log('üßπ Nettoyage des s√©lections');
    
    // Vider le Set des torrents s√©lectionn√©s
    selectedTorrents.clear();
    
    // D√©cocher toutes les cases √† cocher
    const allCheckboxes = document.querySelectorAll('.torrent-checkbox');
    allCheckboxes.forEach(cb => {
        cb.checked = false;
    });
    
    // R√©initialiser la case "tout s√©lectionner"
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
    
    // Masquer les actions de s√©lection
    updateSelectionActions();
    
    console.log('‚úÖ S√©lections nettoy√©es');
}

function confirmBatchDeletion() {
    if (selectedTorrents.size === 0) {
        showToast('‚ùå Aucun torrent s√©lectionn√©', 'error');
        return;
    }
    
    const count = selectedTorrents.size;
    const torrentWord = count === 1 ? 'torrent' : 'torrents';
    const message = `√ätes-vous s√ªr de vouloir supprimer ${count} ${torrentWord} de Real-Debrid ?\n\nCette action est irr√©versible et peut prendre plusieurs minutes pour ${count > 10 ? 'de nombreux torrents' : 'quelques torrents'}.`;
    
    if (confirm(message)) {
        console.log(`üóëÔ∏è D√©marrage suppression de ${count} torrents:`, Array.from(selectedTorrents));
        startBatchDeletion();
    }
}

function startBatchDeletion() {
    const torrentIds = Array.from(selectedTorrents);
    
    // Afficher le modal de progression
    const modal = document.getElementById('batchProgressModal');
    if (!modal) {
        showToast('‚ùå Erreur: Modal de progression non trouv√©', 'error');
        return;
    }
    modal.style.display = 'block';
    
    // Initialiser les compteurs avec v√©rification d'existence
    const elements = {
        'batchTotal': torrentIds.length,
        'batchProgress': '0',
        'batchSuccess': '0',
        'batchFailed': '0'
    };
    
    for (const [id, value] of Object.entries(elements)) {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = value;
    }
    
    const progressBar = document.getElementById('batchProgressBar');
    if (progressBar) progressBar.style.width = '0%';
    
    const errors = document.getElementById('batchErrors');
    if (errors) errors.style.display = 'none';
    
    const closeBtn = document.getElementById('batchCloseBtn');
    if (closeBtn) closeBtn.disabled = true;
    
    const cancelBtn = document.getElementById('batchCancelBtn');
    if (cancelBtn) cancelBtn.style.display = 'inline-block';
    
    // Lancer la suppression
    fetch('/api/torrents/delete_batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            torrent_ids: torrentIds
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            currentBatchId = data.batch_id;
            showToast(`üöÄ Suppression de ${data.total} torrents d√©marr√©e`, 'info');
            
            // D√©marrer le polling du statut
            startBatchStatusPolling();
        } else {
            showToast(`‚ùå Erreur: ${data.error}`, 'error');
            closeBatchModal();
        }
    })
    .catch(error => {
        console.error('Erreur lors du d√©marrage:', error);
        showToast(`‚ùå Erreur r√©seau: ${error.message}`, 'error');
        closeBatchModal();
    });
}

function startBatchStatusPolling() {
    if (!currentBatchId) {
        console.error('‚ùå Pas de batch ID pour le polling');
        return;
    }
    
    console.log(`üîÑ D√©marrage polling pour batch: ${currentBatchId}`);
    
    batchPollingInterval = setInterval(() => {
        fetch(`/api/batch_status/${currentBatchId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateBatchProgress(data.batch);
                    
                    if (data.batch.status === 'completed') {
                        console.log('üéâ Batch termin√©, arr√™t du polling');
                        stopBatchStatusPolling();
                        onBatchCompleted(data.batch);
                    }
                } else {
                    console.error('‚ùå Erreur r√©cup√©ration statut batch:', data.error);
                    showToast(`‚ùå Erreur polling: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Erreur polling batch:', error);
                showToast(`‚ùå Erreur polling: ${error.message}`, 'error');
                
                // Arr√™ter le polling en cas d'erreur r√©p√©t√©e
                if (error.message.includes('404') || error.message.includes('500')) {
                    stopBatchStatusPolling();
                    showToast('‚ö†Ô∏è Arr√™t du suivi automatique (erreur serveur)', 'warning');
                }
            });
    }, 1000); // Polling chaque seconde
}

function updateBatchProgress(batch) {
    console.log('üîÑ Mise √† jour progression:', batch);
    
    // Mise √† jour s√©curis√©e des compteurs
    const updates = {
        'batchProgress': batch.processed,
        'batchSuccess': batch.success,
        'batchFailed': batch.failed
    };
    
    for (const [id, value] of Object.entries(updates)) {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = value;
    }
    
    // Mise √† jour de la barre de progression
    const percentage = Math.round((batch.processed / batch.total) * 100);
    const progressBar = document.getElementById('batchProgressBar');
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        progressBar.title = `${percentage}% (${batch.processed}/${batch.total})`;
    }
    
    // Affichage des erreurs si pr√©sentes
    if (batch.errors && batch.errors.length > 0) {
        const errorsDiv = document.getElementById('batchErrors');
        const errorsList = document.getElementById('batchErrorsList');
        
        if (errorsDiv && errorsList) {
            errorsList.innerHTML = batch.errors.map(error => 
                `<li><code>${error.torrent_id}</code>: ${error.error}</li>`
            ).join('');
            errorsDiv.style.display = 'block';
        }
    }
}

function refreshStatistics() {
    // Fonction pour rafra√Æchir les statistiques apr√®s suppression
    fetch('/api/refresh_stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('‚úÖ Statistiques rafra√Æchies');
                // Optionnel : mettre √† jour les statistiques affich√©es sur la page
                // sans recharger compl√®tement la page
            } else {
                console.warn('‚ö†Ô∏è Erreur lors du rafra√Æchissement des statistiques:', data.error);
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur r√©seau lors du rafra√Æchissement des statistiques:', error);
        });
}

function onBatchCompleted(batch) {
    console.log('‚úÖ Suppression termin√©e:', batch);
    
    const closeBtn = document.getElementById('batchCloseBtn');
    const cancelBtn = document.getElementById('batchCancelBtn');
    
    if (closeBtn) closeBtn.disabled = false;
    if (cancelBtn) cancelBtn.style.display = 'none';
    
    // Message de fin avec d√©tails
    const successRate = Math.round((batch.success / batch.total) * 100);
    const duration = Math.round(batch.duration || 0);
    
    let message = `‚úÖ Suppression termin√©e: ${batch.success}/${batch.total} succ√®s (${successRate}%)`;
    if (duration > 0) {
        message += ` en ${duration}s`;
    }
    
    const toastType = batch.failed > 0 ? 'warning' : 'success';
    showToast(message, toastType);
    
    // Afficher un r√©sum√© dans le modal si des erreurs
    if (batch.failed > 0) {
        console.warn(`‚ö†Ô∏è ${batch.failed} √©checs lors de la suppression`);
    }
    
    // Nettoyer imm√©diatement la s√©lection avant le rechargement
    clearSelection();
    
    // Rafra√Æchir les statistiques si des suppressions ont r√©ussi
    if (batch.success > 0) {
        refreshStatistics();
    }
    
    // R√©actualiser la page apr√®s un d√©lai pour voir les changements
    if (batch.success > 0) {
        setTimeout(() => {
            console.log('üîÑ Rechargement de la page...');
            // S'assurer que la s√©lection est vid√©e avant le rechargement
            selectedTorrents.clear();
            localStorage.removeItem('torrents_selection'); // Au cas o√π il y aurait un cache
            location.reload();
        }, 3000);
    }
}

function stopBatchStatusPolling() {
    if (batchPollingInterval) {
        clearInterval(batchPollingInterval);
        batchPollingInterval = null;
    }
}

function cancelBatch() {
    if (currentBatchId && batchPollingInterval) {
        stopBatchStatusPolling();
        showToast('‚ö†Ô∏è Arr√™t demand√© - Les suppressions en cours vont se terminer', 'warning');
        closeBatchModal();
    }
}

function closeBatchModal() {
    console.log('üîí Fermeture du modal de suppression');
    
    const modal = document.getElementById('batchProgressModal');
    if (modal) modal.style.display = 'none';
    
    stopBatchStatusPolling();
    currentBatchId = null;
    
    // Nettoyer compl√®tement la s√©lection
    clearSelection();
    
    // Nettoyer les √©l√©ments du modal pour la prochaine fois
    const elementsToReset = ['batchProgress', 'batchSuccess', 'batchFailed'];
    elementsToReset.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = '0';
    });
    
    const progressBar = document.getElementById('batchProgressBar');
    if (progressBar) progressBar.style.width = '0%';
    
    const errors = document.getElementById('batchErrors');
    if (errors) errors.style.display = 'none';
    
    console.log('‚úÖ Modal ferm√© et s√©lection nettoy√©e');
}
</script>
{% endblock %}
