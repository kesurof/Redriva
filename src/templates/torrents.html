{% extends "base.html" %}

{% block title %}Torrents - Redriva Web{% endblock %}

{% block content %}
<style>
/* Animations pour le modal de rafra√Æchissement */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes progress {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}

/* Style pour les indicateurs de fra√Æcheur */
.refresh-indicator {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Animation pour les boutons de retry */
.retry-button:hover {
    transform: scale(1.05);
    transition: transform 0.2s ease;
}
</style>

<!-- En-t√™te avec actions -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üìã Gestion des torrents</h2>
        <div style="display: flex; gap: 10px;">
            <a href="/sync/smart" class="btn btn-success">üß† Sync Intelligent</a>
        </div>
    </div>
    
    <!-- Filtres et recherche -->
    <div class="filters-container" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <form method="GET" action="/torrents" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <!-- Pr√©server les param√®tres actuels -->
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="dir" value="{{ sort_dir }}">
            
            <!-- Recherche -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <label for="search" style="font-weight: bold;">Recherche:</label>
                <input type="text" 
                       id="search" 
                       name="search" 
                       value="{{ search }}" 
                       placeholder="Nom du torrent..." 
                       style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
            </div>
            
            <!-- Filtre par statut -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <label for="status" style="font-weight: bold;">Statut:</label>
                <select id="status" name="status" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Tous les statuts</option>
                    {% for status_info in available_statuses %}
                    <option value="{{ status_info[0] }}" {% if status_filter == status_info[0] %}selected{% endif %}>
                        {{ status_info[0] }} ({{ status_info[1] }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="btn btn-secondary">üîç Filtrer</button>
            <a href="/torrents" class="btn btn-light">üóëÔ∏è Effacer</a>
        </form>
    </div>
</div>

<!-- Statistiques rapides -->
<div class="stats-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
        <a href="{{ url_for('torrents') }}" class="stat-item" style="text-align: center; text-decoration: none; color: inherit; transition: transform 0.2s;">
            <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">{{ total_count }}</div>
            <div style="font-size: 0.9em; color: #666;">Total</div>
        </a>
        {% for status_info in available_statuses %}
        <a href="{{ url_for('torrents', status=status_info[0]) }}" class="stat-item" style="text-align: center; text-decoration: none; color: inherit; transition: transform 0.2s;">
            <div style="font-size: 1.2em; font-weight: bold; color: {% if status_info[0] == 'downloaded' %}#28a745{% elif 'error' in status_info[0] %}#dc3545{% else %}#6c757d{% endif %};">
                {{ status_info[1] }}
            </div>
            <div style="font-size: 0.8em; color: #666;">{{ status_info[0] }}</div>
        </a>
        {% endfor %}
    </div>
</div>

<!-- Table des torrents -->
<div class="card">
    {% if torrents %}
    <div class="table-responsive">
        <table class="table table-striped table-hover" style="margin: 0;">
            <thead style="background: #f8f9fa; position: sticky; top: 0; z-index: 10;">
                <tr>
                    <th style="width: 5%;">
                        <a href="{{ url_for('torrents', sort='id', dir='asc' if sort_by == 'id' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            ID {% if sort_by == 'id' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 40%;">
                        <a href="{{ url_for('torrents', sort='filename', dir='asc' if sort_by == 'filename' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Nom {% if sort_by == 'filename' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 12%;">
                        <a href="{{ url_for('torrents', sort='status', dir='asc' if sort_by == 'status' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Statut {% if sort_by == 'status' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 10%;">
                        <a href="{{ url_for('torrents', sort='bytes', dir='asc' if sort_by == 'bytes' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Taille {% if sort_by == 'bytes' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 12%;">
                        <a href="{{ url_for('torrents', sort='added_on', dir='asc' if sort_by == 'added_on' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Date ajout {% if sort_by == 'added_on' %}{% if sort_dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 8%;">Progression</th>
                    <th style="width: 13%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for torrent in torrents %}
                <tr data-torrent-id="{{ torrent.id }}">
                    <td style="font-family: monospace; font-size: 0.9em;">{{ torrent.id }}</td>
                    <td>
                        <span onclick="copyTorrentName({{ torrent.display_name|tojson }})" title="Cliquer pour copier le nom" style="cursor: copy; text-decoration: none; color: inherit; display: inline-flex; align-items: center; gap: 5px;">
                            {{ torrent.display_name[:50] + ('...' if torrent.display_name|length > 50 else '') }} üìã
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-{{ 'success' if torrent.current_status == 'downloaded' else 'danger' if 'error' in torrent.current_status else 'warning' }}"
                              style="padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;
                                     background: {% if torrent.current_status == 'downloaded' %}#d4edda; color: #155724{% elif 'error' in torrent.current_status %}#f8d7da; color: #721c24{% else %}#fff3cd; color: #856404{% endif %};">
                            {{ torrent.current_status }}
                        </span>
                    </td>
                    <td style="text-align: right; font-family: monospace;">{{ torrent.size_formatted }}</td>
                    <td style="font-family: monospace; font-size: 0.9em;">{{ torrent.added_date }}</td>
                    <td>
                        {% if torrent.progress > 0 %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="min-width: 40px; font-weight: bold; font-size: 0.9em;">
                                {{ '{:.1f}%'.format(torrent.progress) }}
                            </span>
                            <div style="flex: 1; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #007bff, #28a745); border-radius: 4px; transition: width 0.3s ease; width: {{ torrent.progress }}%;"></div>
                            </div>
                        </div>
                        {% else %}
                        <span style="color: #6c757d; font-size: 0.8em;">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 3px; justify-content: center;">
                            <button onclick="showDetailsModal('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #007bff; background: transparent; color: #007bff; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;"
                                    title="Voir d√©tails"
                                    onmouseover="this.style.background='#007bff'; this.style.color='white';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#007bff';">
                                üîç
                            </button>
                            <button onclick="deleteTorrent('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #dc3545; background: transparent; color: #dc3545; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;"
                                    title="Supprimer"
                                    onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#dc3545';">
                                üóëÔ∏è
                            </button>
                            {% if torrent.current_status in ['error', 'virus', 'dead'] %}
                            <button onclick="reinsertTorrent('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #28a745; background: transparent; color: #28a745; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;"
                                    title="R√©ins√©rer"
                                    onmouseover="this.style.background='#28a745'; this.style.color='white';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#28a745';">
                                ‚ôªÔ∏è
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <div class="pagination-container" style="padding: 20px; border-top: 1px solid #dee2e6; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div class="pagination-info" style="color: #6c757d; font-size: 0.9em;">
            Affichage {{ pagination.start_item }}-{{ pagination.end_item }} sur {{ pagination.total }} torrents
        </div>
        
        <div class="pagination-nav" style="display: flex; gap: 5px; align-items: center;">
            {% if pagination.has_prev %}
            <a href="{{ url_for('torrents', page=1, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">‚ùÆ‚ùÆ</a>
            <a href="{{ url_for('torrents', page=pagination.prev_page, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">‚ùÆ</a>
            {% else %}
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">‚ùÆ‚ùÆ</span>
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">‚ùÆ</span>
            {% endif %}
            
            {% set start_page = [1, pagination.page - 2]|max %}
            {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
            
            {% if start_page > 1 %}
            <span style="margin: 0 5px;">...</span>
            {% endif %}
            
            {% for page_num in range(start_page, end_page + 1) %}
            <a href="{{ url_for('torrents', page=page_num, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" 
               class="btn btn-sm {% if page_num == pagination.page %}btn-primary{% else %}btn-outline-primary{% endif %}">
                {{ page_num }}
            </a>
            {% endfor %}
            
            {% if end_page < pagination.total_pages %}
            <span style="margin: 0 5px;">...</span>
            {% endif %}
            
            {% if pagination.has_next %}
            <a href="{{ url_for('torrents', page=pagination.next_page, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">‚ùØ</a>
            <a href="{{ url_for('torrents', page=pagination.total_pages, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">‚ùØ‚ùØ</a>
            {% else %}
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">‚ùØ</span>
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">‚ùØ‚ùØ</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- √âtat vide -->
    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #6c757d;">
        <div style="font-size: 4em; opacity: 0.3; margin-bottom: 20px;">üì≠</div>
        {% if search or status_filter %}
        <h3>Aucun r√©sultat trouv√©</h3>
        <p>Aucun torrent ne correspond aux crit√®res de recherche.</p>
        <a href="/torrents" class="btn btn-primary">Voir tous les torrents</a>
        {% else %}
        <h3>Aucun torrent</h3>
        <p>Commencez par synchroniser vos torrents depuis Real-Debrid.</p>
        <a href="/sync/torrents" class="btn btn-success">‚¨áÔ∏è Synchroniser</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Modal pour les d√©tails de torrent -->
<div id="torrentModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="modal-content" style="background: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 15px;">
            <h3 id="modalTitle">D√©tails du torrent</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="refreshTorrentData()" 
                        class="btn btn-sm btn-outline-primary retry-button" 
                        style="padding: 4px 8px; font-size: 0.8em; border: 1px solid #007bff; background: transparent; color: #007bff; border-radius: 4px; cursor: pointer;"
                        title="Actualiser les donn√©es depuis Real-Debrid"
                        onmouseover="this.style.background='#007bff'; this.style.color='white';"
                        onmouseout="this.style.background='transparent'; this.style.color='#007bff';">
                    üîÑ Actualiser
                </button>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
        </div>
        
        <div id="modalLoading" style="text-align: center; padding: 50px;">
            <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
            <div>Chargement des d√©tails...</div>
        </div>
        
        <div id="modalContent" style="display: none;">
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #495057;">üìã Informations g√©n√©rales</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                            <div style="margin-bottom: 8px;"><strong>ID:</strong> <span id="modalId" style="font-family: monospace;"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Nom:</strong> <span id="modalName"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Statut:</strong> <span id="modalStatus"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Taille:</strong> <span id="modalSize"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Fichiers:</strong> <span id="modalFiles"></span></div>
                            <div><strong>Hash:</strong> <span id="modalHash" style="font-family: monospace; font-size: 0.9em;"></span></div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #495057;">üìä Progression</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Progression:</span>
                                    <span id="modalProgress">0%</span>
                                </div>
                                <div style="background: #e9ecef; border-radius: 10px; height: 10px; width: 100%; overflow: hidden;">
                                    <div id="modalProgressBar" style="background: linear-gradient(90deg, #007bff, #28a745); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;"><strong>H√©bergeur:</strong> <span id="modalHost"></span></div>
                            <div style="margin-bottom: 8px;"><strong>Ajout√© le:</strong> <span id="modalAdded"></span></div>
                            <div id="modalErrorContainer" style="display: none; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px; margin-top: 10px;">
                                <strong>Erreur:</strong> <span id="modalError"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="modalLinksContainer" style="display: none;">
                    <h4 style="margin-bottom: 10px; color: #495057;">üîó Liens de t√©l√©chargement</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        <div id="modalLinks"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="modalError" style="display: none; text-align: center; padding: 50px; color: #dc3545;">
            <div style="font-size: 2em; margin-bottom: 10px;">‚ùå</div>
            <div id="modalErrorText">Erreur lors du chargement des d√©tails</div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<style>
.btn { text-decoration: none; }
.btn:hover { opacity: 0.8; }
.table-responsive { overflow-x: auto; }
.card { background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 20px; padding: 20px; }
.stat-item:hover { transform: scale(1.05); background: rgba(0,0,0,0.05); border-radius: 8px; }
.modal { animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal-content { animation: slideIn 0.3s ease; }
@keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
</style>

<script>
// Syst√®me de notifications toast
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.innerHTML = message;
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 2000;
        padding: 12px 20px; border-radius: 6px; color: white; font-size: 14px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease, slideOutRight 0.3s ease 2.7s forwards;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Indicateur de chargement global
function showLoading(show = true, message = 'Chargement...') {
    let loader = document.getElementById('global-loader');
    if (show) {
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
                align-items: center; justify-content: center; color: white;
                font-size: 16px; font-weight: bold;
            `;
            loader.innerHTML = `<div style="text-align: center;"><div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>${message}</div>`;
            document.body.appendChild(loader);
        }
    } else if (loader) {
        loader.remove();
    }
}

function deleteTorrent(torrentId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer ce torrent de Real-Debrid ?')) {
        showLoading(true, 'Suppression en cours...');
        fetch(`/api/torrent/delete/${torrentId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    // Supprimer dynamiquement la ligne du tableau
                    const row = document.querySelector(`tr[data-torrent-id="${torrentId}"]`);
                    if (row) {
                        row.style.opacity = '0.5';
                        setTimeout(() => row.remove(), 300);
                    }
                    showToast('‚úÖ Torrent supprim√© avec succ√®s', 'success');
                } else {
                    showToast('‚ùå Erreur: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showToast('‚ùå Erreur r√©seau', 'error');
                console.error('Erreur:', error);
            });
    }
}

function showDetailsModal(torrentId) {
    // Stocker l'ID du torrent pour le bouton d'actualisation
    currentTorrentId = torrentId;
    
    const modal = document.getElementById('torrentModal');
    const loading = document.getElementById('modalLoading');
    const content = document.getElementById('modalContent');
    const error = document.getElementById('modalError');
    
    // R√©initialiser l'√©tat du modal
    modal.style.display = 'block';
    loading.style.display = 'block';
    content.style.display = 'none';
    error.style.display = 'none';
    
    // Message de rafra√Æchissement avec animation
    loading.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 2em; margin-bottom: 15px; animation: spin 2s linear infinite;">üîÑ</div>
            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #007bff;">
                R√©cup√©ration des donn√©es actualis√©es...
            </div>
            <div style="font-size: 0.9em; color: #6c757d;">
                Synchronisation avec Real-Debrid en cours
            </div>
            <div style="margin-top: 15px; height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden;">
                <div style="height: 100%; width: 30%; background: linear-gradient(90deg, #007bff, #28a745); animation: progress 3s ease-in-out infinite;"></div>
            </div>
        </div>
    `;
    
    // D√©sactiver temporairement le bouton de fermeture
    const closeBtn = modal.querySelector('.close');
    closeBtn.style.opacity = '0.5';
    closeBtn.style.pointerEvents = 'none';
    
    // Appel API avec timeout √©tendu pour le rafra√Æchissement
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 secondes
    
    fetch(`/api/torrent/${torrentId}`, {
        signal: controller.signal
    })
        .then(response => response.json())
        .then(data => {
            clearTimeout(timeoutId);
            loading.style.display = 'none';
            
            // R√©activer le bouton de fermeture
            closeBtn.style.opacity = '1';
            closeBtn.style.pointerEvents = 'auto';
            
            if (data.success) {
                const torrent = data.torrent;
                
                // Remplir les informations g√©n√©rales
                document.getElementById('modalTitle').textContent = `${torrent.status_emoji} ${torrent.name || torrent.filename}`;
                document.getElementById('modalId').textContent = torrent.id;
                document.getElementById('modalName').textContent = torrent.name || torrent.filename;
                document.getElementById('modalStatus').innerHTML = `<span style="padding: 2px 8px; border-radius: 12px; font-size: 0.8em; background: ${torrent.detail_status === 'downloaded' ? '#d4edda; color: #155724' : (torrent.detail_status && torrent.detail_status.includes('error')) ? '#f8d7da; color: #721c24' : '#fff3cd; color: #856404'};">${torrent.status_emoji} ${torrent.detail_status || torrent.status}</span>`;
                document.getElementById('modalSize').textContent = torrent.size_formatted;
                document.getElementById('modalFiles').textContent = torrent.files_count ? `${torrent.files_count} fichier(s)` : 'N/A';
                document.getElementById('modalHash').textContent = torrent.hash || 'N/A';
                
                // Indicateur de fra√Æcheur des donn√©es
                const refreshIndicator = document.getElementById('refreshIndicator') || createRefreshIndicator();
                if (data.refreshed) {
                    refreshIndicator.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #d4edda; color: #155724; border-radius: 4px; font-size: 0.85em; margin-bottom: 15px;">
                            <span style="font-size: 1.2em;">‚úÖ</span>
                            <span><strong>Donn√©es actualis√©es</strong> - Derni√®re mise √† jour: ${torrent.last_updated}</span>
                        </div>
                    `;
                    showToast('‚úÖ Donn√©es mises √† jour depuis Real-Debrid', 'success');
                } else {
                    refreshIndicator.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff3cd; color: #856404; border-radius: 4px; font-size: 0.85em; margin-bottom: 15px;">
                            <span style="font-size: 1.2em;">‚ö†Ô∏è</span>
                            <span><strong>Donn√©es en cache</strong> - ${data.warning || 'Impossible de r√©cup√©rer les donn√©es fra√Æches'}</span>
                        </div>
                    `;
                    showToast('‚ö†Ô∏è Affichage des donn√©es en cache', 'warning');
                }
                
                // Progression
                const progress = torrent.progress || 0;
                document.getElementById('modalProgress').textContent = `${progress}%`;
                document.getElementById('modalProgressBar').style.width = `${progress}%`;
                
                document.getElementById('modalHost').textContent = torrent.host || 'N/A';
                document.getElementById('modalAdded').textContent = torrent.added_on ? new Date(torrent.added_on).toLocaleDateString('fr-FR') : 'N/A';
                
                // Gestion des erreurs
                const errorContainer = document.getElementById('modalErrorContainer');
                if (torrent.error) {
                    errorContainer.style.display = 'block';
                    document.getElementById('modalError').textContent = torrent.error;
                } else {
                    errorContainer.style.display = 'none';
                }
                
                // Liens de t√©l√©chargement
                const linksContainer = document.getElementById('modalLinksContainer');
                const linksDiv = document.getElementById('modalLinks');
                
                if (torrent.links && torrent.links.length > 0 && torrent.links[0] !== '') {
                    linksContainer.style.display = 'block';
                    linksDiv.innerHTML = torrent.links.map((link, index) => 
                        `<div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #dee2e6;">
                            <a href="${link}" target="_blank" style="color: #007bff; text-decoration: none;">
                                üìÅ Fichier ${index + 1} - T√©l√©charger
                            </a>
                        </div>`
                    ).join('');
                } else {
                    linksContainer.style.display = 'none';
                }
                
                content.style.display = 'block';
            } else {
                error.style.display = 'block';
                document.getElementById('modalErrorText').textContent = data.error || 'Erreur inconnue';
                showToast('‚ùå Erreur lors du chargement des d√©tails', 'error');
            }
        })
        .catch(err => {
            clearTimeout(timeoutId);
            loading.style.display = 'none';
            
            // R√©activer le bouton de fermeture
            closeBtn.style.opacity = '1';
            closeBtn.style.pointerEvents = 'auto';
            
            if (err.name === 'AbortError') {
                error.style.display = 'block';
                document.getElementById('modalErrorText').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">‚è±Ô∏è</div>
                        <div style="font-weight: bold; margin-bottom: 8px;">Timeout lors de la r√©cup√©ration</div>
                        <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">
                            La r√©cup√©ration des donn√©es depuis Real-Debrid a pris trop de temps
                        </div>
                        <button onclick="showDetailsModal('${torrentId}')" class="btn btn-primary btn-sm">
                            üîÑ R√©essayer
                        </button>
                    </div>
                `;
                showToast('‚è±Ô∏è Timeout - R√©essayez ou consultez les donn√©es en cache', 'warning');
            } else {
                error.style.display = 'block';
                document.getElementById('modalErrorText').textContent = 'Erreur r√©seau: ' + err.message;
                showToast('‚ùå Erreur r√©seau lors du chargement', 'error');
            }
            console.error('Erreur:', err);
        });
}

function createRefreshIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'refreshIndicator';
    const modalContent = document.getElementById('modalContent');
    modalContent.insertBefore(indicator, modalContent.firstChild);
    return indicator;
}
            loading.style.display = 'none';
            error.style.display = 'block';
            document.getElementById('modalErrorText').textContent = 'Erreur r√©seau: ' + err.message;
            showToast('‚ùå Erreur lors du chargement des d√©tails', 'error');
            console.error('Erreur:', err);
        });
}

function closeModal() {
    document.getElementById('torrentModal').style.display = 'none';
}

// Variable globale pour stocker l'ID du torrent actuellement affich√©
let currentTorrentId = null;

function refreshTorrentData() {
    if (currentTorrentId) {
        showDetailsModal(currentTorrentId);
    }
}

function reinsertTorrent(torrentId) {
    if (confirm('√ätes-vous s√ªr de vouloir r√©ins√©rer ce torrent sur Real-Debrid ?')) {
        showLoading(true, 'R√©insertion en cours...');
        fetch(`/api/torrent/reinsert/${torrentId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    showToast('‚úÖ Torrent r√©ins√©r√© avec succ√®s !', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('‚ùå Erreur lors de la r√©insertion: ' + (data.error || 'Erreur inconnue'), 'error');
                }
            })
            .catch(err => {
                showLoading(false);
                showToast('‚ùå Erreur r√©seau: ' + err.message, 'error');
                console.error('Erreur:', err);
            });
    }
}

function copyTorrentName(torrentName) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(torrentName).then(function() {
            showToast('üìã Nom copi√© dans le presse-papier !', 'success');
        }).catch(function() {
            // Fallback si l'API Clipboard √©choue
            copyToClipboardFallback(torrentName);
        });
    } else {
        // Fallback pour les navigateurs qui ne supportent pas l'API Clipboard
        copyToClipboardFallback(torrentName);
    }
}

function copyToClipboardFallback(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.cssText = 'position: fixed; top: -9999px; left: -9999px;';
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast('üìã Nom copi√© dans le presse-papier !', 'success');
    } catch (err) {
        showToast('‚ùå Impossible de copier. S√©lectionnez le texte manuellement.', 'error');
        console.error('Erreur copie:', err);
    }
    
    document.body.removeChild(textArea);
}

// Fermer le modal en cliquant √† l'ext√©rieur
window.onclick = function(event) {
    const modal = document.getElementById('torrentModal');
    if (event.target === modal) {
        closeModal();
    }
}

// Fermer le modal avec Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}
