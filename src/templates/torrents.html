{% extends "base.html" %}

{% block title %}Torrents - Redriva Web{% endblock %}

{% block content %}
<!-- Messages de notification -->
<div id="toast-container" class="toast-container"></div>

<style>
/* Animations pour le modal de rafraîchissement */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes progress {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}

/* Style pour les indicateurs de fraîcheur */
.refresh-indicator {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Animation pour les boutons de retry */
.retry-button:hover {
    transform: scale(1.05);
    transition: transform 0.2s ease;
}

/* STYLES POUR L'INTERFACE TORRENTS */
.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.toast {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 16px;
    margin-bottom: 10px;
    border-left: 4px solid;
    min-width: 300px;
    animation: slideIn 0.3s ease;
}

.toast.success { border-left-color: #28a745; }
.toast.error { border-left-color: #dc3545; }
.toast.info { border-left-color: #17a2b8; }
.toast.warning { border-left-color: #ffc107; }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* Styles pour les actions de synchronisation compactes */
.sync-actions-compact {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-sync-compact {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-sync-compact:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.btn-primary-compact {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
}

.btn-primary-compact:hover {
    background: linear-gradient(135deg, #0056b3, #004085);
}

.btn-success-compact {
    background: linear-gradient(135deg, #28a745, #1e7e34);
    color: white;
}

.btn-success-compact:hover {
    background: linear-gradient(135deg, #1e7e34, #155724);
}

.btn-info-compact {
    background: linear-gradient(135deg, #17a2b8, #138496);
    color: white;
}

.btn-info-compact:hover {
    background: linear-gradient(135deg, #138496, #117a8b);
}

.btn-warning-compact {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: #212529;
}

.btn-warning-compact:hover {
    background: linear-gradient(135deg, #e0a800, #d39e00);
}

.btn-danger-compact {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.btn-danger-compact:hover {
    background: linear-gradient(135deg, #c82333, #bd2130);
}

.btn-secondary-compact {
    background: linear-gradient(135deg, #6c757d, #5a6268);
    color: white;
}

.btn-secondary-compact:hover {
    background: linear-gradient(135deg, #5a6268, #545b62);
}

/* Responsive pour les actions de synchronisation */
@media (max-width: 768px) {
    .filters-container form {
        flex-direction: column;
        gap: 12px !important;
    }
    
    .filters-container form > div {
        width: 100%;
    }
    
    .btn-sync-compact {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    /* Indicateur de couverture en mobile */
    .coverage-indicator {
        justify-content: center !important;
        padding: 6px 10px !important;
    }
    
    .coverage-indicator span:last-child {
        display: none; /* Masquer le mot "détails" sur mobile */
    }
}
</style>

<!-- En-tête avec actions -->
<div class="card filters-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: #333; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                📋 Gestion des torrents
            </h2>
        </div>
    </div>
    
    <!-- Filtres, recherche et actions de synchronisation intégrés -->
    <div class="filters-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; margin-bottom: 0; border: 2px solid #e0e0e0;">
        <form method="GET" action="/torrents" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <!-- Préserver les paramètres actuels -->
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="dir" value="{{ sort_dir }}">
            
            <!-- Recherche -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <label for="search" style="font-weight: 600; color: #333; font-size: 14px;">Recherche:</label>
                <input type="text" 
                       id="search" 
                       name="search" 
                       value="{{ search }}" 
                       placeholder="Nom du torrent..." 
                       style="padding: 10px 14px; border: 2px solid #e0e0e0; border-radius: 6px; min-width: 200px; font-size: 14px; transition: all 0.3s ease; background: white;">
            </div>
            
            <!-- Boutons de filtrage et effacement -->
            <button type="submit" class="btn-sync-compact btn-primary-compact" style="padding: 10px 16px;">🔍 Filtrer</button>
            <a href="/torrents" class="btn-sync-compact btn-secondary-compact" style="padding: 10px 16px; text-decoration: none;">🗑️ Effacer</a>
            
            <!-- Séparateur visuel -->
            <div style="height: 30px; width: 1px; background: #ddd; margin: 0 5px;"></div>
            
            <!-- Actions de synchronisation intégrées -->
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <span style="font-weight: 600; color: #333; font-size: 13px; margin-right: 5px;">⚡ Sync:</span>
                
                <button type="button" onclick="executeSyncAction('/sync/smart', '🧠 Synchronisation intelligente')" class="btn-sync-compact btn-primary-compact" style="padding: 8px 12px;" title="Mode recommandé - Analyse et traite selon les priorités">
                    🧠 Smart
                </button>
                
                <button type="button" onclick="executeSyncAction('/sync/fast', '🚀 Synchronisation complète')" class="btn-sync-compact btn-success-compact" style="padding: 8px 12px;" title="Première installation ou resync complet">
                    🚀 Complet
                </button>
                
                <button type="button" onclick="executeSyncAction('/sync/torrents', '📋 Vue d\'ensemble')" class="btn-sync-compact btn-info-compact" style="padding: 8px 12px;" title="Mise à jour rapide de la liste des torrents">
                    📋 Vue
                </button>
                
                <button type="button" onclick="refreshStatistics()" class="btn-sync-compact btn-warning-compact" style="padding: 8px 12px;" title="Corrige les statistiques après suppressions">
                    📊 Stats
                </button>
                
                <button type="button" onclick="executeSyncAction('/api/health/check_all', '🔍 Vérifier santé des fichiers')" class="btn-sync-compact btn-info-compact" style="padding: 8px 12px;" title="Teste tous les liens pour détecter les indisponibles">
                    🔍 Santé
                </button>
                
                <button type="button" onclick="executeSyncAction('/api/health/cleanup', '🧹 Nettoyer fichiers morts')" class="btn-sync-compact btn-danger-compact" style="padding: 8px 12px;" title="Supprime les torrents avec liens morts + notifie Sonarr/Radarr">
                    🧹 Nettoyer
                </button>
            </div>
            
            <!-- Séparateur visuel -->
            <div style="height: 30px; width: 1px; background: #ddd; margin: 0 5px;"></div>
            
            <!-- Indicateur de couverture des détails -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-weight: 600; color: #333; font-size: 13px;">📊 Couverture:</span>
                <div class="coverage-indicator" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px solid #2196f3; border-radius: 6px; box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);">
                    <div class="coverage-circle" style="position: relative; width: 24px; height: 24px;">
                        <svg width="24" height="24" style="transform: rotate(-90deg);">
                            <circle cx="12" cy="12" r="10" fill="none" stroke="#e0e0e0" stroke-width="2"></circle>
                            <circle id="coverageProgress" cx="12" cy="12" r="10" fill="none" stroke="#2196f3" stroke-width="2" 
                                    stroke-dasharray="62.83" stroke-dashoffset="62.83" 
                                    style="transition: stroke-dashoffset 0.5s ease;">
                            </circle>
                        </svg>
                    </div>
                    <span id="coverageText" style="font-weight: 600; color: #1565c0; font-size: 14px; min-width: 35px;">0%</span>
                    <span style="font-size: 12px; color: #666;">détails</span>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Statistiques rapides -->
<div class="card stats-card">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
        <a href="{{ url_for('torrents') }}" class="stat-item" style="text-align: center; text-decoration: none; color: inherit; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 20px; border-radius: 12px; background: white; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border-left: 4px solid #3498db;">
            <div style="font-size: 2em; font-weight: 700; color: #3498db; margin-bottom: 8px;">{{ total_count }}</div>
            <div style="font-size: 14px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total</div>
        </a>
        {% for status_info in available_statuses %}
        <a href="{{ url_for('torrents', status=status_info[0]) }}" class="stat-item" style="text-align: center; text-decoration: none; color: inherit; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 20px; border-radius: 12px; background: white; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border-left: 4px solid {% if status_info[0] == 'downloaded' %}#4CAF50{% elif status_info[0] == 'incomplete' %}#ff9800{% elif 'error' in status_info[0] %}#f44336{% else %}#9e9e9e{% endif %};">
            <div style="font-size: 1.8em; font-weight: 700; color: {% if status_info[0] == 'downloaded' %}#4CAF50{% elif status_info[0] == 'incomplete' %}#ff9800{% elif 'error' in status_info[0] %}#f44336{% else %}#9e9e9e{% endif %}; margin-bottom: 8px;">
                {{ status_info[1] }}
            </div>
            <div style="font-size: 13px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                {% if status_info[0] == 'incomplete' %}
                    ⚠️ Détails manquants
                {% else %}
                    {{ status_info[0] }}
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
</div>

<!-- Actions de sélection -->
<div id="selectionActions" style="display: none; margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <strong id="selectionCount">0</strong> torrents sélectionnés
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="clearSelection()" class="btn btn-secondary btn-sm">Désélectionner</button>
            <button onclick="confirmBatchDeletion()" class="btn btn-danger">🗑️ Supprimer la sélection</button>
        </div>
    </div>
</div>

<!-- Table des torrents -->
<div class="card torrents-card">
    {% if torrents %}
    <div class="table-responsive">
        <table class="table table-striped table-hover" style="margin: 0; border-radius: 12px; overflow: hidden;">
            <thead style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); position: sticky; top: 0; z-index: 10;">
                <tr style="border: none;">
                    <th style="width: 3%; padding: 16px; font-weight: 600; color: #333; border: none;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" title="Sélectionner tout">
                    </th>
                    <th style="width: 5%;">
                        <a href="{{ url_for('torrents', sort='id', dir='asc' if sort_by == 'id' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            ID {% if sort_by == 'id' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 40%;">
                        <a href="{{ url_for('torrents', sort='filename', dir='asc' if sort_by == 'filename' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Nom {% if sort_by == 'filename' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 12%;">
                        <a href="{{ url_for('torrents', sort='status', dir='asc' if sort_by == 'status' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Statut {% if sort_by == 'status' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 10%;">
                        <a href="{{ url_for('torrents', sort='bytes', dir='asc' if sort_by == 'bytes' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Taille {% if sort_by == 'bytes' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 12%;">
                        <a href="{{ url_for('torrents', sort='added_on', dir='asc' if sort_by == 'added_on' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">
                            Date ajout {% if sort_by == 'added_on' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                    </th>
                    <th style="width: 8%;">Progression</th>
                    <th style="width: 13%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for torrent in torrents %}
                <tr data-torrent-id="{{ torrent.id }}">
                    <td>
                        <input type="checkbox" class="torrent-checkbox" value="{{ torrent.id }}" onchange="updateSelectionActions()">
                    </td>
                    <td style="font-family: monospace; font-size: 0.9em;">{{ torrent.id }}</td>
                    <td>
                        <span onclick="copyTorrentName({{ torrent.display_name|tojson }})" title="Cliquer pour copier le nom" style="cursor: copy; text-decoration: none; color: inherit; display: inline-flex; align-items: center; gap: 5px;">
                            {{ torrent.display_name[:50] + ('...' if torrent.display_name|length > 50 else '') }} 📋
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-{{ 'success' if torrent.current_status == 'downloaded' else 'danger' if 'error' in torrent.current_status else 'warning' }}"
                              style="padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;
                                     background: {% if torrent.current_status == 'downloaded' %}#d4edda; color: #155724{% elif 'error' in torrent.current_status %}#f8d7da; color: #721c24{% else %}#fff3cd; color: #856404{% endif %};">
                            {{ torrent.current_status }}
                        </span>
                    </td>
                    <td style="text-align: right; font-family: monospace;">{{ torrent.size_formatted }}</td>
                    <td style="font-family: monospace; font-size: 0.9em;">{{ torrent.added_date }}</td>
                    <td>
                        {% if torrent.progress > 0 %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="min-width: 40px; font-weight: bold; font-size: 0.9em;">
                                {{ '{:.1f}%'.format(torrent.progress) }}
                            </span>
                            <div style="flex: 1; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #007bff, #28a745); border-radius: 4px; transition: width 0.3s ease; width: {{ torrent.progress }}%;"></div>
                            </div>
                        </div>
                        {% else %}
                        <span style="color: #6c757d; font-size: 0.8em;">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 3px; justify-content: center;">
                            <button onclick="showDetailsModal('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #007bff; background: transparent; color: #007bff; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;"
                                    title="Voir détails"
                                    onmouseover="this.style.background='#007bff'; this.style.color='white';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#007bff';">
                                DL
                            </button>
                            <button onclick="updateTorrentDetails('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #ffc107; background: transparent; color: #ffc107; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;"
                                    title="Mettre à jour les détails"
                                    onmouseover="this.style.background='#ffc107'; this.style.color='black';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#ffc107';">
                                UPD
                            </button>
                            <button onclick="deleteTorrent('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #dc3545; background: transparent; color: #dc3545; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;"
                                    title="Supprimer"
                                    onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#dc3545';">
                                🗑️
                            </button>
                            {% if torrent.current_status in ['error', 'virus', 'dead'] %}
                            <button onclick="reinsertTorrent('{{ torrent.id }}')" 
                                    style="width: 32px; height: 32px; padding: 0; border: 1px solid #28a745; background: transparent; color: #28a745; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;"
                                    title="Réinsérer"
                                    onmouseover="this.style.background='#28a745'; this.style.color='white';"
                                    onmouseout="this.style.background='transparent'; this.style.color='#28a745';">
                                ♻️
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <div class="pagination-container" style="padding: 20px; border-top: 1px solid #dee2e6; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div class="pagination-info" style="color: #6c757d; font-size: 0.9em;">
            Affichage {{ pagination.start_item }}-{{ pagination.end_item }} sur {{ pagination.total }} torrents
        </div>
        
        <div class="pagination-nav" style="display: flex; gap: 5px; align-items: center;">
            {% if pagination.has_prev %}
            <a href="{{ url_for('torrents', page=1, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">❮❮</a>
            <a href="{{ url_for('torrents', page=pagination.prev_page, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">❮</a>
            {% else %}
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">❮❮</span>
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">❮</span>
            {% endif %}
            
            {% set start_page = [1, pagination.page - 2]|max %}
            {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
            
            {% if start_page > 1 %}
            <span style="margin: 0 5px;">...</span>
            {% endif %}
            
            {% for page_num in range(start_page, end_page + 1) %}
            <a href="{{ url_for('torrents', page=page_num, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" 
               class="btn btn-sm {% if page_num == pagination.page %}btn-primary{% else %}btn-outline-primary{% endif %}">
                {{ page_num }}
            </a>
            {% endfor %}
            
            {% if end_page < pagination.total_pages %}
            <span style="margin: 0 5px;">...</span>
            {% endif %}
            
            {% if pagination.has_next %}
            <a href="{{ url_for('torrents', page=pagination.next_page, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">❯</a>
            <a href="{{ url_for('torrents', page=pagination.total_pages, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-sm btn-outline-primary">❯❯</a>
            {% else %}
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">❯</span>
            <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5;">❯❯</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- État vide -->
    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #6c757d;">
        <div style="font-size: 4em; opacity: 0.3; margin-bottom: 20px;">📭</div>
        {% if search or status_filter %}
        <h3>Aucun résultat trouvé</h3>
        <p>Aucun torrent ne correspond aux critères de recherche.</p>
        <a href="/torrents" class="btn btn-primary">Voir tous les torrents</a>
        {% else %}
        <h3>Aucun torrent</h3>
        <p>Commencez par synchroniser vos torrents depuis Real-Debrid.</p>
        <a href="/sync/torrents" class="btn btn-success">⬇️ Synchroniser</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Modal pour les détails de torrent optimisée -->
<div id="torrentModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="modal-content responsive-modal" style="
        background: white; 
        margin: 1% auto; 
        padding: 16px; 
        border-radius: 12px; 
        width: 95%; 
        max-width: 900px; 
        max-height: 98vh; 
        overflow-y: auto;
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        border: 1px solid rgba(220, 226, 231, 0.5);
    ">
        <!-- En-tête compact -->
        <div class="modal-header" style="
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
            border-bottom: 1px solid #dee2e6; 
            padding-bottom: 12px;
        ">
            <h3 id="modalTitle" style="
                margin: 0; 
                font-size: 1.3em; 
                color: #2c3e50; 
                font-weight: 600;
                flex: 1;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            ">Détails du torrent</h3>
            <button class="close" onclick="closeModal()" style="
                background: none; 
                border: none; 
                font-size: 24px; 
                cursor: pointer; 
                color: #6c757d;
                padding: 5px;
                border-radius: 50%;
                transition: all 0.2s ease;
                flex-shrink: 0;
            " onmouseover="this.style.background='#f8f9fa'; this.style.color='#dc3545';" onmouseout="this.style.background='none'; this.style.color='#6c757d';">&times;</button>
        </div>
        
        <div id="modalLoading" style="text-align: center; padding: 50px;">
            <div style="font-size: 2em; margin-bottom: 10px;">⏳</div>
            <div>Chargement des détails...</div>
        </div>
        
        <div id="modalContent" style="display: none;">
            <!-- Informations principales en grid responsive Material Design -->
            <div class="detail-grid">
                <!-- Informations générales -->
                <div class="card info-card">
                    <h3 class="card-title">ℹ️ Informations générales</h3>
                    <div class="info-table">
                        <div class="info-row">
                            <span class="info-label">ID:</span>
                            <span class="info-value" id="modalId"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Nom:</span>
                            <span class="info-value" id="modalName"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Hash:</span>
                            <span class="info-value hash-value" id="modalHash">N/A</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Taille:</span>
                            <span class="info-value" id="modalSize">N/A</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Fichiers:</span>
                            <span class="info-value" id="modalFiles">N/A</span>
                        </div>
                    </div>
                </div>
                
                <!-- État et statut avec bouton intégré -->
                <div class="card status-card">
                    <h3 class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>📊 État et statut</span>
                        <button onclick="refreshTorrentData()" 
                                class="refresh-icon-btn" 
                                style="
                                    background: none; 
                                    border: 1px solid #007bff; 
                                    color: #007bff; 
                                    border-radius: 50%; 
                                    width: 28px; 
                                    height: 28px; 
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.2s ease;
                                    font-size: 12px;
                                    flex-shrink: 0;
                                "
                                title="Actualiser les données"
                                onmouseover="this.style.background='#007bff'; this.style.color='white'; this.style.transform='scale(1.1)';"
                                onmouseout="this.style.background='none'; this.style.color='#007bff'; this.style.transform='scale(1)';">
                            🔄
                        </button>
                    </h3>
                    <div class="info-table">
                        <div class="info-row">
                            <span class="info-label">Statut:</span>
                            <span class="info-value" id="modalStatus">N/A</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Progression:</span>
                            <div class="info-value">
                                <div class="progress-info">
                                    <span class="progress-text" id="modalProgress">0%</span>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" id="modalProgressBar" style="width: 0%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Hébergeur:</span>
                            <span class="info-value" id="modalHost">N/A</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ajouté le:</span>
                            <span class="info-value" id="modalAdded">N/A</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historique des erreurs -->
            <div class="card error-card" id="modalErrorContainer" style="display: none;">
                <h3 class="card-title">⚠️ Détails des erreurs</h3>
                <div class="error-container">
                    <pre class="error-details" id="modalError"></pre>
                </div>
            </div>

            <!-- Liens de téléchargement optimisés -->
            <div class="card files-card" id="modalLinksContainer" style="display: none;">
                <h3 class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <span>🔗 Fichiers disponibles</span>
                </h3>
                
                <div class="files-container-wrapper">
                    <div class="files-container" id="modalLinks" style="
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        max-height: 400px;
                        overflow-y: auto;
                    ">
                        <!-- Contenu généré dynamiquement -->
                    </div>
                    
                    <!-- Pagination optimisée -->
                    <div class="files-pagination" id="filesPagination" style="
                        display: none;
                        justify-content: space-between;
                        align-items: center;
                        gap: 8px;
                        margin-top: 10px;
                        padding-top: 10px;
                        border-top: 1px solid #dee2e6;
                        flex-wrap: wrap;
                    ">
                        <button onclick="previousFilesPage()" id="prevPageBtn" 
                                style="
                                    background: none; 
                                    border: 1px solid #007bff; 
                                    color: #007bff; 
                                    border-radius: 4px; 
                                    padding: 4px 8px; 
                                    cursor: pointer;
                                    font-size: 11px;
                                    transition: all 0.2s ease;
                                    min-width: 70px;
                                "
                                onmouseover="this.style.background='#007bff'; this.style.color='white';"
                                onmouseout="this.style.background='none'; this.style.color='#007bff';">
                            ← Préc.
                        </button>
                        <span id="pageInfo" style="font-size: 11px; color: #6c757d; text-align: center; flex: 1;">Page 1 sur 1</span>
                        <button onclick="nextFilesPage()" id="nextPageBtn" 
                                style="
                                    background: none; 
                                    border: 1px solid #007bff; 
                                    color: #007bff; 
                                    border-radius: 4px; 
                                    padding: 4px 8px; 
                                    cursor: pointer;
                                    font-size: 11px;
                                    transition: all 0.2s ease;
                                    min-width: 70px;
                                "
                                onmouseover="this.style.background='#007bff'; this.style.color='white';"
                                onmouseout="this.style.background='none'; this.style.color='#007bff';">
                            Suiv. →
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="modalError" style="display: none; text-align: center; padding: 50px; color: #dc3545;">
            <div style="font-size: 2em; margin-bottom: 10px;">❌</div>
            <div id="modalErrorText">Erreur lors du chargement des détails</div>
        </div>
    </div>
</div>

<!-- Modal de progression pour suppression en masse -->
<div id="batchProgressModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 15px;">
            <h3>🗑️ Suppression en cours</h3>
        </div>
        <div class="modal-body">
            <div id="batchProgressInfo" style="margin-bottom: 20px;">
                <div>Progression: <span id="batchProgress">0</span>/<span id="batchTotal">0</span></div>
                <div style="margin: 10px 0;">
                    <div style="background: #e9ecef; border-radius: 10px; height: 10px; overflow: hidden;">
                        <div id="batchProgressBar" style="background: linear-gradient(90deg, #dc3545, #28a745); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                <div style="font-size: 0.9em; color: #6c757d;">
                    ✅ <span id="batchSuccess">0</span> succès • 
                    ❌ <span id="batchFailed">0</span> échecs
                </div>
            </div>
            
            <div id="batchErrors" style="display: none; max-height: 200px; overflow-y: auto; background: #f8d7da; padding: 10px; border-radius: 4px;">
                <h6>Erreurs rencontrées :</h6>
                <ul id="batchErrorsList" style="margin: 0; padding-left: 20px;"></ul>
            </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            <button id="batchCloseBtn" onclick="closeBatchModal()" class="btn btn-secondary" disabled>Fermer</button>
            <button id="batchCancelBtn" onclick="cancelBatch()" class="btn btn-danger">Annuler</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<style>
/* Material Design Cards - Style harmonisé avec symlink_tool */
.card { 
    background: white; 
    border: none;
    border-radius: 12px; 
    margin-bottom: 20px; 
    padding: 24px; 
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border-left: 4px solid #3498db;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
}

/* Cards avec couleurs d'accent spécifiques */
.card.filters-card {
    border-left-color: #2196F3;
}

.card.stats-card {
    border-left-color: #4CAF50;
}

.card.torrents-card {
    border-left-color: #FF9800;
}

.table-responsive { 
    overflow-x: auto; 
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
}

/* Tables modernisées */
.table {
    border-collapse: separate;
    border-spacing: 0;
}

.table th {
    font-weight: 600;
    color: #333;
    border: none;
    padding: 16px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table td {
    border: none;
    padding: 16px;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.3s ease;
}

.table tbody tr:hover {
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.05) 0%, rgba(33, 150, 243, 0.02) 100%);
    transform: scale(1.001);
}

.table tbody tr:hover td {
    border-bottom-color: #2196F3;
}

/* Statistiques modernisées */
.stat-item:hover { 
    transform: scale(1.05) translateY(-2px); 
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(33, 150, 243, 0.05) 100%); 
    border-radius: 8px; 
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
}

@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes progress { 0% { transform: translateX(-100%); } 50% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

/* Styles pour les toasts - Material Design harmonisé */
.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column-reverse;
    gap: 12px;
}

.toast {
    background: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    border-left: 4px solid #e0e0e0;
    min-width: 300px;
    max-width: 350px;
    transform: translateX(380px);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #333;
    font-weight: 500;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.toast-success {
    border-left-color: #4CAF50;
    background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
    color: #2e7d32;
}

.toast.toast-error {
    border-left-color: #f44336;
    background: linear-gradient(135deg, #ffebee 0%, #fde7e7 100%);
    color: #c62828;
}

.toast.toast-warning {
    border-left-color: #FF9800;
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    color: #ef6c00;
}

.toast.toast-info {
    border-left-color: #2196F3;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
}

/* Formulaires modernisés - harmonisés avec symlink_tool */
input[type="text"], input[type="search"], select {
    border: 2px solid #e0e0e0 !important;
    border-radius: 8px !important;
    padding: 12px 16px !important;
    transition: all 0.3s ease !important;
    font-size: 14px !important;
    background: white !important;
}

input[type="text"]:focus, input[type="search"]:focus, select:focus {
    outline: none !important;
    border-color: #2196F3 !important;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1) !important;
}

/* Responsive */
@media (max-width: 768px) {
    .toast-container {
        bottom: 10px;
        right: 10px;
        left: 10px;
    }
    
    .toast {
        max-width: none;
    }
}

/* STYLES POUR LA MODALE AVEC MATERIAL DESIGN */
/* Grid responsive pour les informations */
.detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

/* Tables d'informations modernisées */
.info-table {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    color: #555;
    min-width: 120px;
    font-size: 14px;
}

.info-value {
    flex: 1;
    text-align: right;
    color: #333;
    word-break: break-word;
    font-size: 14px;
}

.hash-value {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
}

/* Status badges modernisés */
.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.status-success {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    color: #2e7d32;
    border: 1px solid #4caf50;
}

.status-warning {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    color: #ef6c00;
    border: 1px solid #ff9800;
}

.status-danger {
    background: linear-gradient(135deg, #ffebee 0%, #fde7e7 100%);
    color: #c62828;
    border: 1px solid #f44336;
}

.status-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
    border: 1px solid #2196f3;
}

.status-secondary {
    background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%);
    color: #616161;
    border: 1px solid #9e9e9e;
}

/* Barre de progression modernisée */
.progress-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
}

.progress-text {
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.progress-bar-container {
    background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
    border-radius: 12px;
    height: 12px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.progress-bar {
    background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
    height: 100%;
    border-radius: 12px;
    transition: width 0.3s ease;
    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
}

/* Fichiers modernisés */
.files-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 400px;
    overflow-y: auto;
}

.file-item-card {
    background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.file-item-card:hover {
    border-color: #9c27b0;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(156, 39, 176, 0.15);
}

.file-header {
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
    word-break: break-word;
}

.file-size {
    color: #666;
    font-size: 13px;
}

.file-actions {
    flex-shrink: 0;
    display: flex;
    gap: 8px;
}

.file-action-btn {
    padding: 8px 16px;
    font-size: 13px;
    border-radius: 6px;
    font-weight: 500;
}

.file-unavailable {
    color: #9e9e9e;
    font-style: italic;
    font-size: 13px;
    padding: 8px 16px;
    background: #f5f5f5;
    border-radius: 6px;
}

/* Container d'erreurs */
.error-container {
    background: linear-gradient(135deg, #ffebee 0%, #fde7e7 100%);
    border: 2px solid #f44336;
    border-radius: 12px;
    padding: 20px;
}

.error-details {
    margin: 0;
    white-space: pre-wrap;
    font-size: 13px;
    color: #c62828;
    font-family: 'Courier New', monospace;
    line-height: 1.5;
}

/* Responsive pour la modale */
@media (max-width: 768px) {
    .detail-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .info-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
    }
    
    .info-label {
        min-width: auto;
        font-weight: 700;
    }
    
    .info-value {
        text-align: left;
    }
    
    .file-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }
    
    .file-actions {
        align-self: stretch;
        justify-content: space-between;
    }
    
    .file-action-btn {
        flex: 1;
        padding: 12px 20px;
        font-size: 16px;
    }
}

/* Styles pour les fichiers et informations média - Material Design */
.file-item {
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: white;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.file-item:hover {
    border-color: #2196F3;
    box-shadow: 0 4px 20px rgba(33, 150, 243, 0.15);
    transform: translateY(-1px);
}

.file-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #e0e0e0;
}

.file-name {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%;
    color: #333;
    font-size: 15px;
}

.file-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

.btn-action {
    font-size: 1.3em;
    text-decoration: none;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: white;
    color: #666;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-action:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    border-color: #2196F3;
    color: #2196F3;
}

.media-info-container {
    max-height: 0;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
}

.media-details h6 {
    margin: 16px 0 12px 0;
    font-size: 16px;
    color: #333;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 8px;
}

.media-details ul {
    list-style: none;
    padding: 0;
    margin: 0 0 20px 0;
}

.media-details li {
    padding: 12px 16px;
    margin-bottom: 8px;
    border-radius: 8px;
    font-size: 14px;
    border-left: 4px solid #e0e0e0;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.media-details li:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.loading-info, .error-info {
    text-align: center;
    padding: 24px;
    font-style: italic;
    font-size: 16px;
    border-radius: 12px;
    margin: 16px;
}

.loading-info {
    color: #666;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.error-info {
    color: #c62828;
    background: linear-gradient(135deg, #ffebee 0%, #fde7e7 100%);
}

/* Styles pour la sélection en masse - Material Design */
.torrent-checkbox {
    transform: scale(1.3);
    margin: 0;
    cursor: pointer;
    accent-color: #2196F3;
    border-radius: 4px;
}

#selectAll {
    transform: scale(1.3);
    cursor: pointer;
    accent-color: #2196F3;
    border-radius: 4px;
}

#selectionActions {
    animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #FF9800;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 16px rgba(255, 152, 0, 0.2);
}

@keyframes slideDown {
    from { 
        opacity: 0; 
        transform: translateY(-10px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.875rem;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

/* Boutons avec Material Design - harmonisé avec symlink_tool */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 500;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    cursor: pointer;
    border: none;
    padding: 12px 24px;
    font-size: 14px;
    line-height: 1.5;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    text-decoration: none;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 12px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-danger {
    background: linear-gradient(135deg, #f44336 0%, #D32F2F 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
}

.btn-danger:hover {
    background: linear-gradient(135deg, #D32F2F 0%, #C62828 100%);
    box-shadow: 0 8px 20px rgba(244, 67, 54, 0.4);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #495057 0%, #343a40 100%);
    box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
    color: white;
}

.btn-primary {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
    box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.btn-success:hover {
    background: linear-gradient(135deg, #388E3C 0%, #2E7D32 100%);
    box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
    color: white;
}

/* Styles pour la modal optimisée */
.file-item-optimized {
    animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.files-controls input:focus {
    outline: none;
    border-color: #2196F3;
    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
}

.refresh-icon-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
}

/* Responsive pour la modal optimisée */
@media (max-width: 480px) {
    .file-item-optimized {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 6px;
        padding: 6px 8px !important;
    }
    
    .file-actions-optimized {
        width: 100%;
        justify-content: center;
        gap: 6px !important;
    }
    
    .files-pagination button,
    .files-pagination span {
        font-size: 10px !important;
        padding: 3px 6px !important;
    }
    
    .files-controls {
        flex-direction: row !important;
        align-items: center !important;
        gap: 4px !important;
    }
    
    .files-controls button,
    .files-controls input {
        font-size: 10px !important;
        padding: 2px 4px !important;
    }
    
    .card-title {
        font-size: 1.0em !important;
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 6px !important;
    }
}

@media (max-width: 768px) {
    .responsive-modal {
        margin: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        height: 100vh !important;
        max-height: 100vh !important;
        border-radius: 0 !important;
        padding: 12px !important;
    }
    
    .files-controls {
        flex-direction: row;
        align-items: center !important;
        gap: 6px;
        flex-wrap: wrap;
    }
    
    .files-controls input {
        flex: 1 !important;
        min-width: 80px !important;
    }
    
    .files-pagination {
        flex-wrap: wrap;
        gap: 5px !important;
    }
    
    .detail-grid {
        grid-template-columns: 1fr !important;
    }
    
    .card-title {
        font-size: 1.1em !important;
        flex-direction: column;
        align-items: flex-start !important;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .file-item-optimized {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 8px;
    }
    
    .file-actions-optimized {
        width: 100%;
        justify-content: space-between;
    }
    
    .files-pagination button,
    .files-pagination span {
        font-size: 11px !important;
        padding: 4px 8px !important;
    }
}
</style>

<script>
// Système de notifications toast - Material Design
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    
    // Définir les couleurs selon le type
    const colors = {
        success: { border: '#4CAF50', bg: 'linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%)', color: '#2e7d32' },
        error: { border: '#f44336', bg: 'linear-gradient(135deg, #ffebee 0%, #fde7e7 100%)', color: '#c62828' },
        warning: { border: '#FF9800', bg: 'linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)', color: '#ef6c00' },
        info: { border: '#2196F3', bg: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', color: '#1565c0' }
    };
    
    const style = colors[type] || colors.info;
    
    toast.innerHTML = message;
    toast.style.cssText = `
        padding: 16px 20px; border-radius: 12px; font-size: 14px; font-weight: 500;
        background: ${style.bg}; color: ${style.color};
        border-left: 4px solid ${style.border};
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        min-width: 300px; max-width: 350px;
        transform: translateX(380px); opacity: 0;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 12px;
    `;
    
    // Ajouter au conteneur en bas à droite
    const container = document.getElementById('toast-container');
    container.appendChild(toast);
    
    // Animation d'entrée
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
        toast.style.opacity = '1';
    }, 100);
    
    // Animation de sortie
    setTimeout(() => {
        toast.style.transform = 'translateX(380px)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 400);
    }, 3000);
}

// === FONCTIONS POUR ACTIONS DE SYNCHRONISATION ===

// Fonction pour masquer/afficher les actions de synchronisation
// === FONCTIONS DE SYNCHRONISATION ===

// Fonction d'exécution des actions de synchronisation
function executeSyncAction(url, actionName) {
    // Utiliser la boîte de dialogue native du navigateur avec fallback
    const userConfirmed = confirm(`Voulez-vous vraiment lancer : ${actionName} ?`);
    
    if (userConfirmed) {
        showToast(`${actionName} en cours d'exécution...`, 'info');
        
        // Utiliser POST pour les actions de synchronisation
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message || `${actionName} démarrée avec succès`, 'success');
                    // Recharger la page après 10 secondes pour voir les nouveaux stats
                    setTimeout(() => location.reload(), 10000);
                } else {
                    throw new Error(data.error || 'Erreur inconnue');
                }
            })
            .catch(error => {
                showToast(`Échec du démarrage de ${actionName}: ${error.message}`, 'error');
            });
    }
}

// Fonction pour rafraîchir les statistiques
function refreshStatistics() {
    // Utiliser la boîte de dialogue native du navigateur
    if (confirm('Cette action va corriger les statistiques après les suppressions. Continuer ?')) {
        showToast('Rafraîchissement des statistiques...', 'info');
        
        fetch('/api/refresh_stats')
            .then(response => {
                if (response.ok) {
                    showToast('Statistiques mises à jour avec succès', 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
            })
            .catch(error => {
                showToast(`Erreur lors de la mise à jour: ${error.message}`, 'error');
            });
    }
}

// === FIN FONCTIONS DE SYNCHRONISATION ===

// Indicateur de chargement global
function showLoading(show = true, message = 'Chargement...') {
    let loader = document.getElementById('global-loader');
    if (show) {
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
                align-items: center; justify-content: center; color: white;
                font-size: 16px; font-weight: bold;
            `;
            loader.innerHTML = `<div style="text-align: center;"><div style="font-size: 2em; margin-bottom: 10px;">⏳</div>${message}</div>`;
            document.body.appendChild(loader);
        }
    } else if (loader) {
        loader.remove();
    }
}

function deleteTorrent(torrentId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce torrent de Real-Debrid ?')) {
        showLoading(true, 'Suppression en cours...');
        fetch(`/api/torrent/delete/${torrentId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    // Supprimer dynamiquement la ligne du tableau
                    const row = document.querySelector(`tr[data-torrent-id="${torrentId}"]`);
                    if (row) {
                        row.style.opacity = '0.5';
                        setTimeout(() => row.remove(), 300);
                    }
                    showToast('✅ Torrent supprimé avec succès', 'success');
                } else {
                    showToast('❌ Erreur: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showToast('❌ Erreur réseau', 'error');
                console.error('Erreur:', error);
            });
    }
}

function updateTorrentDetails(torrentId) {
    showLoading(true, 'Mise à jour des détails en cours...');
    fetch(`/api/torrent/${torrentId}`, { method: 'GET' })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.success !== false) {
                // Rafraîchir la page pour montrer les données mises à jour
                showToast('✅ Détails du torrent mis à jour', 'success');
                // Délai pour afficher le toast avant le rechargement
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showToast('❌ Erreur lors de la mise à jour: ' + (data.error || 'Erreur inconnue'), 'error');
            }
        })
        .catch(error => {
            showLoading(false);
            showToast('❌ Erreur réseau lors de la mise à jour', 'error');
            console.error('Erreur:', error);
        });
}

function showDetailsModal(torrentId) {
    console.log('🔍 Affichage modal pour torrent:', torrentId);
    
    // Créer l'overlay modal simple et qui fonctionne
    const overlay = document.createElement('div');
    overlay.id = 'torrentModal';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    `;
    
    // Contenu simple d'abord
    overlay.innerHTML = `
        <div style="
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 800px; 
            max-height: 80vh; 
            overflow-y: auto;
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 15px;">
                <h3 style="margin: 0; font-size: 1.3em; color: #2c3e50;">🔄 Torrent ${torrentId}</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d; padding: 5px;">×</button>
            </div>
            
            <div id="content">
                <div id="loading" style="text-align: center; padding: 40px;">
                    <div style="font-size: 2em; margin-bottom: 15px;">🔄</div>
                    <div style="font-size: 1.1em; color: #007bff;">Récupération des fichiers...</div>
                </div>
                
                <div id="files" style="display: none;">
                    <!-- Fichiers ici -->
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Fermer avec clic sur overlay
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closeModal();
    });
    
    // Maintenant faire le fetch
    const loadingDiv = overlay.querySelector('#loading');
    const filesDiv = overlay.querySelector('#files');
    
    console.log('🔍 Éléments trouvés:', { loadingDiv: !!loadingDiv, filesDiv: !!filesDiv });
    
    const streamUrl = '/api/torrent/stream/' + torrentId;
    console.log('🚀 Fetch vers:', streamUrl);
    
    // Appel direct à l'API - version simplifiée
    console.log('🔄 Début du fetch pour torrent:', torrentId);
    fetch(streamUrl)
        .then(function(response) {
            console.log('📡 Réponse directe reçue, status:', response.status);
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(function(streamData) {
            console.log('✅ Données directes reçues:', streamData);
            
            // Mettre à jour le titre du modal avec le nom du torrent
            const modalTitle = overlay.querySelector('h3');
            if (modalTitle && streamData && streamData.torrent_info && streamData.torrent_info.filename) {
                const torrentName = streamData.torrent_info.filename || streamData.torrent_info.original_filename || `Torrent ${torrentId}`;
                modalTitle.textContent = `🎬 ${torrentName}`;
                console.log('📝 Titre mis à jour:', torrentName);
            }
            
            if (!filesDiv) {
                console.error('❌ Élément files non trouvé !');
                return;
            }
            
            if (streamData && streamData.success && streamData.files && streamData.files.length > 0) {
                console.log('🎯 Affichage de ' + streamData.files.length + ' fichiers');
                
                // Filtrer seulement les fichiers avec selected: 1
                const selectedFiles = streamData.files.filter(file => file.selected === 1);
                console.log('� Fichiers sélectionnés (selected=1):', selectedFiles.length, 'sur', streamData.files.length);
                
                if (selectedFiles.length > 0) {
                    let html = '<h4>🎬 Fichiers vidéo (' + selectedFiles.length + ')</h4>';
                    
                    // Afficher seulement les fichiers sélectionnés
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        const filename = file.filename || file.name || 'Fichier ' + (i + 1);
                        
                        // Fonction locale pour formater la taille
                        function formatBytes(bytes) {
                            if (!bytes || bytes === 0) return 'Taille inconnue';
                            const k = 1024;
                            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                        }
                        
                        // Essayer différentes propriétés pour la taille et afficher pour debug
                        const rawSize = file.bytes || file.size || file.filesize || 0;
                        const fileSize = formatBytes(rawSize);
                        console.log('📏 Fichier:', filename, '- Taille calculée:', fileSize, '- Raw bytes:', rawSize, '- File object:', file);
                        
                        html += `
                            <div style="
                                background: #fafafa;
                                border: 1px solid #e0e0e0;
                                border-radius: 6px;
                                padding: 12px;
                                margin-bottom: 8px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                gap: 12px;
                            ">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 500; font-size: 14px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${filename}">
                                        🎬 ${filename.length > 55 ? filename.substring(0, 52) + '...' : filename}
                                    </div>
                                    <div style="font-size: 12px; color: #007bff; margin-top: 4px; font-weight: 500;">
                                        💾 ${fileSize}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-shrink: 0;">`;
                        
                        if (file.streaming_link) {
                            html += `<a href="${file.streaming_link}" target="_blank" style="background: #4CAF50; color: white; text-decoration: none; padding: 8px 12px; border-radius: 4px; font-size: 12px;">🎬 Stream</a>`;
                        }
                        
                        if (file.download_link) {
                            html += `<a href="${file.download_link}" target="_blank" style="background: #2196F3; color: white; text-decoration: none; padding: 8px 12px; border-radius: 4px; font-size: 12px;">💾 Télécharger</a>`;
                        }
                        
                        html += `</div></div>`;
                    }
                    
                    filesDiv.innerHTML = html;
                } else {
                    filesDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #ffc107;">⚠️ Aucun fichier vidéo principal trouvé (selected=1)</div>';
                }
                
                // Masquer le loading et afficher les fichiers
                console.log('🎯 Mise à jour de l\'affichage...');
                loadingDiv.style.display = 'none';
                filesDiv.style.display = 'block';
                
                console.log('✅ Affichage direct terminé !');
                
            } else {
                console.log('❌ Pas de fichiers dans la réponse directe');
                filesDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">📭 Aucun fichier disponible</div>';
                loadingDiv.style.display = 'none';
                filesDiv.style.display = 'block';
            }
        })
        .catch(function(err) {
            console.error('❌ Erreur fetch direct:', err);
            filesDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">⚠️ Erreur: ' + err.message + '</div>';
            loadingDiv.style.display = 'none';
            filesDiv.style.display = 'block';
        });
}

// Fonctions d'aide pour l'affichage amélioré
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(dateString) {
    if (!dateString) return 'Non disponible';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    } catch {
        return 'Date invalide';
    }
}

function createFileCard(file, index, isVideo) {
    const filename = file.filename || file.name || `Fichier ${index + 1}`;
    const fileSize = file.bytes ? formatFileSize(file.bytes) : 'Taille inconnue';
    const icon = isVideo ? '🎬' : '📄';
    const cardClass = isVideo ? 'file-card video-file' : 'file-card other-file';
    
    return `
        <div class="${cardClass}">
            <div class="file-header">
                <div class="file-icon">${icon}</div>
                <div class="file-info">
                    <div class="file-name" title="${filename}">${filename}</div>
                    <div class="file-meta">
                        <span class="file-size">${fileSize}</span>
                        <span class="file-selected">Selected: ${file.selected}</span>
                    </div>
                </div>
            </div>
            <div class="file-actions">
                ${file.download_link ? `<a href="${file.download_link}" target="_blank" class="action-btn download-btn">📥 Télécharger</a>` : ''}
                ${file.streaming_link ? `<a href="${file.streaming_link}" target="_blank" class="action-btn stream-btn">📺 Stream</a>` : ''}
            </div>
        </div>
    `;
}

function createRefreshIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'refreshIndicator';
    const modalContent = document.getElementById('modalContent');
    modalContent.insertBefore(indicator, modalContent.firstChild);
    return indicator;
}

function closeModal() {
    const modal = document.getElementById('torrentModal');
    if (modal) {
        modal.remove();
    }
}

// Variable globale pour stocker l'ID du torrent actuellement affiché
let currentTorrentId = null;

function refreshTorrentData() {
    if (currentTorrentId) {
        showDetailsModal(currentTorrentId);
    }
}

function reinsertTorrent(torrentId) {
    if (confirm('Êtes-vous sûr de vouloir réinsérer ce torrent sur Real-Debrid ?')) {
        showLoading(true, 'Réinsertion en cours...');
        fetch(`/api/torrent/reinsert/${torrentId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    showToast('✅ Torrent réinséré avec succès !', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('❌ Erreur lors de la réinsertion: ' + (data.error || 'Erreur inconnue'), 'error');
                }
            })
            .catch(err => {
                showLoading(false);
                showToast('❌ Erreur réseau: ' + err.message, 'error');
                console.error('Erreur:', err);
            });
    }
}

function copyTorrentName(torrentName) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(torrentName).then(function() {
            showToast('📋 Nom copié dans le presse-papier !', 'success');
        }).catch(function() {
            // Fallback si l'API Clipboard échoue
            copyToClipboardFallback(torrentName);
        });
    } else {
        // Fallback pour les navigateurs qui ne supportent pas l'API Clipboard
        copyToClipboardFallback(torrentName);
    }
}

function copyToClipboardFallback(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.cssText = 'position: fixed; top: -9999px; left: -9999px;';
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast('📋 Nom copié dans le presse-papier !', 'success');
    } catch (err) {
        showToast('❌ Impossible de copier. Sélectionnez le texte manuellement.', 'error');
        console.error('Erreur copie:', err);
    }
    
    document.body.removeChild(textArea);
}

// ==========================================
// NOUVELLES FONCTIONS POUR LA MODAL OPTIMISÉE
// ==========================================

// Variables globales pour la gestion des fichiers
let allFiles = [];
let currentFilesPage = 1;
let filesPerPage = 15;

// Fonction pour afficher les fichiers de la page actuelle (vue compacte uniquement)
function displayCurrentFilesPage() {
    const container = document.getElementById('modalLinks');
    const startIndex = (currentFilesPage - 1) * filesPerPage;
    const endIndex = startIndex + filesPerPage;
    const pageFiles = allFiles.slice(startIndex, endIndex);
    
    let html = '';
    
    pageFiles.forEach((file, index) => {
        const globalIndex = startIndex + index;
        const hasError = file.error && file.error.trim() !== '';
        const hasStreaming = file.streaming_link && !hasError;
        const hasDownload = file.download_link && !hasError;
        
        let displayName = file.filename || `Fichier ${globalIndex + 1}`;
        if (displayName.length > 45) {
            displayName = displayName.substring(0, 45) + '...';
        }
        
        // Style adaptatif pour les boutons selon l'écran
        const isMobile = window.innerWidth < 768;
        const isTablet = window.innerWidth >= 768 && window.innerWidth < 1024;
        const isSmallMobile = window.innerWidth < 480;
        
        // Réduire encore plus la taille sur très petits écrans
        const buttonPadding = isSmallMobile ? '4px' : isMobile ? '5px' : '6px 8px';
        const buttonFontSize = isSmallMobile ? '10px' : isMobile ? '11px' : '11px';
        const buttonGap = isSmallMobile ? '2px' : isMobile ? '3px' : '4px';
        
        html += `
            <div class="file-item-optimized" style="
                background: #fafafa;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                padding: 8px 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                transition: all 0.2s ease;
                ${hasError ? 'border-left: 3px solid #f44336;' : ''}
            " onmouseover="this.style.borderColor='#2196F3'" onmouseout="this.style.borderColor='#e0e0e0'">
                
                <div class="file-info-optimized" style="flex: 1; min-width: 0;">
                    <div class="file-name-optimized" style="
                        font-weight: 500;
                        font-size: 13px;
                        color: ${hasError ? '#c62828' : '#333'};
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    " title="${file.filename || `Fichier ${globalIndex + 1}`}">
                        ${displayName}
                    </div>
                    ${hasError ? `
                        <div style="font-size: 11px; color: #c62828; margin-top: 2px;">
                            ⚠️ ${file.error}
                        </div>
                    ` : ''}
                </div>
                
                <div class="file-actions-optimized" style="
                    display: flex;
                    gap: ${buttonGap};
                    flex-shrink: 0;
                    align-items: center;
                ">
                    ${hasStreaming ? `
                        <a href="${file.streaming_link}" target="_blank" 
                           style="
                               background: ${isMobile ? '#4CAF50' : 'linear-gradient(135deg, #4CAF50, #388E3C)'};
                               color: white;
                               text-decoration: none;
                               padding: ${buttonPadding};
                               border-radius: 3px;
                               font-size: ${buttonFontSize};
                               font-weight: 500;
                               display: flex;
                               align-items: center;
                               gap: 2px;
                               transition: all 0.2s ease;
                               box-shadow: 0 1px 3px rgba(76, 175, 80, 0.3);
                               min-width: ${isSmallMobile ? '24px' : '28px'};
                               justify-content: center;
                           "
                           title="Lire en streaming"
                           onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(76, 175, 80, 0.4)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(76, 175, 80, 0.3)';">
                            🎬${isSmallMobile ? '' : isMobile ? '' : isTablet ? ' Stream' : ' Stream'}
                        </a>
                    ` : `
                        <span style="
                            background: #f5f5f5;
                            color: #9e9e9e;
                            padding: ${buttonPadding};
                            border-radius: 3px;
                            font-size: ${buttonFontSize};
                            display: flex;
                            align-items: center;
                            gap: 2px;
                            min-width: ${isSmallMobile ? '24px' : '28px'};
                            justify-content: center;
                        " title="Streaming indisponible">
                            🎬
                        </span>
                    `}
                    
                    ${hasDownload ? `
                        <a href="${file.download_link}" target="_blank" 
                           style="
                               background: ${isMobile ? '#2196F3' : 'linear-gradient(135deg, #2196F3, #1976D2)'};
                               color: white;
                               text-decoration: none;
                               padding: ${buttonPadding};
                               border-radius: 3px;
                               font-size: ${buttonFontSize};
                               font-weight: 500;
                               display: flex;
                               align-items: center;
                               gap: 2px;
                               transition: all 0.2s ease;
                               box-shadow: 0 1px 3px rgba(33, 150, 243, 0.3);
                               min-width: ${isSmallMobile ? '24px' : '28px'};
                               justify-content: center;
                           "
                           title="Télécharger"
                           onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(33, 150, 243, 0.4)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(33, 150, 243, 0.3)';">
                            💾${isSmallMobile ? '' : isMobile ? '' : isTablet ? ' DL' : ' Télécharger'}
                        </a>
                    ` : `
                        <span style="
                            background: #f5f5f5;
                            color: #9e9e9e;
                            padding: ${buttonPadding};
                            border-radius: 3px;
                            font-size: ${buttonFontSize};
                            display: flex;
                            align-items: center;
                            gap: 2px;
                            min-width: ${isSmallMobile ? '24px' : '28px'};
                            justify-content: center;
                        " title="Téléchargement indisponible">
                            💾
                        </span>
                    `}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Fonctions de pagination
function updateFilesPagination() {
    const totalPages = Math.ceil(allFiles.length / filesPerPage);
    const pagination = document.getElementById('filesPagination');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    if (totalPages <= 1) {
        pagination.style.display = 'none';
    } else {
        pagination.style.display = 'flex';
        pageInfo.textContent = `Page ${currentFilesPage} sur ${totalPages} (${allFiles.length} fichiers)`;
        
        prevBtn.disabled = currentFilesPage <= 1;
        nextBtn.disabled = currentFilesPage >= totalPages;
        
        prevBtn.style.opacity = currentFilesPage <= 1 ? '0.5' : '1';
        nextBtn.style.opacity = currentFilesPage >= totalPages ? '0.5' : '1';
    }
}

function previousFilesPage() {
    if (currentFilesPage > 1) {
        currentFilesPage--;
        updateFilesPagination();
        displayCurrentFilesPage();
    }
}

function nextFilesPage() {
    const totalPages = Math.ceil(allFiles.length / filesPerPage);
    if (currentFilesPage < totalPages) {
        currentFilesPage++;
        updateFilesPagination();
        displayCurrentFilesPage();
    }
}

// Fonction utilitaire pour formater les tailles de fichiers
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Fonction utilitaire pour formater les tailles
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Fonction modifiée pour initialiser les fichiers optimisés avec tri alphabétique
function initializeOptimizedFiles(files) {
    const rawFiles = files || [];
    
    console.log(`📋 Données brutes reçues pour ${rawFiles.length} fichiers:`, rawFiles.slice(0, 3)); // Log des 3 premiers fichiers pour debug
    
    // Filtrer pour ne garder que les fichiers vidéo et éliminer les NFO, txt, etc.
    allFiles = rawFiles.filter(file => {
        // Si le fichier a une propriété 'selected', ne garder que ceux sélectionnés (selected = 1)
        if (file.selected !== undefined) {
            console.log(`🔍 Fichier ${file.filename}: selected=${file.selected}`);
            return file.selected === 1;
        }
        
        // Sinon, filtrer par extension pour ne garder que les fichiers vidéo
        const filename = file.filename || file.name || file.path || '';
        const videoExtensions = ['.mkv', '.mp4', '.avi', '.mov', '.wmv', '.flv', '.webm', '.m4v', '.ts', '.m2ts'];
        const isVideoFile = videoExtensions.some(ext => filename.toLowerCase().endsWith(ext));
        
        // Exclure explicitement les fichiers NFO, txt, srt, etc.
        const excludeExtensions = ['.nfo', '.txt', '.srt', '.sub', '.idx', '.jpg', '.png', '.gif'];
        const isExcludedFile = excludeExtensions.some(ext => filename.toLowerCase().endsWith(ext));
        
        return isVideoFile && !isExcludedFile;
    });
    
    console.log(`📁 Fichiers reçus: ${rawFiles.length}, Fichiers vidéo filtrés: ${allFiles.length}`);
    
    // Tri alphabétique par nom de fichier
    allFiles.sort((a, b) => {
        const nameA = (a.filename || a.name || a.path || '').toLowerCase();
        const nameB = (b.filename || b.name || b.path || '').toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    currentFilesPage = 1;
    
    // Ajuster le nombre de fichiers par page selon la taille d'écran de façon plus agressive
    if (window.innerWidth < 480) {
        filesPerPage = 8; // Très petit mobile - encore moins de fichiers
    } else if (window.innerWidth < 768) {
        filesPerPage = 12; // Mobile - réduit
    } else if (window.innerWidth < 1024) {
        filesPerPage = 16; // Tablet - équilibré
    } else {
        filesPerPage = 20; // Desktop - plus de fichiers
    }
    
    updateFilesPagination();
    displayCurrentFilesPage();
}

// ==========================================
// FIN DES NOUVELLES FONCTIONS
// ==========================================

// NOUVELLE FONCTION POUR RÉCUPÉRER LES INFOS MÉDIA DÉTAILLÉES
function fetchMediaInfo(fileId, index) {
    const container = document.getElementById(`media-info-${index}`);
    const fileItem = document.getElementById(`file-item-${index}`);
    
    // Si déjà ouvert, on le ferme
    if (container.style.maxHeight !== '0px' && container.innerHTML !== '') {
        container.style.maxHeight = '0px';
        container.style.padding = '0';
        fileItem.style.borderColor = '#e0e0e0';
        fileItem.style.boxShadow = 'none';
        setTimeout(() => {
            container.innerHTML = '';
        }, 300);
        return;
    }

    // Afficher l'indicateur de chargement
    container.innerHTML = `
        <div class="loading-info" style="padding: 15px; text-align: center; color: #6c757d;">
            <div style="font-size: 1.5em; margin-bottom: 8px; animation: spin 2s linear infinite;">🔄</div>
            <div>Récupération des métadonnées média...</div>
        </div>
    `;
    container.style.maxHeight = '200px';
    container.style.padding = '0';
    fileItem.style.borderColor = '#007bff';
    fileItem.style.boxShadow = '0 0 5px rgba(0,123,255,0.3)';

    // Appel à l'API pour récupérer les informations média
    fetch(`/api/media_info/${fileId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = '<div class="media-details" style="padding: 15px;">';
                
                // Informations générales
                if (data.filename || data.type || data.duration) {
                    html += '<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">';
                    if (data.filename) {
                        html += `<div style="margin-bottom: 5px;"><strong>📄 Nom:</strong> ${data.filename}</div>`;
                    }
                    if (data.type) {
                        const typeEmoji = data.type === 'movie' ? '🎬' : data.type === 'show' ? '📺' : data.type === 'audio' ? '🎵' : '📄';
                        html += `<div style="margin-bottom: 5px;"><strong>🎭 Type:</strong> ${typeEmoji} ${data.type}</div>`;
                    }
                    if (data.duration) {
                        const hours = Math.floor(data.duration / 3600);
                        const minutes = Math.floor((data.duration % 3600) / 60);
                        html += `<div style="margin-bottom: 5px;"><strong>⏱️ Durée:</strong> ${hours}h${minutes.toString().padStart(2, '0')}m</div>`;
                    }
                    if (data.size) {
                        const sizeGB = (data.size / (1024**3)).toFixed(2);
                        html += `<div><strong>💾 Taille:</strong> ${sizeGB} GB</div>`;
                    }
                    html += '</div>';
                }
                
                // Pistes vidéo
                if (data.video && data.video.length > 0) {
                    html += '<h6 style="margin: 10px 0 8px 0; color: #343a40; display: flex; align-items: center; gap: 6px;"><span>🎥</span> Pistes Vidéo</h6>';
                    html += '<ul style="list-style: none; padding: 0; margin: 0 0 15px 0;">';
                    data.video.forEach((track, idx) => {
                        html += `<li style="background: #e8f4f8; padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #007bff;">`;
                        html += `<strong>Piste ${idx + 1}:</strong> `;
                        if (track.width && track.height) {
                            html += `${track.width}x${track.height} `;
                        }
                        if (track.codec) {
                            html += `• ${track.codec.toUpperCase()} `;
                        }
                        if (track.colorspace) {
                            html += `• ${track.colorspace}`;
                        }
                        html += `</li>`;
                    });
                    html += '</ul>';
                }

                // Pistes audio
                if (data.audio && data.audio.length > 0) {
                    html += '<h6 style="margin: 10px 0 8px 0; color: #343a40; display: flex; align-items: center; gap: 6px;"><span>🔊</span> Pistes Audio</h6>';
                    html += '<ul style="list-style: none; padding: 0; margin: 0 0 15px 0;">';
                    data.audio.forEach((track, idx) => {
                        html += `<li style="background: #f0f8e8; padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #28a745;">`;
                        html += `<strong>${track.lang || `Piste ${idx + 1}`}:</strong> `;
                        if (track.codec) {
                            html += `${track.codec.toUpperCase()} `;
                        }
                        if (track.channels) {
                            html += `• ${track.channels} ch `;
                        }
                        if (track.sampling) {
                            html += `• ${track.sampling} Hz`;
                        }
                        html += `</li>`;
                    });
                    html += '</ul>';
                }

                // Sous-titres
                if (data.subtitles && data.subtitles.length > 0) {
                    html += '<h6 style="margin: 10px 0 8px 0; color: #343a40; display: flex; align-items: center; gap: 6px;"><span>💬</span> Sous-titres</h6>';
                    html += '<ul style="list-style: none; padding: 0; margin: 0 0 10px 0;">';
                    data.subtitles.forEach((sub, idx) => {
                        html += `<li style="background: #fff3e0; padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #ff9800;">`;
                        html += `<strong>${sub.lang || `Sous-titre ${idx + 1}`}:</strong> `;
                        if (sub.type) {
                            html += `${sub.type.toUpperCase()}`;
                        }
                        html += `</li>`;
                    });
                    html += '</ul>';
                }

                // Message si aucune information détaillée
                if (!data.video?.length && !data.audio?.length && !data.subtitles?.length) {
                    html += '<div style="text-align: center; padding: 20px; color: #6c757d;">';
                    html += '<div style="font-size: 1.5em; margin-bottom: 8px;">📋</div>';
                    html += '<div>Aucune information de pistes détaillée disponible</div>';
                    html += '<div style="font-size: 0.85em; margin-top: 5px;">Ce fichier pourrait ne pas être un média vidéo/audio</div>';
                    html += '</div>';
                }

                html += '</div>';
                container.innerHTML = html;
                container.style.maxHeight = '400px';
            } else {
                container.innerHTML = `
                    <div class="error-info" style="padding: 15px; text-align: center; color: #dc3545;">
                        <div style="font-size: 1.5em; margin-bottom: 8px;">❌</div>
                        <div><strong>Erreur:</strong> ${data.error}</div>
                        <div style="font-size: 0.85em; margin-top: 5px; color: #6c757d;">
                            Les informations média ne sont pas disponibles pour ce fichier
                        </div>
                    </div>
                `;
                container.style.maxHeight = '150px';
            }
        })
        .catch(err => {
            console.error('Erreur fetchMediaInfo:', err);
            container.innerHTML = `
                <div class="error-info" style="padding: 15px; text-align: center; color: #dc3545;">
                    <div style="font-size: 1.5em; margin-bottom: 8px;">🌐</div>
                    <div><strong>Erreur réseau</strong></div>
                    <div style="font-size: 0.85em; margin-top: 5px; color: #6c757d;">
                        Impossible de récupérer les informations média
                    </div>
                </div>
            `;
            container.style.maxHeight = '150px';
        });
}

// Fermer le modal en cliquant à l'extérieur
window.onclick = function(event) {
    const modal = document.getElementById('torrentModal');
    if (event.target === modal) {
        closeModal();
    }
}

// Fermer le modal avec Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

// ==========================================
// FONCTIONS DE COUVERTURE DES DÉTAILS
// ==========================================

// Fonction pour initialiser l'indicateur de couverture des détails
function initializeCoverageIndicator() {
    const coverage = {{ coverage|default(0) }};
    const coverageText = document.getElementById('coverageText');
    const coverageProgress = document.getElementById('coverageProgress');
    
    if (coverageText && coverageProgress) {
        // Mise à jour du texte
        coverageText.textContent = `${coverage}%`;
        
        // Animation de la barre de progression circulaire
        const circumference = 2 * Math.PI * 10; // rayon de 10
        const offset = circumference - (coverage / 100) * circumference;
        
        // Animation avec un délai pour l'effet visuel
        setTimeout(() => {
            coverageProgress.style.strokeDashoffset = offset;
        }, 100);
        
        // Changement de couleur en fonction du pourcentage
        if (coverage >= 90) {
            coverageProgress.style.stroke = '#4CAF50'; // Vert
            coverageText.style.color = '#2e7d32';
        } else if (coverage >= 70) {
            coverageProgress.style.stroke = '#ff9800'; // Orange
            coverageText.style.color = '#ef6c00';
        } else {
            coverageProgress.style.stroke = '#f44336'; // Rouge
            coverageText.style.color = '#c62828';
        }
        
        console.log(`📊 Indicateur de couverture initialisé: ${coverage}%`);
    }
}

// Fonction pour mettre à jour l'indicateur de couverture
function updateCoverageIndicator(newCoverage) {
    const coverageText = document.getElementById('coverageText');
    const coverageProgress = document.getElementById('coverageProgress');
    
    if (coverageText && coverageProgress) {
        coverageText.textContent = `${newCoverage}%`;
        
        const circumference = 2 * Math.PI * 10;
        const offset = circumference - (newCoverage / 100) * circumference;
        coverageProgress.style.strokeDashoffset = offset;
        
        // Mise à jour des couleurs
        if (newCoverage >= 90) {
            coverageProgress.style.stroke = '#4CAF50';
            coverageText.style.color = '#2e7d32';
        } else if (newCoverage >= 70) {
            coverageProgress.style.stroke = '#ff9800';
            coverageText.style.color = '#ef6c00';
        } else {
            coverageProgress.style.stroke = '#f44336';
            coverageText.style.color = '#c62828';
        }
        
        console.log(`📊 Couverture mise à jour: ${newCoverage}%`);
    }
}

// ==========================================
// FONCTIONS DE SUPPRESSION EN MASSE
// ==========================================

let selectedTorrents = new Set();
let currentBatchId = null;
let batchPollingInterval = null;

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔄 Initialisation de la page torrents');
    
    // S'assurer que toutes les sélections sont vides au chargement
    selectedTorrents.clear();
    
    // Décocher toutes les cases au chargement
    const allCheckboxes = document.querySelectorAll('.torrent-checkbox, #selectAll');
    allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.indeterminate = false;
    });
    
    // Masquer les actions de sélection
    const actionsDiv = document.getElementById('selectionActions');
    if (actionsDiv) {
        actionsDiv.style.display = 'none';
    }
    
    // Initialiser l'indicateur de couverture
    initializeCoverageIndicator();
    
    console.log('✅ Sélections réinitialisées');
});

function toggleSelectAll(checkbox) {
    const torrentCheckboxes = document.querySelectorAll('.torrent-checkbox');
    torrentCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedTorrents.add(cb.value);
        } else {
            selectedTorrents.delete(cb.value);
        }
    });
    updateSelectionActions();
}

function updateSelectionActions() {
    const checkboxes = document.querySelectorAll('.torrent-checkbox');
    selectedTorrents.clear();
    
    checkboxes.forEach(cb => {
        if (cb.checked) {
            selectedTorrents.add(cb.value);
        }
    });
    
    const actionsDiv = document.getElementById('selectionActions');
    const countSpan = document.getElementById('selectionCount');
    
    if (selectedTorrents.size > 0) {
        actionsDiv.style.display = 'block';
        countSpan.textContent = selectedTorrents.size;
    } else {
        actionsDiv.style.display = 'none';
    }
    
    // Mettre à jour la checkbox "tout sélectionner"
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkedCount = document.querySelectorAll('.torrent-checkbox:checked').length;
    const totalCount = checkboxes.length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === totalCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

function clearSelection() {
    console.log('🧹 Nettoyage des sélections');
    
    // Vider le Set des torrents sélectionnés
    selectedTorrents.clear();
    
    // Décocher toutes les cases à cocher
    const allCheckboxes = document.querySelectorAll('.torrent-checkbox');
    allCheckboxes.forEach(cb => {
        cb.checked = false;
    });
    
    // Réinitialiser la case "tout sélectionner"
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
    
    // Masquer les actions de sélection
    updateSelectionActions();
    
    console.log('✅ Sélections nettoyées');
}

function confirmBatchDeletion() {
    if (selectedTorrents.size === 0) {
        showToast('❌ Aucun torrent sélectionné', 'error');
        return;
    }
    
    const count = selectedTorrents.size;
    const torrentWord = count === 1 ? 'torrent' : 'torrents';
    const message = `Êtes-vous sûr de vouloir supprimer ${count} ${torrentWord} de Real-Debrid ?\n\nCette action est irréversible et peut prendre plusieurs minutes pour ${count > 10 ? 'de nombreux torrents' : 'quelques torrents'}.`;
    
    if (confirm(message)) {
        console.log(`🗑️ Démarrage suppression de ${count} torrents:`, Array.from(selectedTorrents));
        startBatchDeletion();
    }
}

function startBatchDeletion() {
    const torrentIds = Array.from(selectedTorrents);
    
    // Afficher le modal de progression
    const modal = document.getElementById('batchProgressModal');
    if (!modal) {
        showToast('❌ Erreur: Modal de progression non trouvé', 'error');
        return;
    }
    modal.style.display = 'block';
    
    // Initialiser les compteurs avec vérification d'existence
    const elements = {
        'batchTotal': torrentIds.length,
        'batchProgress': '0',
        'batchSuccess': '0',
        'batchFailed': '0'
    };
    
    for (const [id, value] of Object.entries(elements)) {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = value;
    }
    
    const progressBar = document.getElementById('batchProgressBar');
    if (progressBar) progressBar.style.width = '0%';
    
    const errors = document.getElementById('batchErrors');
    if (errors) errors.style.display = 'none';
    
    const closeBtn = document.getElementById('batchCloseBtn');
    if (closeBtn) closeBtn.disabled = true;
    
    const cancelBtn = document.getElementById('batchCancelBtn');
    if (cancelBtn) cancelBtn.style.display = 'inline-block';
    
    // Lancer la suppression
    fetch('/api/torrents/delete_batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            torrent_ids: torrentIds
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            currentBatchId = data.batch_id;
            showToast(`🚀 Suppression de ${data.total} torrents démarrée`, 'info');
            
            // Démarrer le polling du statut
            startBatchStatusPolling();
        } else {
            showToast(`❌ Erreur: ${data.error}`, 'error');
            closeBatchModal();
        }
    })
    .catch(error => {
        console.error('Erreur lors du démarrage:', error);
        showToast(`❌ Erreur réseau: ${error.message}`, 'error');
        closeBatchModal();
    });
}

function startBatchStatusPolling() {
    if (!currentBatchId) {
        console.error('❌ Pas de batch ID pour le polling');
        return;
    }
    
    console.log(`🔄 Démarrage polling pour batch: ${currentBatchId}`);
    
    batchPollingInterval = setInterval(() => {
        fetch(`/api/batch_status/${currentBatchId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateBatchProgress(data.batch);
                    
                    if (data.batch.status === 'completed') {
                        console.log('🎉 Batch terminé, arrêt du polling');
                        stopBatchStatusPolling();
                        onBatchCompleted(data.batch);
                    }
                } else {
                    console.error('❌ Erreur récupération statut batch:', data.error);
                    showToast(`❌ Erreur polling: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('❌ Erreur polling batch:', error);
                showToast(`❌ Erreur polling: ${error.message}`, 'error');
                
                // Arrêter le polling en cas d'erreur répétée
                if (error.message.includes('404') || error.message.includes('500')) {
                    stopBatchStatusPolling();
                    showToast('⚠️ Arrêt du suivi automatique (erreur serveur)', 'warning');
                }
            });
    }, 1000); // Polling chaque seconde
}

function updateBatchProgress(batch) {
    console.log('🔄 Mise à jour progression:', batch);
    
    // Mise à jour sécurisée des compteurs
    const updates = {
        'batchProgress': batch.processed,
        'batchSuccess': batch.success,
        'batchFailed': batch.failed
    };
    
    for (const [id, value] of Object.entries(updates)) {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = value;
    }
    
    // Mise à jour de la barre de progression
    const percentage = Math.round((batch.processed / batch.total) * 100);
    const progressBar = document.getElementById('batchProgressBar');
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        progressBar.title = `${percentage}% (${batch.processed}/${batch.total})`;
    }
    
    // Affichage des erreurs si présentes
    if (batch.errors && batch.errors.length > 0) {
        const errorsDiv = document.getElementById('batchErrors');
        const errorsList = document.getElementById('batchErrorsList');
        
        if (errorsDiv && errorsList) {
            errorsList.innerHTML = batch.errors.map(error => 
                `<li><code>${error.torrent_id}</code>: ${error.error}</li>`
            ).join('');
            errorsDiv.style.display = 'block';
        }
    }
}

function refreshStatistics() {
    // Fonction pour rafraîchir les statistiques après suppression
    fetch('/api/refresh_stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Statistiques rafraîchies');
                // Optionnel : mettre à jour les statistiques affichées sur la page
                // sans recharger complètement la page
            } else {
                console.warn('⚠️ Erreur lors du rafraîchissement des statistiques:', data.error);
            }
        })
        .catch(error => {
            console.error('❌ Erreur réseau lors du rafraîchissement des statistiques:', error);
        });
}

function onBatchCompleted(batch) {
    console.log('✅ Suppression terminée:', batch);
    
    const closeBtn = document.getElementById('batchCloseBtn');
    const cancelBtn = document.getElementById('batchCancelBtn');
    
    if (closeBtn) closeBtn.disabled = false;
    if (cancelBtn) cancelBtn.style.display = 'none';
    
    // Message de fin avec détails
    const successRate = Math.round((batch.success / batch.total) * 100);
    const duration = Math.round(batch.duration || 0);
    
    let message = `✅ Suppression terminée: ${batch.success}/${batch.total} succès (${successRate}%)`;
    if (duration > 0) {
        message += ` en ${duration}s`;
    }
    
    const toastType = batch.failed > 0 ? 'warning' : 'success';
    showToast(message, toastType);
    
    // Afficher un résumé dans le modal si des erreurs
    if (batch.failed > 0) {
        console.warn(`⚠️ ${batch.failed} échecs lors de la suppression`);
    }
    
    // Nettoyer immédiatement la sélection avant le rechargement
    clearSelection();
    
    // Rafraîchir les statistiques si des suppressions ont réussi
    if (batch.success > 0) {
        refreshStatistics();
    }
    
    // Réactualiser la page après un délai pour voir les changements
    if (batch.success > 0) {
        setTimeout(() => {
            console.log('🔄 Rechargement de la page...');
            // S'assurer que la sélection est vidée avant le rechargement
            selectedTorrents.clear();
            localStorage.removeItem('torrents_selection'); // Au cas où il y aurait un cache
            location.reload();
        }, 3000);
    }
}

function stopBatchStatusPolling() {
    if (batchPollingInterval) {
        clearInterval(batchPollingInterval);
        batchPollingInterval = null;
    }
}

function cancelBatch() {
    if (currentBatchId && batchPollingInterval) {
        stopBatchStatusPolling();
        showToast('⚠️ Arrêt demandé - Les suppressions en cours vont se terminer', 'warning');
        closeBatchModal();
    }
}

function closeBatchModal() {
    console.log('🔒 Fermeture du modal de suppression');
    
    const modal = document.getElementById('batchProgressModal');
    if (modal) modal.style.display = 'none';
    
    stopBatchStatusPolling();
    currentBatchId = null;
    
    // Nettoyer complètement la sélection
    clearSelection();
    
    // Nettoyer les éléments du modal pour la prochaine fois
    const elementsToReset = ['batchProgress', 'batchSuccess', 'batchFailed'];
    elementsToReset.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = '0';
    });
    
    const progressBar = document.getElementById('batchProgressBar');
    if (progressBar) progressBar.style.width = '0%';
    
    const errors = document.getElementById('batchErrors');
    if (errors) errors.style.display = 'none';
    
    console.log('✅ Modal fermé et sélection nettoyée');
}
    </script><style>
/* CSS Responsif pour le Modal des Détails de Torrent */

/* Variables CSS pour cohérence */
:root {
    --modal-padding-mobile: 15px;
    --modal-padding-tablet: 20px;
    --modal-padding-desktop: 25px;
    --modal-border-radius: 12px;
    --modal-shadow: 0 12px 40px rgba(0,0,0,0.15);
    --primary-color: #007bff;
    --primary-gradient: linear-gradient(135deg, #007bff, #0056b3);
    --text-color: #2c3e50;
}

/* Breakpoints responsifs pour le modal */
@media (max-width: 576px) {
    .responsive-modal {
        width: 95% !important;
        margin: 2% auto !important;
        padding: var(--modal-padding-mobile) !important;
        max-height: 95vh !important;
    }
    
    .responsive-header {
        gap: 12px !important;
        margin-bottom: 15px !important;
        padding-bottom: 12px !important;
    }
    
    .responsive-header h3 {
        font-size: 1.2em !important;
        line-height: 1.3 !important;
    }
    
    .refresh-button {
        padding: 8px 16px !important;
        font-size: 0.85em !important;
    }
    
    .detail-grid {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
    }
    
    .card {
        padding: 15px !important;
    }
    
    .card-title {
        font-size: 1.1em !important;
        margin-bottom: 12px !important;
    }
    
    .info-table .info-row {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 5px !important;
    }
    
    .info-label {
        font-weight: 600 !important;
        color: var(--text-color) !important;
    }
    
    .hash-value {
        word-break: break-all !important;
        font-size: 0.8em !important;
    }
}

@media (min-width: 577px) and (max-width: 768px) {
    .responsive-modal {
        width: 90% !important;
        margin: 3% auto !important;
        padding: var(--modal-padding-tablet) !important;
        max-height: 90vh !important;
    }
    
    .responsive-header {
        gap: 15px !important;
    }
    
    .responsive-header h3 {
        font-size: 1.3em !important;
    }
    
    .refresh-button {
        padding: 9px 18px !important;
        font-size: 0.9em !important;
    }
    
    .detail-grid {
        grid-template-columns: 1fr !important;
        gap: 18px !important;
    }
    
    .card {
        padding: 18px !important;
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .responsive-modal {
        width: 80% !important;
        margin: 3% auto !important;
        padding: var(--modal-padding-desktop) !important;
        max-height: 85vh !important;
    }
    
    .detail-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 20px !important;
    }
}

@media (min-width: 1025px) {
    .responsive-modal {
        width: 70% !important;
        margin: 4% auto !important;
        padding: var(--modal-padding-desktop) !important;
        max-height: 80vh !important;
    }
    
    .detail-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 25px !important;
    }
}

/* Styles généraux du modal améliorés */
.responsive-modal {
    box-shadow: var(--modal-shadow) !important;
    border: 1px solid rgba(220, 226, 231, 0.5) !important;
    border-radius: var(--modal-border-radius) !important;
}

.responsive-header {
    border-bottom: 2px solid #f8f9fa !important;
}

.header-title-row {
    min-height: 40px;
}

.header-actions-row {
    justify-content: center !important;
}

.refresh-button {
    background: var(--primary-gradient) !important;
    border: none !important;
    color: white !important;
    border-radius: 8px !important;
    box-shadow: 0 2px 8px rgba(0,123,255,0.3) !important;
    transition: all 0.2s ease !important;
    font-weight: 500 !important;
}

.refresh-button:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(0,123,255,0.4) !important;
}

.refresh-button:active {
    transform: translateY(0) !important;
}

/* Amélioration des cartes dans le modal */
.detail-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 20px;
}

.card {
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    border: 1px solid rgba(220, 226, 231, 0.8);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    transform: translateY(-1px);
}

.card-title {
    font-size: 1.2em;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e9ecef;
}

.info-table {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f1f3f4;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 500;
    color: #6c757d;
    min-width: 120px;
}

.info-value {
    color: var(--text-color);
    font-weight: 500;
    text-align: right;
    flex: 1;
}

/* Responsive pour les valeurs de hash */
.hash-value {
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

/* Amélioration des barres de progression */
.progress-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
}

.progress-text {
    font-weight: 600;
    color: var(--primary-color);
}

.progress-bar-container {
    background: #e9ecef;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.progress-bar {
    background: var(--primary-gradient);
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
    box-shadow: 0 1px 3px rgba(0,123,255,0.3);
}

/* Styles pour les cartes d'erreurs et de fichiers */
.error-card {
    border-left: 4px solid #dc3545;
}

.files-card {
    border-left: 4px solid #28a745;
}

.error-container {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
}

.error-details {
    color: #dc3545;
    font-size: 0.9em;
    margin: 0;
    white-space: pre-wrap;
}

.files-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Amélioration de l'accessibilité */
.close:focus,
.refresh-button:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* États de hover améliorés */
.info-row:hover {
    background: #f8f9fa;
    border-radius: 6px;
    margin: 0 -8px;
    padding: 8px;
}

/* Nouveaux styles pour l'UI améliorée */

/* Grille d'informations */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.info-card {
    display: flex;
    align-items: center;
    gap: 12px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid rgba(220, 226, 231, 0.8);
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
}

.info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    border-color: #007bff;
}

.info-icon {
    font-size: 1.5em;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-radius: 50%;
    flex-shrink: 0;
}

.info-content {
    flex: 1;
    min-width: 0;
}

.info-label {
    font-size: 0.85em;
    color: #6c757d;
    margin-bottom: 4px;
    font-weight: 500;
}

.info-value {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.95em;
    word-wrap: break-word;
}

.status-downloaded { color: #28a745; }
.status-downloading { color: #007bff; }
.status-waiting { color: #ffc107; }
.status-error { color: #dc3545; }

/* Styles pour les fichiers */
.files-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px 0;
    border-bottom: 2px solid #f1f3f4;
}

.files-header h4 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.3em;
}

.file-stats {
    display: flex;
    gap: 10px;
}

.stat-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 5px;
}

.stat-badge.video {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    color: #2e7d32;
    border: 1px solid #a5d6a7;
}

.stat-badge.other {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    color: #ef6c00;
    border: 1px solid #ffcc02;
}

.file-section {
    margin-bottom: 25px;
}

.section-title {
    color: #2c3e50;
    font-size: 1.1em;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
}

.file-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid #dee2e6;
    border-radius: 10px;
    margin-bottom: 12px;
    padding: 15px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.file-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.file-card.video-file {
    border-left: 4px solid #28a745;
}

.file-card.other-file {
    border-left: 4px solid #ffc107;
}

.file-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
}

.file-icon {
    font-size: 1.5em;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-radius: 8px;
    flex-shrink: 0;
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 6px;
    word-wrap: break-word;
    line-height: 1.3;
}

.file-meta {
    display: flex;
    gap: 15px;
    font-size: 0.85em;
    color: #6c757d;
}

.file-size {
    font-weight: 500;
}

.file-selected {
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.file-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 8px 16px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.9em;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.download-btn {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    color: #1976d2;
    border: 1px solid #90caf9;
}

.download-btn:hover {
    background: linear-gradient(135deg, #bbdefb, #90caf9);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
}

.stream-btn {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    color: #2e7d32;
    border: 1px solid #a5d6a7;
}

.stream-btn:hover {
    background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
}

/* État vide */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
    font-size: 1.1em;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 10px;
    border: 2px dashed #dee2e6;
}

.empty-state span {
    display: block;
    margin-top: 10px;
}

/* Responsive pour les nouveaux éléments */
@media (max-width: 768px) {
    .info-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .files-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .file-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .file-icon {
        align-self: flex-start;
    }
    
    .file-actions {
        width: 100%;
    }
    
    .action-btn {
        flex: 1;
        justify-content: center;
        min-width: 120px;
    }
}
</style>

{% endblock %}
