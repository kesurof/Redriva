{% extends "base.html" %}
{% block title %}Torrents - Redriva Web{% endblock %}
{% block content %}

<!-- Conteneur de notifications -->
<div id="toast-container" class="toast-container"></div>

<style>
/* === VARIABLES CSS === */
:root {
  --primary-color: #2196F3;
  --primary-gradient: linear-gradient(135deg, #2196F3, #1976D2);
  --success-color: #4CAF50;
  --warning-color: #FF9800;
  --error-color: #f44336;
  --text-color: #333;
  --text-muted: #6c757d;
  --border-color: #e0e0e0;
  --bg-light: #f8f9fa;
  --shadow-light: 0 2px 8px rgba(0,0,0,0.1);
  --shadow-medium: 0 4px 16px rgba(0,0,0,0.15);
  --border-radius: 8px;
  --border-radius-lg: 12px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* === ANIMATIONS === */
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* === BASE STYLES === */
.card {
  background: white;
  border: none;
  border-radius: var(--border-radius-lg);
  margin-bottom: 20px;
  padding: 24px;
  box-shadow: var(--shadow-light);
  border-left: 4px solid var(--primary-color);
  transition: var(--transition);
}
.card:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 8px 16px;
  border: none;
  border-radius: var(--border-radius);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
  box-shadow: var(--shadow-light);
}
.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-medium); }

.btn-primary { background: var(--primary-gradient); color: white; }
.btn-success { background: linear-gradient(135deg, var(--success-color), #388E3C); color: white; }
.btn-warning { background: linear-gradient(135deg, var(--warning-color), #e0a800); color: #212529; }
.btn-danger { background: linear-gradient(135deg, var(--error-color), #c82333); color: white; }
.btn-secondary { background: linear-gradient(135deg, #6c757d, #5a6268); color: white; }

/* === COMPONENTS === */
.toast-container {
  position: fixed;
  bottom: 20px;  /* Prioritaire en bas */
  right: 20px;
  z-index: 1002;  /* Plus haut que tout */
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.toast {
  background: white;
  padding: 16px 20px;
  border-radius: var(--border-radius-lg);
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  border-left: 4px solid;
  min-width: 300px;
  transform: translateX(380px);
  opacity: 0;
  transition: var(--transition);
  color: var(--text-color);
  font-weight: 500;
}
.toast.show { transform: translateX(0); opacity: 1; }
.toast.success { border-left-color: var(--success-color); background: linear-gradient(135deg, #f1f8e9, #e8f5e8); color: #2e7d32; }
.toast.error { border-left-color: var(--error-color); background: linear-gradient(135deg, #ffebee, #fde7e7); color: #c62828; }
.toast.warning { border-left-color: var(--warning-color); background: linear-gradient(135deg, #fff8e1, #ffecb3); color: #ef6c00; }
.toast.info { border-left-color: var(--primary-color); background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1565c0; }

.table-responsive { 
  overflow-x: auto; 
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-light);
}

.table {
  border-collapse: separate;
  border-spacing: 0;
}
.table th {
  font-weight: 600;
  color: var(--text-color);
  border: none;
  padding: 16px;
  font-size: 14px;
  background: var(--bg-light);
}
.table td {
  border: none;
  padding: 16px;
  border-bottom: 1px solid #f0f0f0;
  transition: var(--transition);
}
.table tbody tr:hover {
  background: rgba(33, 150, 243, 0.05);
  transform: scale(1.001);
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-content {
  background: white;
  border-radius: var(--border-radius-lg);
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 20px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid var(--border-color);
}

.close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-muted);
  padding: 5px;
  border-radius: 50%;
  transition: var(--transition);
}
.close:hover { background: var(--bg-light); color: var(--error-color); }

/* === RESPONSIVE === */
@media (max-width: 768px) {
  .toast-container { bottom: 10px; right: 10px; left: 10px; }
  .toast { max-width: none; min-width: auto; }
  .modal-content { width: 95%; margin: 0; height: 100vh; max-height: 100vh; border-radius: 0; }
  .btn { padding: 6px 12px; font-size: 12px; }
  .card { padding: 16px; }
}

@media (max-width: 480px) {
  .btn { padding: 4px 8px; font-size: 11px; }
  .card { padding: 12px; }
}
</style>

<!-- En-tÃªte avec actions -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin: 0; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
      ğŸ“‹ Gestion des torrents
    </h2>
  </div>
  
  <!-- Filtres et actions intÃ©grÃ©s -->
  <div style="background: var(--bg-light); padding: 20px; border-radius: var(--border-radius-lg); border: 2px solid var(--border-color);">
    <form method="GET" action="/torrents" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
      <input type="hidden" name="sort" value="{{ sort_by }}">
      <input type="hidden" name="dir" value="{{ sort_dir }}">
      
      <!-- Recherche -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <label for="search" style="font-weight: 600; color: var(--text-color);">Recherche:</label>
        <input type="text" id="search" name="search" value="{{ search }}" placeholder="Nom du torrent ou ID" 
               style="padding: 10px 14px; border: 2px solid var(--border-color); border-radius: var(--border-radius); min-width: 250px; background: white;">
      </div>
      
      <button type="submit" class="btn btn-primary">ğŸ” Filtrer</button>
      <a href="/torrents" class="btn btn-secondary">ğŸ—‘ï¸ Effacer</a>
      
      <div style="height: 30px; width: 1px; background: #ddd; margin: 0 5px;"></div>
      
      <!-- Actions de synchronisation -->
      <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
        <button type="button" onclick="executeAction('/sync/smart', 'ğŸ§  Synchronisation intelligente')" class="btn btn-primary">ğŸ§  Smart</button>
        <button type="button" onclick="executeAction('/sync/fast', 'ğŸš€ Synchronisation complÃ¨te')" class="btn btn-success">ğŸš€ Complet</button>
        <button type="button" onclick="executeAction('/sync/torrents', 'ğŸ“‹ Vue d\'ensemble')" class="btn btn-warning">ğŸ“‹ Vue</button>
        <button type="button" onclick="refreshStats()" class="btn btn-warning">ğŸ“Š Stats</button>
        <button type="button" onclick="executeAction('/api/health/check_all', 'ğŸ” VÃ©rifier santÃ©')" class="btn btn-primary">ğŸ” SantÃ©</button>
        <button type="button" onclick="executeAction('/api/health/cleanup', 'ğŸ§¹ Nettoyer')" class="btn btn-danger">ğŸ§¹ Nettoyer</button>
      </div>
      
      <div style="height: 30px; width: 1px; background: #ddd; margin: 0 5px;"></div>
      
      <!-- Filtres de santÃ© -->
      <!-- <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
        <span style="font-weight: 600; color: var(--text-color);">ğŸ¥ SantÃ©:</span>
        <a href="/torrents?status=health_error" class="btn {% if status_filter == 'health_error' %}btn-warning{% else %}btn-secondary{% endif %}" 
           style="font-size: 12px; padding: 4px 8px;">
          ğŸš¨ Erreurs 503
        </a>
      </div>
      
      <div style="height: 30px; width: 1px; background: #ddd; margin: 0 5px;"></div>-->
      
      <!-- Indicateur de couverture -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-weight: 600; color: var(--text-color);">ğŸ“Š Couverture:</span>
        <div style="display: flex; align-items: center; gap: 8px; padding: 5px 10px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid var(--primary-color); border-radius: var(--border-radius); box-shadow: var(--shadow-light);">
          <div style="position: relative; width: 24px; height: 24px;">
            <svg width="24" height="24" style="transform: rotate(-90deg);">
              <circle cx="12" cy="12" r="10" fill="none" stroke="#e0e0e0" stroke-width="2"></circle>
              <circle id="coverageProgress" cx="12" cy="12" r="10" fill="none" stroke="var(--primary-color)" stroke-width="2" 
                      stroke-dasharray="62.83" stroke-dashoffset="62.83" style="transition: stroke-dashoffset 0.5s ease;"></circle>
            </svg>
          </div>
          <span id="coverageText" style="font-weight: 600; color: #1565c0;">0%</span>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Statistiques rapides -->
<div class="card">
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
    <a href="{{ url_for('torrents') }}" class="stat-item" style="text-align: center; text-decoration: none; color: inherit; transition: var(--transition); padding: 20px; border-radius: var(--border-radius-lg); background: white; box-shadow: var(--shadow-light); border-left: 4px solid var(--primary-color);">
      <div style="font-size: 2em; font-weight: 700; color: var(--primary-color); margin-bottom: 8px;">{{ total_count }}</div>
      <div style="font-size: 14px; color: var(--text-muted); font-weight: 600;">Total</div>
    </a>
    {% for status_info in available_statuses %}
    <a href="{{ url_for('torrents', status=status_info[0]) }}" class="stat-item" style="text-align: center; text-decoration: none; color: inherit; transition: var(--transition); padding: 20px; border-radius: var(--border-radius-lg); background: white; box-shadow: var(--shadow-light); border-left: 4px solid {% if status_info[0] == 'downloaded' %}var(--success-color){% elif status_info[0] == 'incomplete' %}var(--warning-color){% elif 'error' in status_info[0] %}var(--error-color){% else %}#9e9e9e{% endif %};">
      <div style="font-size: 1.8em; font-weight: 700; color: {% if status_info[0] == 'downloaded' %}var(--success-color){% elif status_info[0] == 'incomplete' %}var(--warning-color){% elif 'error' in status_info[0] %}var(--error-color){% else %}#9e9e9e{% endif %}; margin-bottom: 8px;">{{ status_info[1] }}</div>
      <div style="font-size: 13px; color: var(--text-muted); font-weight: 600;">{{ status_info[0] }}</div>
    </a>
    {% endfor %}
  </div>
</div>

<!-- Actions de sÃ©lection -->
<div id="selectionActions" style="display: none; margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: var(--border-radius); border: 1px solid #ffeaa7; animation: slideDown 0.4s ease;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <div><strong id="selectionCount">0</strong> torrents sÃ©lectionnÃ©s</div>
      <div style="display: flex; gap: 10px;">
      <button onclick="selectAllErrorTorrents()" class="btn btn-warning" title="SÃ©lectionne tous les torrents en erreur (toutes pages confondues)">ğŸ“‹ Tous les erreurs</button>
      <button onclick="selectAllHealthErrorTorrents()" class="btn btn-warning" title="SÃ©lectionne tous les torrents avec Erreur 503 (health_error)">ğŸš¨ Tous les health_error</button>
      <button onclick="clearSelection()" class="btn btn-secondary">DÃ©sÃ©lectionner</button>
      <button onclick="confirmBatchDeletion()" class="btn btn-danger">ğŸ—‘ï¸ Supprimer sÃ©lectionnÃ©s</button>
      <button onclick="confirmBatchDeletionHealthErrors()" class="btn btn-danger">ğŸ—‘ï¸ Supprimer health_errors</button>
    </div>
  </div>
</div>

<!-- Table des torrents -->
<div class="card">
  {% if torrents %}
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th style="width: 3%;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
          <th style="width: 5%;"><a href="{{ url_for('torrents', sort='id', dir='asc' if sort_by == 'id' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">ID {% if sort_by == 'id' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
          <th style="width: 35%;"><a href="{{ url_for('torrents', sort='filename', dir='asc' if sort_by == 'filename' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">Nom {% if sort_by == 'filename' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
          <th style="width: 12%;"><a href="{{ url_for('torrents', sort='status', dir='asc' if sort_by == 'status' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">Statut {% if sort_by == 'status' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
          <th style="width: 10%;"><a href="{{ url_for('torrents', sort='bytes', dir='asc' if sort_by == 'bytes' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">Taille {% if sort_by == 'bytes' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
          <th style="width: 12%;"><a href="{{ url_for('torrents', sort='added_on', dir='asc' if sort_by == 'added_on' and sort_dir == 'desc' else 'desc', status=status_filter, search=search) }}" style="text-decoration: none; color: inherit;">Date {% if sort_by == 'added_on' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
          <th style="width: 8%;">Progression</th>
          <th style="width: 16%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for torrent in torrents %}
        <tr data-torrent-id="{{ torrent.id }}">
          <td><input type="checkbox" class="torrent-checkbox" value="{{ torrent.id }}" onchange="updateSelectionActions()"></td>
          <td style="font-family: monospace;">{{ torrent.id }}</td>
          <td>
            <span onclick="copyText('{{ torrent.display_name }}')" style="cursor: copy;">
              {{ torrent.display_name[:50] + ('...' if torrent.display_name|length > 50 else '') }} ğŸ“‹
            </span>
            
            <!-- Affichage de l'erreur de santÃ© -->
            {% if torrent.health_error %}
            <div style="margin-top: 4px;">
              <span style="background: #ffebee; color: #c62828; padding: 2px 6px; border-radius: 4px; font-size: 11px; border: 1px solid #ffcdd2;" title="{{ torrent.health_error }}">
                ğŸš¨ Erreur 503 dÃ©tectÃ©e
              </span>
            </div>
            {% endif %}
            
            <!-- Affichage des autres erreurs -->
            {% if torrent.error and torrent.error != '' %}
            <div style="margin-top: 4px;">
              <span style="background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 11px; border: 1px solid #ffeaa7;" title="{{ torrent.error }}">
                âš ï¸ Erreur dÃ©tectÃ©e
              </span>
            </div>
            {% endif %}
          </td>
          <td>
            <span class="badge badge-{{ 'success' if torrent.current_status == 'downloaded' else 'danger' if 'error' in torrent.current_status else 'warning' }}">
              {{ torrent.current_status }}
            </span>
          </td>
          <td style="text-align: right; font-family: monospace;">{{ torrent.size_formatted }}</td>
          <td style="font-family: monospace;">{{ torrent.added_date }}</td>
          <td>
            {% if torrent.progress > 0 %}
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="min-width: 40px; font-weight: bold;">{{ '{:.1f}%'.format(torrent.progress) }}</span>
              <div style="flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; background: var(--primary-gradient); border-radius: 4px; width: {{ torrent.progress }}%;"></div>
              </div>
            </div>
            {% endif %}
          </td>
          <td>
            <div style="display: flex; gap: 3px; justify-content: center;">
              <button onclick="showModal('{{ torrent.id }}')" class="action-btn" title="DÃ©tails">DL</button>
              <button onclick="updateTorrent('{{ torrent.id }}')" class="action-btn" title="Mettre Ã  jour">UPD</button>
              <button onclick="checkTorrentHealth('{{ torrent.id }}')" class="action-btn" title="VÃ©rifier santÃ©">ğŸ”</button>
              <button onclick="deleteTorrent('{{ torrent.id }}')" class="action-btn" title="Supprimer">ğŸ—‘ï¸</button>
              {% if torrent.current_status in ['error', 'virus', 'dead'] %}
              <button onclick="reinsertTorrent('{{ torrent.id }}')" class="action-btn" title="RÃ©insÃ©rer">â™»ï¸</button>
              {% endif %}
              {% if torrent.current_status == 'waiting_files_selection' %}
              <button onclick="onSelectFilesButtonClick('{{ torrent.id }}', this)" class="action-btn" title="SÃ©lectionner les vidÃ©os">ğŸï¸</button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Pagination simplifiÃ©e -->
  {% if pagination.total_pages > 1 %}
  <div style="padding: 20px; border-top: 1px solid #dee2e6; background: var(--bg-light); display: flex; justify-content: space-between; align-items: center;">
    <div style="color: var(--text-muted);">{{ pagination.start_item }}-{{ pagination.end_item }} sur {{ pagination.total }}</div>
    <div style="display: flex; gap: 5px;">
      {% if pagination.has_prev %}
      <a href="{{ url_for('torrents', page=1, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-secondary">â®â®</a>
      <a href="{{ url_for('torrents', page=pagination.prev_page, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-secondary">â®</a>
      {% endif %}
      
      {% for page_num in range([1, pagination.page - 2]|max, [pagination.total_pages, pagination.page + 2]|min + 1) %}
      <a href="{{ url_for('torrents', page=page_num, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn {% if page_num == pagination.page %}btn-primary{% else %}btn-secondary{% endif %}">{{ page_num }}</a>
      {% endfor %}
      
      {% if pagination.has_next %}
      <a href="{{ url_for('torrents', page=pagination.next_page, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-secondary">â¯</a>
      <a href="{{ url_for('torrents', page=pagination.total_pages, status=status_filter, search=search, sort=sort_by, dir=sort_dir) }}" class="btn btn-secondary">â¯â¯</a>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  {% else %}
  <!-- Ã‰tat vide -->
  <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
    <div style="font-size: 4em; opacity: 0.3; margin-bottom: 20px;">ğŸ“­</div>
    {% if search or status_filter %}
    <h3>Aucun rÃ©sultat trouvÃ©</h3>
    <p>Aucun torrent ne correspond aux critÃ¨res.</p>
    <a href="/torrents" class="btn btn-primary">Voir tous</a>
    {% else %}
    <h3>Aucun torrent</h3>
    <p>Synchronisez vos torrents depuis Real-Debrid.</p>
    <a href="/sync/torrents" class="btn btn-success">â¬‡ï¸ Synchroniser</a>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Modal unifiÃ© -->
<div id="universalModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Chargement...</h3>
      <button class="close" onclick="closeModal()">&times;</button>
    </div>
    <div id="modalBody">
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 2em; animation: spin 2s linear infinite;">ğŸ”„</div>
        <div style="margin-top: 10px;">Chargement...</div>
      </div>
    </div>
  </div>
</div>

<script>
// === VARIABLES GLOBALES ===
let selectedTorrents = new Set();
let currentModal = null;

// === UTILITAIRES ===
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = message;
  document.getElementById('toast-container').appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 100);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function showLoading(show = true, message = 'Chargement...') {
  let loader = document.getElementById('global-loader');
  if (show && !loader) {
    loader = document.createElement('div');
    loader.id = 'global-loader';
    loader.innerHTML = `<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;"><div style="text-align: center;"><div style="font-size: 2em; margin-bottom: 10px;">â³</div>${message}</div></div>`;
    document.body.appendChild(loader);
  } else if (!show && loader) {
    loader.remove();
  }
}

function copyText(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => showToast('ğŸ“‹ Texte copiÃ© !', 'success'));
  } else {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showToast('ğŸ“‹ Texte copiÃ© !', 'success');
  }
}

// === ACTIONS DE SYNCHRONISATION ===
function executeAction(url, name) {
  if (!confirm(`Lancer : ${name} ?`)) return;
  
  showToast(`${name} en cours...`, 'info');
  fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        showToast(data.message || `${name} dÃ©marrÃ©e`, 'success');
        setTimeout(() => location.reload(), 5000);
      } else {
        throw new Error(data.error || 'Erreur inconnue');
      }
    })
    .catch(err => showToast(`Ã‰chec: ${err.message}`, 'error'));
}

function refreshStats() {
  if (!confirm('Corriger les statistiques ?')) return;
  showToast('Mise Ã  jour des stats...', 'info');
  fetch('/api/refresh_stats')
    .then(r => r.ok ? showToast('Stats mises Ã  jour', 'success') : Promise.reject(new Error('Erreur HTTP')))
    .then(() => setTimeout(() => location.reload(), 2000))
    .catch(err => showToast(`Erreur: ${err.message}`, 'error'));
}

// === GESTION DES TORRENTS ===
function deleteTorrent(id) {
  if (!confirm('Supprimer ce torrent ?')) return;
  
  showLoading(true, 'Suppression...');
  fetch(`/api/torrent/delete/${id}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      showLoading(false);
      if (data.success) {
        const row = document.querySelector(`tr[data-torrent-id="${id}"]`);
        if (row) {
          row.style.opacity = '0.5';
          setTimeout(() => row.remove(), 300);
        }
        showToast('âœ… Torrent supprimÃ©', 'success');
      } else {
        showToast('âŒ ' + data.error, 'error');
      }
    })
    .catch(() => {
      showLoading(false);
      showToast('âŒ Erreur rÃ©seau', 'error');
    });
}

function updateTorrent(id) {
  showLoading(true, 'Mise Ã  jour...');
  fetch(`/api/torrent/${id}`)
    .then(r => r.json())
    .then(data => {
      showLoading(false);
      if (data.success !== false) {
        showToast('âœ… DÃ©tails mis Ã  jour', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast('âŒ ' + (data.error || 'Erreur'), 'error');
      }
    })
    .catch(() => {
      showLoading(false);
      showToast('âŒ Erreur rÃ©seau', 'error');
    });
}

function reinsertTorrent(id) {
  if (!confirm('RÃ©insÃ©rer ce torrent ?')) return;
  
  showLoading(true, 'RÃ©insertion...');
  fetch(`/api/torrent/reinsert/${id}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      showLoading(false);
      if (data.success) {
        showToast('âœ… Torrent rÃ©insÃ©rÃ©', 'success');
        setTimeout(() => location.reload(), 1500);
      } else {
        showToast('âŒ ' + (data.error || 'Erreur'), 'error');
      }
    })
    .catch(() => {
      showLoading(false);
      showToast('âŒ Erreur rÃ©seau', 'error');
    });
}

function checkTorrentHealth(id) {
  if (!confirm('VÃ©rifier la santÃ© de ce torrent ?')) return;
  
  showLoading(true, 'VÃ©rification de la santÃ©...');
  fetch(`/api/health/check/${id}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      showLoading(false);
      if (data.success) {
        if (data.error_503_found) {
          showToast(`âš ï¸ ${data.message}`, 'warning');
          // Optionnel: recharger la page pour afficher l'erreur dans l'interface
          setTimeout(() => location.reload(), 2000);
        } else {
          showToast(`âœ… ${data.message}`, 'success');
        }
      } else {
        showToast('âŒ ' + (data.error || 'Erreur'), 'error');
      }
    })
    .catch(() => {
      showLoading(false);
      showToast('âŒ Erreur rÃ©seau', 'error');
    });
}

// === SÃ‰LECTION FICHIERS RD ===
function onSelectFilesButtonClick(torrentId, btn) {
  if (!confirm('SÃ©lection automatique des fichiers vidÃ©o pour ce torrent ?')) return;
  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = 'SÃ©lection en coursâ€¦';

  showLoading(true, 'SÃ©lection des fichiers...');

  fetch('/api/rd/select_files', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ torrent_id: torrentId })
  }).then(r => r.json())
    .then(res => {
      showLoading(false);
      if (res.success) {
        showToast('âœ… Fichiers sÃ©lectionnÃ©s: ' + (res.selected || []).join(', '), 'success');
        setTimeout(() => location.reload(), 1200);
      } else {
        showToast('âŒ ' + (res.error || JSON.stringify(res)), 'error');
        btn.disabled = false;
        btn.textContent = oldText;
      }
    }).catch(err => {
      showLoading(false);
      showToast('âŒ Erreur rÃ©seau: ' + err, 'error');
      btn.disabled = false;
      btn.textContent = oldText;
    });
}

// === MODAL UNIFIÃ‰ ===
function showModal(torrentId) {
  const modal = document.getElementById('universalModal');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');
  
  modal.style.display = 'block';
  title.textContent = `ğŸ”„ Torrent ${torrentId}`;
  body.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 2em; animation: spin 2s linear infinite;">ğŸ”„</div><div style="margin-top: 10px;">Chargement des fichiers...</div></div>';
  
  fetch(`/api/torrent/stream/${torrentId}`)
    .then(r => r.json())
    .then(data => {
      if (data && data.success && data.files) {
        title.textContent = `ğŸ¬ ${data.torrent_info?.filename || `Torrent ${torrentId}`}`;
        
        const selectedFiles = data.files.filter(f => f.selected === 1);
        if (selectedFiles.length > 0) {
          let html = `<h4>ğŸ¬ Fichiers vidÃ©o (${selectedFiles.length})</h4>`;
          selectedFiles.forEach((file, i) => {
            const name = file.filename || `Fichier ${i + 1}`;
            const size = file.bytes ? formatFileSize(file.bytes) : 'Taille inconnue';
            
            html += `
              <div style="background: #fafafa; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 500; color: var(--text-color); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${name}">
                    ğŸ¬ ${name.length > 55 ? name.substring(0, 52) + '...' : name}
                  </div>
                  <div style="font-size: 12px; color: var(--primary-color); margin-top: 4px;">ğŸ’¾ ${size}</div>
                </div>
                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                  ${file.streaming_link ? `<a href="${file.streaming_link}" target="_blank" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">ğŸ¬ Stream</a>` : ''}
                  ${file.download_link ? `<a href="${file.download_link}" target="_blank" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">ğŸ’¾ TÃ©lÃ©charger</a>` : ''}
                </div>
              </div>`;
          });
          body.innerHTML = html;
        } else {
          body.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--warning-color);">âš ï¸ Aucun fichier vidÃ©o principal trouvÃ©</div>';
        }
      } else {
        body.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">ğŸ“­ Aucun fichier disponible</div>';
      }
    })
    .catch(() => {
      body.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error-color);">âš ï¸ Erreur de chargement</div>';
    });
}

function closeModal() {
  const modal = document.getElementById('universalModal');
  if (modal) modal.style.display = 'none';
}

// === SÃ‰LECTION MULTIPLE ===
function toggleSelectAll(checkbox) {
  document.querySelectorAll('.torrent-checkbox').forEach(cb => {
    cb.checked = checkbox.checked;
    if (checkbox.checked) {
      selectedTorrents.add(cb.value);
    } else {
      selectedTorrents.delete(cb.value);
    }
  });
  updateSelectionActions();
}

function updateSelectionActions() {
  // Ne pas vider selectedTorrents automatiquement pour prÃ©server les sÃ©lections multi-pages
  // Synchroniser avec les checkboxes visibles de la page actuelle
  const visibleCheckboxes = document.querySelectorAll('.torrent-checkbox');
  
  // Ajouter ou retirer selon l'Ã©tat des checkboxes visibles
  visibleCheckboxes.forEach(cb => {
    if (cb.checked && !selectedTorrents.has(cb.value)) {
      selectedTorrents.add(cb.value);
    } else if (!cb.checked && selectedTorrents.has(cb.value)) {
      selectedTorrents.delete(cb.value);
    }
  });
  
  const actions = document.getElementById('selectionActions');
  const count = document.getElementById('selectionCount');
  
  if (selectedTorrents.size > 0) {
    actions.style.display = 'block';
    count.textContent = selectedTorrents.size;
  } else {
    actions.style.display = 'none';
  }
  
  // Mise Ã  jour checkbox "tout sÃ©lectionner" basÃ©e uniquement sur les checkboxes visibles
  const selectAll = document.getElementById('selectAll');
  const checked = document.querySelectorAll('.torrent-checkbox:checked').length;
  const total = document.querySelectorAll('.torrent-checkbox').length;
  
  selectAll.checked = checked === total && total > 0;
  selectAll.indeterminate = checked > 0 && checked < total;
}

function clearSelection() {
  selectedTorrents.clear();
  document.querySelectorAll('.torrent-checkbox, #selectAll').forEach(cb => {
    cb.checked = false;
    cb.indeterminate = false;
  });
  updateSelectionActions();
}

function confirmBatchDeletion() {
  if (selectedTorrents.size === 0) {
    showToast('âŒ Aucun torrent sÃ©lectionnÃ©', 'error');
    return;
  }
  
  const count = selectedTorrents.size;
  if (!confirm(`Supprimer ${count} torrent${count > 1 ? 's' : ''} ? Cette action est irrÃ©versible.`)) return;
  
  showLoading(true, `Suppression de ${count} torrents...`);
  
  fetch('/api/torrents/delete_batch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ torrent_ids: Array.from(selectedTorrents) })
  })
  .then(r => r.json())
  .then(data => {
    showLoading(false);
    if (data.success) {
      showToast(`ğŸš€ Suppression de ${data.total} torrents dÃ©marrÃ©e`, 'info');
      clearSelection();
      setTimeout(() => location.reload(), 3000);
    } else {
      showToast(`âŒ ${data.error}`, 'error');
    }
  })
  .catch(() => {
    showLoading(false);
    showToast('âŒ Erreur rÃ©seau', 'error');
  });
}

// Fonction pour sÃ©lectionner tous les torrents en erreur (toutes pages confondues)
async function selectAllErrorTorrents() {
  try {
    showLoading(true, 'RÃ©cupÃ©ration des torrents en erreur...');
    
    // Construire l'URL pour l'API dÃ©diÃ©e
    const currentUrl = new URL(window.location);
    const searchParams = new URLSearchParams();
    
    // PrÃ©server la recherche actuelle si elle existe
    if (currentUrl.searchParams.get('search')) {
      searchParams.set('search', currentUrl.searchParams.get('search'));
    }
    
    const response = await fetch(`/api/torrents/error_ids?${searchParams.toString()}`);
    
    if (!response.ok) {
      throw new Error(`Erreur HTTP: ${response.status}`);
    }
    
    const data = await response.json();
    showLoading(false);
    
    if (!data.success) {
      throw new Error(data.error || 'Erreur lors de la rÃ©cupÃ©ration');
    }
    
    if (data.count === 0) {
      showToast('â„¹ï¸ Aucun torrent en erreur trouvÃ©', 'info');
      return;
    }
    
    // Avertir l'utilisateur s'il y a beaucoup de torrents
    if (data.count > 50) {
      const confirm = window.confirm(
        `Vous Ãªtes sur le point de sÃ©lectionner ${data.count} torrents en erreur.\n\n` +
        `ÃŠtes-vous sÃ»r de vouloir continuer ?`
      );
      if (!confirm) {
        showToast('âŒ OpÃ©ration annulÃ©e', 'info');
        return;
      }
    }
    
    // DÃ©sÃ©lectionner tout d'abord
    clearSelection();
    
    // SÃ©lectionner tous les torrents en erreur trouvÃ©s
    data.torrent_ids.forEach(torrentId => {
      selectedTorrents.add(torrentId);
      
      // Si la checkbox existe sur la page actuelle, la cocher visuellement
      const currentCheckbox = document.querySelector(`.torrent-checkbox[value="${torrentId}"]`);
      if (currentCheckbox) {
        currentCheckbox.checked = true;
      }
    });
    
    // Mise Ã  jour manuelle de l'interface pour prÃ©server la sÃ©lection
    const actions = document.getElementById('selectionActions');
    const count = document.getElementById('selectionCount');
    actions.style.display = 'block';
    count.textContent = selectedTorrents.size;
    
    const message = data.count > 25 ? 
      `âœ… ${data.count} torrents en erreur sÃ©lectionnÃ©s (dÃ©passement de la pagination)` :
      `âœ… ${data.count} torrents en erreur sÃ©lectionnÃ©s`;
      
    showToast(message, 'success');
    
  } catch (error) {
    showLoading(false);
    console.error('Erreur lors de la sÃ©lection des torrents en erreur:', error);
    showToast('âŒ Erreur lors de la rÃ©cupÃ©ration des torrents en erreur', 'error');
  }
}

// Fonction pour sÃ©lectionner tous les torrents ayant health_error (Erreur 503)
async function selectAllHealthErrorTorrents() {
  try {
    showLoading(true, 'RÃ©cupÃ©ration des torrents avec Erreur 503...');

    const currentUrl = new URL(window.location);
    const searchParams = new URLSearchParams();
    if (currentUrl.searchParams.get('search')) {
      searchParams.set('search', currentUrl.searchParams.get('search'));
    }

    const response = await fetch(`/api/torrents/health_error_ids?${searchParams.toString()}`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    showLoading(false);

    if (!data.success) throw new Error(data.error || 'Erreur lors de la rÃ©cupÃ©ration');

    if (data.count === 0) {
      showToast('â„¹ï¸ Aucun torrent avec Erreur 503 trouvÃ©', 'info');
      return;
    }

    if (data.count > 50) {
      const confirmed = window.confirm(`Vous Ãªtes sur le point de sÃ©lectionner ${data.count} torrents avec Erreur 503. Continuer ?`);
      if (!confirmed) { showToast('âŒ OpÃ©ration annulÃ©e', 'info'); return; }
    }

    clearSelection();
    data.torrent_ids.forEach(id => {
      selectedTorrents.add(id);
      const cb = document.querySelector(`.torrent-checkbox[value="${id}"]`);
      if (cb) cb.checked = true;
    });

    const actions = document.getElementById('selectionActions');
    const count = document.getElementById('selectionCount');
    actions.style.display = 'block';
    count.textContent = selectedTorrents.size;

    const message = data.count > 25 ? `âœ… ${data.count} torrents avec Erreur 503 sÃ©lectionnÃ©s (dÃ©passement de la pagination)` : `âœ… ${data.count} torrents avec Erreur 503 sÃ©lectionnÃ©s`;
    showToast(message, 'success');

  } catch (err) {
    showLoading(false);
    console.error('Erreur sÃ©lection health_error:', err);
    showToast('âŒ Erreur lors de la rÃ©cupÃ©ration des torrents avec Erreur 503', 'error');
  }
}

// Fonction de confirmation et suppression adaptÃ©e aux health_error
function confirmBatchDeletionHealthErrors() {
  // Si l'utilisateur a manuellement sÃ©lectionnÃ© des torrents, supprimer ces IDs
  if (selectedTorrents.size > 0) {
    if (!confirm(`Supprimer ${selectedTorrents.size} torrent(s) sÃ©lectionnÃ©(s) ? Cette action est irrÃ©versible.`)) return;

    showLoading(true, `Suppression de ${selectedTorrents.size} torrents...`);
    fetch('/api/torrents/delete_batch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ torrent_ids: Array.from(selectedTorrents) })
    })
    .then(r => r.json())
    .then(data => {
      showLoading(false);
      if (data.success) {
        showToast(`ğŸš€ Suppression de ${data.total} torrents dÃ©marrÃ©e`, 'info');
        clearSelection();
        setTimeout(() => location.reload(), 3000);
      } else {
        showToast(`âŒ ${data.error}`, 'error');
      }
    })
    .catch(() => { showLoading(false); showToast('âŒ Erreur rÃ©seau', 'error'); });

    return;
  }

  // Sinon, supprimer l'ensemble des torrents avec health_error via l'endpoint dÃ©diÃ©
  if (!confirm('Aucun torrent sÃ©lectionnÃ© manuellement. Souhaitez-vous supprimer TOUS les torrents dÃ©tectÃ©s avec Erreur 503 ?')) return;

  showLoading(true, 'DÃ©marrage suppression des torrents avec Erreur 503...');
  fetch('/api/torrents/delete_health_errors', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(data => {
    showLoading(false);
    if (data.success) {
      showToast(`ğŸš€ Suppression de ${data.total} torrents dÃ©marrÃ©e`, 'info');
      setTimeout(() => location.reload(), 3000);
    } else {
      showToast(`âŒ ${data.error}`, 'error');
    }
  })
  .catch(() => { showLoading(false); showToast('âŒ Erreur rÃ©seau', 'error'); });
}

// === UTILITAIRES ===
function formatFileSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function initializeCoverage() {
  const coverage = {{ coverage|default(0)|tojson }};
  const text = document.getElementById('coverageText');
  const progress = document.getElementById('coverageProgress');
  
  if (text && progress) {
    text.textContent = `${coverage}%`;
    const circumference = 2 * Math.PI * 10;
    const offset = circumference - (coverage / 100) * circumference;
    
    setTimeout(() => progress.style.strokeDashoffset = offset, 100);
    
    // Couleurs selon le pourcentage
    const color = coverage >= 90 ? 'var(--success-color)' : coverage >= 70 ? 'var(--warning-color)' : 'var(--error-color)';
    progress.style.stroke = color;
    text.style.color = color;
  }
}

// === Ã‰VÃ‰NEMENTS ===
document.addEventListener('DOMContentLoaded', () => {
  selectedTorrents.clear();
  document.querySelectorAll('.torrent-checkbox, #selectAll').forEach(cb => cb.checked = false);
  document.getElementById('selectionActions').style.display = 'none';
  initializeCoverage();
});

// Fermer modal avec clic extÃ©rieur ou Escape
window.addEventListener('click', e => {
  const modal = document.getElementById('universalModal');
  if (e.target === modal) closeModal();
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// Styles CSS pour les boutons d'action
const actionBtnStyle = `
.action-btn {
  width: 32px;
  height: 32px;
  padding: 0;
  border: 1px solid var(--primary-color);
  background: transparent;
  color: var(--primary-color);
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  transition: var(--transition);
}
.action-btn:hover {
  background: var(--primary-color);
  color: white;
}
`;

// Ajouter les styles des boutons d'action
const style = document.createElement('style');
style.textContent = actionBtnStyle;
document.head.appendChild(style);
</script>

{% endblock %}