{% extends "base.html" %}

{% block title %}Settings - Redriva Web{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‚öôÔ∏è Param√®tres</h1>
    <p>Configuration de Redriva</p>
</div>

<div class="settings-container">
    <!-- Section API Configuration -->
    <div class="settings-section">
        <h2>üîë Configuration API</h2>
        <div class="setting-group">
            <label for="api-token">Token Real-Debrid</label>
            <div class="input-group">
                <input type="password" id="api-token" placeholder="Votre token API Real-Debrid">
                <button class="btn btn-secondary" onclick="toggleTokenVisibility()">üëÅÔ∏è</button>
            </div>
            <small>Token n√©cessaire pour acc√©der √† l'API Real-Debrid</small>
        </div>
        
        <div class="setting-group">
            <label for="api-base-url">URL de base API</label>
            <input type="url" id="api-base-url" value="https://api.real-debrid.com/rest/1.0" readonly>
            <small>URL de base pour les appels API Real-Debrid</small>
        </div>
    </div>

    <!-- Section Actions -->
    <div class="settings-section">
        <h2>üõ†Ô∏è Actions</h2>
        <div class="settings-actions">
            <button class="btn btn-primary" onclick="saveSettings()">üíæ Sauvegarder</button>
            <button class="btn btn-secondary" onclick="resetSettings()">üîÑ R√©initialiser</button>
            <button class="btn btn-warning" onclick="exportSettings()">üì§ Exporter</button>
            <button class="btn btn-info" onclick="importSettings()">üì• Importer</button>
            <a href="/api-test" class="btn btn-success">üß™ Test API Real-Debrid</a>
        </div>
    </div>

    <!-- Section Status -->
    <div class="settings-section">
        <h2>üìä √âtat du syst√®me</h2>
        <div class="status-grid">
            <div class="status-item">
                <span class="status-label">Version :</span>
                <span class="status-value">1.0.0-alpha</span>
            </div>
            <div class="status-item">
                <span class="status-label">Base de donn√©es :</span>
                <span class="status-value" id="db-status">‚úÖ Connect√©e</span>
            </div>
            <div class="status-item">
                <span class="status-label">API Real-Debrid :</span>
                <span class="status-value" id="api-status">‚è≥ Test en cours...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Symlink Manager :</span>
                <span class="status-value" id="symlink-status">{% if symlink_available %}‚úÖ Disponible{% else %}‚ùå Indisponible{% endif %}</span>
            </div>
        </div>
    </div>
</div>

<style>
.page-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
}

.page-header h1 {
    font-size: 2rem;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.page-header p {
    color: #6c757d;
    font-size: 1.1rem;
}

.settings-container {
    display: grid;
    gap: 2rem;
    max-width: 800px;
}

.settings-section {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.settings-section h2 {
    color: #2c3e50;
    margin-bottom: 1.5rem;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.setting-group {
    margin-bottom: 1.5rem;
}

.setting-group:last-child {
    margin-bottom: 0;
}

.setting-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #495057;
}

.setting-group input[type="text"],
.setting-group input[type="password"],
.setting-group input[type="url"],
.setting-group input[type="number"],
.setting-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 1rem;
    transition: border-color 0.3s;
}

.setting-group input:focus,
.setting-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.setting-group input[type="checkbox"] {
    margin-right: 0.5rem;
    transform: scale(1.2);
}

.input-group {
    display: flex;
    gap: 0.5rem;
}

.input-group input {
    flex: 1;
}

.input-group button {
    flex-shrink: 0;
    padding: 0.75rem;
    border: 1px solid #ced4da;
    background: #f8f9fa;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.input-group button:hover {
    background: #e9ecef;
}

.setting-group small {
    display: block;
    margin-top: 0.25rem;
    color: #6c757d;
    font-size: 0.875rem;
}

.settings-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #138496;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

.status-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 5px;
    border: 1px solid #e9ecef;
}

.status-label {
    font-weight: 500;
    color: #495057;
}

.status-value {
    font-family: monospace;
    font-weight: 600;
}

@media (max-width: 768px) {
    .settings-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .status-grid {
        grid-template-columns: 1fr;
    }
    
    .input-group {
        flex-direction: column;
    }
}
</style>

<script>
function toggleTokenVisibility() {
    const tokenInput = document.getElementById('api-token');
    const button = tokenInput.nextElementSibling;
    
    if (tokenInput.type === 'password') {
        tokenInput.type = 'text';
        button.textContent = 'üôà';
    } else {
        tokenInput.type = 'password';
        button.textContent = 'üëÅÔ∏è';
    }
}

function saveSettings() {
    const settings = {
        apiToken: document.getElementById('api-token').value
    };

    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ Param√®tres sauvegard√©s avec succ√®s', 'success');
        } else {
            showNotification('‚ùå Erreur lors de la sauvegarde: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå Erreur de connexion: ' + error.message, 'error');
    });
}

function resetSettings() {
    if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser tous les param√®tres ?')) {
        fetch('/api/settings/reset', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showNotification('‚ùå Erreur lors de la r√©initialisation: ' + data.error, 'error');
            }
        });
    }
}

function exportSettings() {
    fetch('/api/settings/export')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `redriva-settings-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showNotification('üì§ Param√®tres export√©s avec succ√®s', 'success');
        })
        .catch(error => {
            showNotification('‚ùå Erreur lors de l\'export: ' + error.message, 'error');
        });
}

function importSettings() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    fetch('/api/settings/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(settings)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            showNotification('‚ùå Erreur lors de l\'import: ' + data.error, 'error');
                        }
                    });
                } catch (error) {
                    showNotification('‚ùå Fichier de configuration invalide', 'error');
                }
            };
            reader.readAsText(file);
        }
    };
    
    input.click();
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `flash ${type}`;
    notification.textContent = message;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '1000';
    notification.style.padding = '1rem';
    notification.style.borderRadius = '5px';
    notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
    
    if (type === 'success') {
        notification.style.background = '#d4edda';
        notification.style.color = '#155724';
        notification.style.border = '1px solid #c3e6cb';
    } else if (type === 'error') {
        notification.style.background = '#f8d7da';
        notification.style.color = '#721c24';
        notification.style.border = '1px solid #f5c6cb';
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function testApiConnection() {
    const token = document.getElementById('api-token').value;
    if (!token) {
        document.getElementById('api-status').textContent = '‚ùå Token manquant';
        return;
    }
    
    document.getElementById('api-status').textContent = '‚è≥ Test en cours...';
    
    fetch('/api/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ token: token })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('api-status').textContent = '‚úÖ Connect√©';
        } else {
            document.getElementById('api-status').textContent = '‚ùå √âchec: ' + data.error;
        }
    })
    .catch(error => {
        document.getElementById('api-status').textContent = '‚ùå Erreur: ' + error.message;
    });
}

// Charger les param√®tres actuels au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                
                if (settings.apiToken) {
                    document.getElementById('api-token').value = settings.apiToken;
                    testApiConnection();
                }
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des param√®tres:', error);
        });
    
    // Test automatique de la connexion API au changement du token
    document.getElementById('api-token').addEventListener('blur', testApiConnection);
});
</script>
{% endblock %}
