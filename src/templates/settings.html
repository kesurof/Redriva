{% extends "base.html" %}

{% block title %}Settings - Redriva Web{% endblock %}

{% block content %}
<!-- Conteneur de notifications -->
<div id="toast-container" class="toast-container"></div>

<!-- En-tête avec titre dans une card -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
            ⚙️ Paramètres de Redriva
        </h2>
    </div>
    
    <!-- Navigation horizontale des onglets -->
    <div class="tabs-container">
        <nav class="tabs-nav">
            <button class="tab-btn active" onclick="showTab('general')">🏠 General</button>
            <button class="tab-btn" onclick="showTab('debrid')">🔑 Debrid</button>
            <button class="tab-btn" onclick="showTab('symlinks')">🔗 Symlinks</button>
            <button class="tab-btn" onclick="showTab('arrs')">📺 *Arrs</button>
            <button class="tab-btn" onclick="showTab('error-types')">🎛️ Types d'Erreurs</button>
            <button class="tab-btn" onclick="showTab('automatisation')">⚙️ Automatisation</button>
        </nav>
    </div>
</div>

<div class="settings-container">
    <!-- Onglet General -->
        <!-- Onglet General -->
    <div id="general" class="tab-content active">
        <!-- État du système -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                📊 État du système
            </h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Version :</span>
                    <span class="status-value">1.0.0-alpha</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Base de données :</span>
                    <span class="status-value" id="db-status">✅ Connectée</span>
                </div>
                <div class="status-item">
                    <span class="status-label">API Real-Debrid :</span>
                    <span class="status-value" id="api-status">⏳ Test en cours...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Symlink Manager :</span>
                    <span class="status-value" id="symlink-status">{% if symlink_available %}✅ Disponible{% else %}❌ Indisponible{% endif %}</span>
                </div>
            </div>
        </div>
        <!-- Export/Import -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                💾 Sauvegarde des réglages et Mise à jour
            </h2>
            <div class="settings-actions">
                <button class="btn btn-warning" onclick="exportSettings()">📤 Exporter</button>
                <button class="btn btn-info" onclick="importSettings()">📥 Importer</button>
                <button class="btn btn-secondary" onclick="resetSettings()">🔄 Réinitialiser</button>
                <button class="btn btn-primary" onclick="checkUpdates()">🔍 Vérification MAJ</button>
                <button class="btn btn-secondary" onclick="downloadUpdates()" id="update-btn" style="display:none;">📥 Télécharger</button>
        </div>
    </div>
 </div>

    <!-- Onglet Debrid -->
    <div id="debrid" class="tab-content">
        <!-- Conteneur grid pour les éléments Debrid -->
        <div class="debrid-grid">
            <!-- Configuration API -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    🔑 Configuration API
                </h2>
                <div class="setting-group">
                    <label for="api-token">Token Real-Debrid</label>
                    <div class="input-group">
                        <input type="password" id="api-token" placeholder="Votre token API Real-Debrid" value="{{ config.RD_TOKEN if config.RD_TOKEN else '' }}">
                        <button class="btn btn-secondary" onclick="toggleTokenVisibility()">👁️</button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label for="api-base-url">URL de base API</label>
                    <input type="url" id="api-base-url" value="https://api.real-debrid.com/rest/1.0" readonly>
                </div>
            </div>

            <!-- Infos du compte -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    👤 Informations du compte
                </h2>
                <div class="account-info" id="account-info">
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">Utilisateur :</span>
                            <span class="status-value" id="account-username">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Type :</span>
                            <span class="status-value" id="account-type">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Expiration :</span>
                            <span class="status-value" id="account-expiration">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Points :</span>
                            <span class="status-value" id="account-points">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Debrid -->
        <div class="card">
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveDebridSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet Symlinks -->
    <div id="symlinks" class="tab-content">

        <!-- Configuration système -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                📁 Configuration système
            </h2>
            
            <div class="setting-group">
                <label for="symlink-media-path">Chemin des médias</label>
                <input type="text" id="symlink-media-path" placeholder="Exemple: /app/medias ou /mnt/medias" value="">
                <small>Répertoire racine où seront créés les liens symboliques</small>
            </div>

            <div class="setting-group">
                <label for="symlink-workers">Nombre de workers</label>
                <input type="number" id="symlink-workers" min="1" max="16" value="4">
                <small>Nombre de processus parallèles pour la gestion des symlinks</small>
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveSymlinkSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet *Arrs -->
    <div id="arrs" class="tab-content">
        <!-- Conteneur grid pour les services *Arrs -->
        <div class="arrs-grid">
            <!-- Sonarr -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    📺 Sonarr
                </h2>
                
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="sonarr-enabled" {% if config.sonarr.enabled %}checked{% endif %}> Activer Sonarr
                    </label>
                </div>

                <div class="setting-group">
                    <label for="sonarr-url">URL Sonarr</label>
                    <input type="url" id="sonarr-url" placeholder="http://localhost:8989" value="{{ config.sonarr.url or '' }}">
                    <small>URL de votre instance Sonarr</small>
                </div>

                <div class="setting-group">
                    <label for="sonarr-api">API Key Sonarr</label>
                    <div class="input-group">
                        <input type="password" id="sonarr-api" placeholder="Votre clé API Sonarr" value="{{ config.sonarr.api_key or '' }}">
                        <button class="btn btn-secondary" onclick="toggleApiVisibility('sonarr-api')">👁️</button>
                    </div>
                    <small>Clé API pour communiquer avec Sonarr</small>
                </div>
            </div>

            <!-- Radarr -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    🎬 Radarr
                </h2>
                
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="radarr-enabled" {% if config.radarr.enabled %}checked{% endif %}> Activer Radarr
                    </label>
                </div>

                <div class="setting-group">
                    <label for="radarr-url">URL Radarr</label>
                    <input type="url" id="radarr-url" placeholder="http://localhost:7878" value="{{ config.radarr.url or '' }}">
                    <small>URL de votre instance Radarr</small>
                </div>

                <div class="setting-group">
                    <label for="radarr-api">API Key Radarr</label>
                    <div class="input-group">
                        <input type="password" id="radarr-api" placeholder="Votre clé API Radarr" value="{{ config.radarr.api_key or '' }}">
                        <button class="btn btn-secondary" onclick="toggleApiVisibility('radarr-api')">👁️</button>
                    </div>
                    <small>Clé API pour communiquer avec Radarr</small>
                </div>
            </div>
        </div>

        <!-- Actions *Arrs -->
        <div class="card">
            <div class="settings-actions">
                <button class="btn btn-secondary" onclick="detectSymlinkServices()">🔍 Auto-détecter les services</button>
                <button class="btn btn-success" onclick="testArrsConnections()">🧪 Tester les connexions</button>
                <button class="btn btn-primary" onclick="saveArrsSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet Types d'Erreurs -->
    <div id="error-types" class="tab-content">
        <!-- Statistiques -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                📊 Statistiques des Types d'Erreurs
            </h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="error-total-types">0</span>
                    <span class="stat-label">Types Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="error-enabled-types">0</span>
                    <span class="stat-label">Activés</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="error-detections-today">0</span>
                    <span class="stat-label">Détections Aujourd'hui</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="error-auto-correct-types">0</span>
                    <span class="stat-label">Auto-Corrections</span>
                </div>
            </div>
        </div>

        <!-- Gestion et Test - Côte à côte -->
        <div class="management-test-grid">
            <!-- Filtres et actions -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    🔍 Gestion des Types
                </h2>
                <div class="filters-actions-grid">
                    <div class="filter-section">
                        <div class="setting-group">
                            <label for="error-filter-status">Statut:</label>
                            <select id="error-filter-status" onchange="filterErrorTypes()">
                                <option value="">Tous</option>
                                <option value="enabled">Activés</option>
                                <option value="disabled">Désactivés</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label for="error-filter-severity">Sévérité:</label>
                            <select id="error-filter-severity" onchange="filterErrorTypes()">
                                <option value="">Toutes</option>
                                <option value="low">Faible</option>
                                <option value="medium">Moyenne</option>
                                <option value="high">Haute</option>
                                <option value="critical">Critique</option>
                            </select>
                        </div>
                    </div>
                    <div class="actions-section">
                        <button class="btn btn-primary" onclick="createNewErrorType()">
                            ➕ Nouveau Type
                        </button>
                        <button class="btn btn-secondary" onclick="exportErrorConfig()">
                            📤 Exporter
                        </button>
                        <button class="btn btn-secondary" onclick="importErrorConfig()">
                            📥 Importer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Test de détection -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    🧪 Test de Détection
                </h2>
                <div class="setting-group">
                    <label for="error-test-message">Message d'erreur à tester:</label>
                    <textarea id="error-test-message" placeholder="Entrez un message d'erreur pour tester la détection..." rows="3"></textarea>
                    <button class="btn btn-primary" onclick="testErrorDetection()" style="margin-top: 8px;">
                        🔍 Tester la Détection
                    </button>
                </div>
            </div>
        </div>

        <!-- Liste des types d'erreurs -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                🎛️ Configuration des Types
            </h2>
            <div id="error-types-list" class="error-types-grid">
                <!-- Les types d'erreurs seront chargés ici -->
            </div>
        </div>

        <!-- Modal de configuration des types d'erreurs -->
        <div id="error-config-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="error-modal-title">Configuration Type d'Erreur</h3>
                    <button class="btn-close" onclick="closeErrorConfigModal()">&times;</button>
                </div>
                <div id="error-modal-body">
                    <!-- Le contenu du modal sera généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- Onglet Automatisation -->
    <div id="automatisation" class="tab-content">
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                ⚙️ Automatisation
            </h2>
            
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="auto-sync-enabled"> Synchronisation automatique
                </label>
                <small>Active la synchronisation automatique des torrents</small>
            </div>

            <div class="setting-group">
                <label for="sync-interval">Intervalle de synchronisation (minutes)</label>
                <input type="number" id="sync-interval" min="5" max="1440" value="30">
                <small>Fréquence de synchronisation automatique</small>
            </div>

            <div class="setting-group">
                <label>
                    <input type="checkbox" id="auto-cleanup-enabled"> Nettoyage automatique
                </label>
                <small>Supprime automatiquement les torrents expirés</small>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveAutomationSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>
</div>

    <!-- Onglet Debrid -->
    <div id="debrid" class="tab-content">
        <!-- Configuration API -->
        <div class="settings-section">
            <h2>🔑 Configuration API</h2>
            <div class="setting-group">
                <label for="api-token">Token Real-Debrid</label>
                <div class="input-group">
                    <input type="password" id="api-token" placeholder="Votre token API Real-Debrid">
                    <button class="btn btn-secondary" onclick="toggleTokenVisibility()">👁️</button>
                </div>
                <small>Token nécessaire pour accéder à l'API Real-Debrid</small>
            </div>
            
            <div class="setting-group">
                <label for="api-base-url">URL de base API</label>
                <input type="url" id="api-base-url" value="https://api.real-debrid.com/rest/1.0" readonly>
                <small>URL de base pour les appels API Real-Debrid</small>
            </div>
        </div>

        <!-- Infos du compte -->
        <div class="settings-section">
            <h2>� Informations du compte</h2>
            <div class="account-info" id="account-info">
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">Utilisateur :</span>
                        <span class="status-value" id="account-username">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Type :</span>
                        <span class="status-value" id="account-type">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Expiration :</span>
                        <span class="status-value" id="account-expiration">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Points :</span>
                        <span class="status-value" id="account-points">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Debrid -->
        <div class="settings-section">
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveDebridSettings()">� Sauvegarder</button>
                <a href="/api-test" class="btn btn-success">🧪 Test API Real-Debrid</a>
            </div>
        </div>
    </div>

    <!-- Onglet Symlinks -->
    <div id="symlinks" class="tab-content">
        <div class="settings-section">
            <h2>� Configuration Symlinks</h2>
            
            <div class="setting-group">
                <label for="media-path">Chemin du répertoire des médias</label>
                <input type="text" id="media-path" placeholder="/chemin/vers/medias">
                <small>Répertoire racine où seront créés les liens symboliques</small>
            </div>

            <div class="setting-group">
                <label for="workers-count">Nombre de workers</label>
                <input type="number" id="workers-count" min="1" max="10" value="3">
                <small>Nombre de processus parallèles pour la création des symlinks</small>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveSymlinkSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet *Arrs -->
    <div id="arrs" class="tab-content">
        <!-- Sonarr -->
        <div class="settings-section">
            <h2>📺 Sonarr</h2>
            
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="sonarr-enabled"> Activer Sonarr
                </label>
            </div>

            <div class="setting-group">
                <label for="sonarr-url">URL Sonarr</label>
                <input type="url" id="sonarr-url" placeholder="http://localhost:8989">
                <small>URL de votre instance Sonarr</small>
            </div>

            <div class="setting-group">
                <label for="sonarr-api">API Key Sonarr</label>
                <div class="input-group">
                    <input type="password" id="sonarr-api" placeholder="Votre clé API Sonarr">
                    <button class="btn btn-secondary" onclick="toggleApiVisibility('sonarr-api')">👁️</button>
                </div>
                <small>Clé API pour communiquer avec Sonarr</small>
            </div>
        </div>

        <!-- Radarr -->
        <div class="settings-section">
            <h2>🎬 Radarr</h2>
            
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="radarr-enabled"> Activer Radarr
                </label>
            </div>

            <div class="setting-group">
                <label for="radarr-url">URL Radarr</label>
                <input type="url" id="radarr-url" placeholder="http://localhost:7878">
                <small>URL de votre instance Radarr</small>
            </div>

            <div class="setting-group">
                <label for="radarr-api">API Key Radarr</label>
                <div class="input-group">
                    <input type="password" id="radarr-api" placeholder="Votre clé API Radarr">
                    <button class="btn btn-secondary" onclick="toggleApiVisibility('radarr-api')">👁️</button>
                </div>
                <small>Clé API pour communiquer avec Radarr</small>
            </div>
        </div>

        <!-- Actions *Arrs -->
        <div class="settings-section">
            <div class="settings-actions">
                <button class="btn btn-success" onclick="testArrsConnections()">🧪 Tester les connexions</button>
                <button class="btn btn-primary" onclick="saveArrsSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet Automatisation -->
    <div id="automatisation" class="tab-content">
        <div class="settings-section">
            <h2>⚙️ Automatisation</h2>
            
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="auto-sync-enabled"> Synchronisation automatique
                </label>
                <small>Active la synchronisation automatique des torrents</small>
            </div>

            <div class="setting-group">
                <label for="sync-interval">Intervalle de synchronisation (minutes)</label>
                <input type="number" id="sync-interval" min="5" max="1440" value="30">
                <small>Fréquence de synchronisation automatique</small>
            </div>

            <div class="setting-group">
                <label>
                    <input type="checkbox" id="auto-cleanup-enabled"> Nettoyage automatique
                </label>
                <small>Supprime automatiquement les torrents expirés</small>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveAutomationSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>
</div>

<style>
/* === VARIABLES CSS === */
:root {
  --primary-color: #2196F3;
  --primary-600: #1976D2;
  --primary-700: #1565C0;
  --primary-gradient: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
  
  --success-color: #4CAF50;
  --success-700: #388E3C;
  --success-gradient: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
  
  --warning-color: #FF9800;
  --warning-700: #e0a800;
  --warning-gradient: linear-gradient(135deg, #FF9800 0%, #e0a800 100%);
  
  --error-color: #f44336;
  --error-700: #c82333;
  --error-gradient: linear-gradient(135deg, #f44336 0%, #c82333 100%);
  
  --text-color: #333333;
  --text-muted: #6c757d;
  --bg-light: #f8f9fa;
  --border-color: #e0e0e0;
  --muted-200: #f0f2f5;
  
  --shadow-light: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-medium: 0 8px 24px rgba(0,0,0,0.12);
  
  --border-radius: 8px;
  --border-radius-lg: 12px;
  
  --transition: all 0.24s cubic-bezier(0.4,0,0.2,1);
  --focus-ring: 0 0 0 4px rgba(33,150,243,0.12);
}

/* === ANIMATIONS === */
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* === BASE STYLES === */
.card {
  background: white;
  border: none;
  border-radius: var(--border-radius-lg);
  margin-bottom: 20px;
  padding: 24px;
  box-shadow: var(--shadow-light);
  border-left: 4px solid var(--primary-color);
  transition: var(--transition);
}
.card:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 8px 16px;
  border: none;
  border-radius: var(--border-radius);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
  box-shadow: var(--shadow-light);
}
.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-medium); }

.btn-primary { background: var(--primary-gradient); color: white; }
.btn-success { background: var(--success-gradient); color: white; }
.btn-warning { background: var(--warning-gradient); color: #212529; }
.btn-danger { background: var(--error-gradient); color: white; }
.btn-secondary { background: linear-gradient(135deg, #6c757d, #5a6268); color: white; }
.btn-info { background: linear-gradient(135deg, #17a2b8, #138496); color: white; }

/* === TOAST SYSTEM === */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1002;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.toast {
  background: white;
  padding: 16px 20px;
  border-radius: var(--border-radius-lg);
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  border-left: 4px solid;
  min-width: 300px;
  transform: translateX(380px);
  opacity: 0;
  transition: var(--transition);
  color: var(--text-color);
  font-weight: 500;
}
.toast.show { transform: translateX(0); opacity: 1; }
.toast.success { border-left-color: var(--success-color); background: linear-gradient(135deg, #f1f8e9, #e8f5e8); color: #2e7d32; }
.toast.error { border-left-color: var(--error-color); background: linear-gradient(135deg, #ffebee, #fde7e7); color: #c62828; }
.toast.warning { border-left-color: var(--warning-color); background: linear-gradient(135deg, #fff8e1, #ffecb3); color: #ef6c00; }
.toast.info { border-left-color: var(--primary-color); background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1565c0; }

/* === MODAL === */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal.show {
  display: flex;
}

.modal-content {
  background: #fff;
  border-radius: var(--border-radius-lg);
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  padding: 20px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-color);
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
}

.btn-close {
  background: transparent;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-muted);
}

/* === ONGLETS === */
.tabs-container {
  margin-top: 20px;
}

.tabs-nav {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--border-color);
  overflow-x: auto;
  background: var(--bg-light);
  padding: 0 20px;
  border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
  border: 2px solid var(--border-color);
  border-bottom: none;
}

.tab-btn {
  background: transparent;
  border: none;
  padding: 16px 20px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-muted);
  border-bottom: 3px solid transparent;
  transition: var(--transition);
  white-space: nowrap;
  position: relative;
}

.tab-btn:hover {
  background: rgba(33, 150, 243, 0.05);
  color: var(--primary-color);
}

.tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: white;
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s ease-in-out;
}

.tab-content.active {
  display: block;
}

/* === SETTINGS CONTAINER === */
.settings-container {
  width: 100%;
  max-width: none;
}

/* === FORM ELEMENTS === */
.setting-group {
  margin-bottom: 20px;
}

.setting-group:last-child {
  margin-bottom: 0;
}

.setting-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-color);
  font-size: 14px;
}

.setting-group input[type="text"],
.setting-group input[type="password"],
.setting-group input[type="url"],
.setting-group input[type="number"],
.setting-group select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  font-size: 14px;
  transition: var(--transition);
  background: white;
}

.setting-group input:focus,
.setting-group select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: var(--focus-ring);
}

.setting-group input[type="checkbox"] {
  margin-right: 8px;
  transform: scale(1.2);
  accent-color: var(--primary-color);
}

.input-group {
  display: flex;
  gap: 8px;
}

.input-group input {
  flex: 1;
}

.input-group .btn {
  flex-shrink: 0;
  padding: 12px 16px;
}

.setting-group small {
  display: block;
  margin-top: 6px;
  color: var(--text-muted);
  font-size: 12px;
  line-height: 1.4;
}

.settings-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 20px;
}

/* === STATUS GRID === */
.status-grid {
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

.status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: var(--bg-light);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.status-item:hover {
  background: rgba(33, 150, 243, 0.05);
  transform: translateY(-1px);
}

.status-label {
  font-weight: 600;
  color: var(--text-color);
  font-size: 14px;
}

.status-value {
  font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
  font-weight: 600;
  font-size: 13px;
  padding: 4px 8px;
  background: white;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

/* === STATS GRID POUR SYMLINKS === */
.stats-grid {
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.stat-card {
  text-align: center;
  padding: 20px;
  border-radius: var(--border-radius-lg);
  color: white;
  border-left: 4px solid;
  background: white;
  box-shadow: var(--shadow-light);
  transition: var(--transition);
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

.stat-card h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-color);
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  margin: 0;
  font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
}

.stat-card.primary {
  border-left-color: var(--primary-color);
}
.stat-card.primary .stat-value {
  color: var(--primary-color);
}

.stat-card.success {
  border-left-color: var(--success-color);
}
.stat-card.success .stat-value {
  color: var(--success-color);
}

.stat-card.warning {
  border-left-color: var(--warning-color);
}
.stat-card.warning .stat-value {
  color: var(--warning-color);
}

.stat-card.danger {
  border-left-color: var(--error-color);
}
.stat-card.danger .stat-value {
  color: var(--error-color);
}

/* === SERVICE CONFIG === */
.service-config {
  padding: 16px;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  margin-bottom: 16px;
  background: var(--bg-light);
  transition: var(--transition);
}

.service-config:hover {
  background: rgba(33, 150, 243, 0.02);
  border-color: var(--primary-color);
}

/* === ERROR TYPES SPECIFIC STYLES === */
.stats-grid .stat-item {
  text-align: center;
  padding: 16px;
  border-radius: var(--border-radius);
  background: white;
  box-shadow: var(--shadow-light);
  border-left: 4px solid var(--primary-color);
  transition: var(--transition);
}

.stats-grid .stat-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

.stat-item .stat-value {
  display: block;
  font-size: 24px;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 4px;
  font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
}

.stat-item .stat-label {
  display: block;
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.filters-actions-grid {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 24px;
  align-items: center;
}

.management-test-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-bottom: 24px;
}

.filter-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.actions-section {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.error-types-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
  gap: 16px;
}

.error-type-item {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-lg);
  padding: 20px;
  transition: var(--transition);
  border-left: 4px solid var(--success-color);
}

.error-type-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

.error-type-item.severity-low {
  border-left-color: var(--primary-color);
}

.error-type-item.severity-medium {
  border-left-color: var(--warning-color);
}

.error-type-item.severity-high {
  border-left-color: var(--error-color);
}

.error-type-item.severity-critical {
  border-left-color: #721c24;
}

.error-type-item.disabled {
  opacity: 0.6;
  border-left-color: #6c757d;
}

.error-type-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.error-type-title {
  font-size: 16px;
  font-weight: 700;
  margin: 0;
  color: var(--text-color);
}

.error-type-badges {
  display: flex;
  gap: 4px;
}

.error-type-badges .badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.error-type-description {
  color: var(--text-muted);
  margin-bottom: 16px;
  font-size: 14px;
  line-height: 1.4;
}

.error-type-patterns {
  margin-bottom: 16px;
}

.pattern-list {
  max-height: 80px;
  overflow-y: auto;
  margin-top: 8px;
}

.pattern-item {
  background: var(--bg-light);
  padding: 6px 10px;
  border-radius: 4px;
  margin-bottom: 4px;
  font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
  font-size: 12px;
  border-left: 2px solid var(--primary-color);
}

.error-type-actions-list {
  margin-bottom: 16px;
}

.action-list {
  max-height: 80px;
  overflow-y: auto;
  margin-top: 8px;
}

.action-item {
  background: var(--bg-light);
  padding: 8px 12px;
  border-radius: 4px;
  margin-bottom: 4px;
  border-left: 3px solid var(--primary-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.action-item.disabled {
  opacity: 0.5;
  border-left-color: #6c757d;
}

.action-name {
  font-weight: 600;
  font-size: 13px;
}

.action-priority {
  font-size: 11px;
  color: var(--text-muted);
}

.error-type-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

.error-type-meta {
  font-size: 11px;
  color: var(--text-muted);
}

.error-type-buttons {
  display: flex;
  gap: 6px;
}

.error-type-buttons .btn {
  padding: 4px 8px;
  font-size: 11px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  cursor: pointer;
  color: var(--text-color);
  padding: 8px 0;
  transition: color 0.3s ease;
  margin-bottom: 0;
}

.checkbox-label:hover {
  color: var(--primary-color);
}

.checkbox-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin: 0;
  cursor: pointer;
  accent-color: var(--primary-color);
  transform: scale(1.1);
}

.checkbox-label span {
  user-select: none;
  font-size: 15px;
}

/* === STYLES SPÉCIFIQUES TYPES D'ERREURS === */
.error-type-card {
  border-left-color: var(--success-color);
}
.error-type-card.severity-medium {
  border-left-color: var(--warning-color);
}
.error-type-card.severity-high {
  border-left-color: var(--error-color);
}
.error-type-card.severity-critical {
  border-left-color: #721c24;
}
.error-type-card.disabled {
  opacity: 0.6;
  border-left-color: #6c757d;
}

.error-type-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.error-type-card .card-title {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.pattern-item-modal {
  background: var(--muted-200);
  padding: 8px 12px;
  border-radius: var(--border-radius);
  margin-bottom: 4px;
  font-family: monospace;
  font-size: 13px;
}

.form-control, .form-select {
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  transition: var(--transition);
  width: 100%;
}
.form-control:focus, .form-select:focus {
  outline: none;
  box-shadow: var(--focus-ring);
  border-color: var(--primary-color);
}

.form-label {
  display: block;
  margin-bottom: 4px;
  font-weight: 600;
  color: var(--text-color);
}

/* === LAYOUT CLASSES FOR MODAL === */
.row { 
  display: flex; 
  flex-wrap: wrap; 
  margin: -8px; 
}
.col-md-6 { 
  width: 50%; 
  padding: 8px; 
}
.col-md-4 { 
  width: 33.333%; 
  padding: 8px; 
}
.col-md-3 { 
  width: 25%; 
  padding: 8px; 
}
.mb-3 { 
  margin-bottom: 16px; 
}
.d-flex { 
  display: flex; 
}
.justify-content-between { 
  justify-content: space-between; 
}

@media (max-width: 768px) {
  .col-md-6, .col-md-4, .col-md-3 { 
    width: 100%; 
  }
}

.service-fields {
  margin-top: 16px;
  padding-left: 30px;
  border-left: 3px solid var(--border-color);
  transition: var(--transition);
}

.service-fields.active {
  border-left-color: var(--primary-color);
}

/* === ARRS GRID LAYOUT === */
.arrs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

/* Assurer que les cards dans la grille *Arrs ont la même hauteur */
.arrs-grid .card {
  margin-bottom: 0;
  height: fit-content;
}

/* === DEBRID GRID LAYOUT === */
.debrid-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

/* Assurer que les cards dans la grille Debrid ont la même hauteur */
.debrid-grid .card {
  margin-bottom: 0;
  height: fit-content;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
  .toast-container { bottom: 10px; right: 10px; left: 10px; }
  .toast { max-width: none; min-width: auto; }
  
  /* Forcer une colonne sur mobile pour les services *Arrs */
  .arrs-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  /* Forcer une colonne sur mobile pour les éléments Debrid */
  .debrid-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  /* Forcer une colonne sur mobile pour Gestion/Test */
  .management-test-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .tabs-nav {
    flex-wrap: wrap;
    padding: 0 12px;
  }
  
  .tab-btn {
    flex: 1;
    min-width: 120px;
    padding: 12px 16px;
    font-size: 13px;
  }
  
  .settings-actions {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    justify-content: center;
    padding: 12px 16px;
    font-size: 14px;
  }
  
  .status-grid {
    grid-template-columns: 1fr;
  }
  
  .input-group {
    flex-direction: column;
  }
  
  .card {
    padding: 16px;
    margin-bottom: 16px;
  }
}

@media (max-width: 480px) {
  .btn { 
    padding: 10px 12px; 
    font-size: 13px; 
  }
  
  .card { 
    padding: 12px; 
    margin-bottom: 12px; 
  }
  
  .tab-btn {
    padding: 10px 12px;
    font-size: 12px;
  }
  
  .setting-group input {
    padding: 10px;
  }
}
</style>

<script>
// === GESTION DES ONGLETS ===
function showTab(tabName) {
    // Masquer tous les contenus d'onglets
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Désactiver tous les boutons d'onglets
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Afficher l'onglet sélectionné
    document.getElementById(tabName).classList.add('active');
    
    // Activer le bouton correspondant
    event.target.classList.add('active');
}

// === FONCTIONS UTILITAIRES ===
function toggleTokenVisibility() {
    const tokenInput = document.getElementById('api-token');
    const button = tokenInput.nextElementSibling;
    
    if (tokenInput.type === 'password') {
        tokenInput.type = 'text';
        button.textContent = '🙈';
    } else {
        tokenInput.type = 'password';
        button.textContent = '👁️';
    }
}

function toggleApiVisibility(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling;
    
    if (input.type === 'password') {
        input.type = 'text';
        button.textContent = '🙈';
    } else {
        input.type = 'password';
        button.textContent = '👁️';
    }
}

function showNotification(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = message;
    document.getElementById('toast-container').appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// === FONCTIONS GENERAL ===
function checkUpdates() {
    showNotification('🔍 Vérification des mises à jour...', 'info');
    
    fetch('/api/check-updates')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.updateAvailable) {
                    showNotification('📥 Mise à jour disponible !', 'success');
                    document.getElementById('update-btn').style.display = 'inline-flex';
                } else {
                    showNotification('✅ Aucune mise à jour disponible', 'success');
                }
            } else {
                showNotification('❌ Erreur lors de la vérification: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('❌ Erreur de connexion: ' + error.message, 'error');
        });
}

function downloadUpdates() {
    if (confirm('Télécharger et installer la mise à jour ?')) {
        showNotification('📥 Téléchargement en cours...', 'info');
        
        fetch('/api/download-update', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('✅ Mise à jour téléchargée avec succès', 'success');
                } else {
                    showNotification('❌ Erreur lors du téléchargement: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('❌ Erreur de connexion: ' + error.message, 'error');
            });
    }
}

function exportSettings() {
    fetch('/api/settings/export')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `redriva-settings-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showNotification('📤 Paramètres exportés avec succès', 'success');
        })
        .catch(error => {
            showNotification('❌ Erreur lors de l\'export: ' + error.message, 'error');
        });
}

function importSettings() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    fetch('/api/settings/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(settings)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            showNotification('❌ Erreur lors de l\'import: ' + data.error, 'error');
                        }
                    });
                } catch (error) {
                    showNotification('❌ Fichier de configuration invalide', 'error');
                }
            };
            reader.readAsText(file);
        }
    };
    
    input.click();
}

function resetSettings() {
    if (confirm('Êtes-vous sûr de vouloir réinitialiser tous les paramètres ?')) {
        fetch('/api/settings/reset', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showNotification('❌ Erreur lors de la réinitialisation: ' + data.error, 'error');
            }
        });
    }
}

// === FONCTIONS DEBRID ===
function saveDebridSettings() {
    const settings = {
        apiToken: document.getElementById('api-token').value
    };

    if (!settings.apiToken.trim()) {
        showNotification('❌ Veuillez saisir un token API', 'error');
        return;
    }

    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            return response.text().then(text => {
                throw new Error(`Réponse non-JSON reçue: ${text}`);
            });
        }
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration Debrid sauvegardée', 'success');
            // Test automatique de la connexion après sauvegarde
            setTimeout(() => {
                testApiConnection();
                loadAccountInfo();
            }, 500);
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde Debrid:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function loadAccountInfo() {
    // Cette fonction est maintenant un alias vers loadAccountInfoViaProxy
    loadAccountInfoViaProxy();
}

function testApiConnection() {
    const token = document.getElementById('api-token').value;
    if (!token) {
        document.getElementById('api-status').textContent = '❌ Token manquant';
        return;
    }
    
    document.getElementById('api-status').textContent = '⏳ Test en cours...';
    
    // Utiliser d'abord l'endpoint local test-connection
    fetch('/api/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ token: token })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            return response.text().then(text => {
                throw new Error(`Réponse non-JSON: ${text}`);
            });
        }
    })
    .then(data => {
        console.log('Test API response:', data);
        if (data && data.success) {
            document.getElementById('api-status').textContent = '✅ Connecté';
            // Charger les infos du compte via proxy RD
            loadAccountInfoViaProxy();
        } else {
            document.getElementById('api-status').textContent = '❌ Échec: ' + (data.error || 'Token invalide');
        }
    })
    .catch(error => {
        console.error('Erreur test connexion:', error);
        document.getElementById('api-status').textContent = '❌ Erreur: ' + error.message;
    });
}

function loadAccountInfoViaProxy() {
    const token = document.getElementById('api-token').value;
    if (!token) return;
    
    // Essayer avec le proxy RD si disponible
    fetch('/api/proxy-rd', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            endpoint: '/user',
            method: 'GET',
            body: null
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Proxy RD indisponible: HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data && data.id) {
            document.getElementById('account-username').textContent = data.username || data.email || `User ${data.id}`;
            document.getElementById('account-type').textContent = data.type || 'Premium';
            
            // Formater la date d'expiration
            const formattedExpiration = formatExpirationDate(data.expiration);
            document.getElementById('account-expiration').textContent = formattedExpiration;
            
            document.getElementById('account-points').textContent = data.points ? data.points.toString() : '-';
        } else {
            throw new Error('Données utilisateur invalides');
        }
    })
    .catch(error => {
        console.warn('Erreur chargement infos compte via proxy:', error);
        // Fallback : remettre les valeurs par défaut
        document.getElementById('account-username').textContent = '-';
        document.getElementById('account-type').textContent = '-';
        document.getElementById('account-expiration').textContent = '-';
        document.getElementById('account-points').textContent = '-';
    });
}

// === UTILITAIRE FORMATAGE DATE ===
function formatExpirationDate(dateString) {
    if (!dateString || dateString === '-') {
        return '-';
    }
    
    try {
        // Essayer de parser la date (format ISO ou timestamp)
        let date;
        if (typeof dateString === 'number') {
            // Timestamp Unix
            date = new Date(dateString * 1000);
        } else {
            // String ISO ou autre format
            date = new Date(dateString);
        }
        
        // Vérifier si la date est valide
        if (isNaN(date.getTime())) {
            return dateString; // Retourner la valeur originale si impossible à parser
        }
        
        // Formater en français : jour mois année - heure
        const options = {
            day: 'numeric',
            month: 'long', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Europe/Paris'
        };
        
        return date.toLocaleDateString('fr-FR', options).replace(' à ', ' - ');
        
    } catch (error) {
        console.warn('Erreur formatage date expiration:', error);
        return dateString; // Retourner la valeur originale en cas d'erreur
    }
}

// === FONCTIONS SYMLINKS ===
function saveSymlinkSettings() {
    const settings = {
        mediaPath: document.getElementById('media-path').value,
        workersCount: parseInt(document.getElementById('workers-count').value)
    };

    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration Symlinks sauvegardée', 'success');
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde Symlinks:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

// === FONCTIONS SYMLINKS ===
function saveSymlinkSettings() {
    const settings = {
        symlink: {
            media_path: document.getElementById('symlink-media-path').value,
            workers: parseInt(document.getElementById('symlink-workers').value),
            sonarr_enabled: document.getElementById('symlink-sonarr-enabled').checked,
            sonarr_url: document.getElementById('symlink-sonarr-url').value,
            sonarr_api_key: document.getElementById('symlink-sonarr-api-key').value,
            radarr_enabled: document.getElementById('symlink-radarr-enabled').checked,
            radarr_url: document.getElementById('symlink-radarr-url').value,
            radarr_api_key: document.getElementById('symlink-radarr-api-key').value
        }
    };

    fetch('/api/symlink/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings.symlink)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration Symlinks sauvegardée', 'success');
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde Symlinks:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function loadSymlinkSettings() {
    // Charger la configuration symlink
    fetch('/api/symlink/config')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.config) {
                const config = data.config;
                
                // Charger les champs de configuration
                if (config.media_path) {
                    document.getElementById('symlink-media-path').value = config.media_path;
                }
                if (config.workers) {
                    document.getElementById('symlink-workers').value = config.workers;
                }
                
                // Services Sonarr
                if (config.sonarr_enabled !== undefined) {
                    document.getElementById('symlink-sonarr-enabled').checked = config.sonarr_enabled;
                    toggleSymlinkServiceFields('sonarr', config.sonarr_enabled);
                }
                if (config.sonarr_url) {
                    document.getElementById('symlink-sonarr-url').value = config.sonarr_url;
                }
                if (config.sonarr_api_key) {
                    document.getElementById('symlink-sonarr-api-key').value = config.sonarr_api_key;
                }
                
                // Services Radarr
                if (config.radarr_enabled !== undefined) {
                    document.getElementById('symlink-radarr-enabled').checked = config.radarr_enabled;
                    toggleSymlinkServiceFields('radarr', config.radarr_enabled);
                }
                if (config.radarr_url) {
                    document.getElementById('symlink-radarr-url').value = config.radarr_url;
                }
                if (config.radarr_api_key) {
                    document.getElementById('symlink-radarr-api-key').value = config.radarr_api_key;
                }
            }
        })
        .catch(error => {
            console.error('Erreur chargement config symlinks:', error);
        });
    
    // Charger les statistiques
    loadSymlinkStats();
}

function loadSymlinkStats() {
    fetch('/api/symlink/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.stats) {
                const stats = data.stats;
                
                document.getElementById('symlink-total-scans').textContent = stats.total_scans || 0;
                document.getElementById('symlink-last-scan').textContent = stats.last_scan || 'Aucun';
                document.getElementById('symlink-total-issues').textContent = stats.total_issues || 0;
                document.getElementById('symlink-broken-links').textContent = stats.broken_links || 0;
            }
        })
        .catch(error => {
            console.warn('Erreur chargement stats symlinks:', error);
            // Valeurs par défaut en cas d'erreur
            document.getElementById('symlink-total-scans').textContent = '0';
            document.getElementById('symlink-last-scan').textContent = 'Aucun';
            document.getElementById('symlink-total-issues').textContent = '0';
            document.getElementById('symlink-broken-links').textContent = '0';
        });
}

function toggleSymlinkServiceFields(service, enabled) {
    const fieldsContainer = document.getElementById(`symlink-${service}-fields`);
    if (fieldsContainer) {
        fieldsContainer.style.display = enabled ? 'block' : 'none';
        if (enabled) {
            fieldsContainer.classList.add('active');
        } else {
            fieldsContainer.classList.remove('active');
        }
    }
}

function detectSymlinkServices() {
    showNotification('🔍 Détection des services en cours...', 'info');
    
    fetch('/api/symlink/services/detect', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const detected = data.detected;
            
            if (detected.sonarr) {
                document.getElementById('symlink-sonarr-url').value = detected.sonarr.url;
                document.getElementById('symlink-sonarr-enabled').checked = true;
                toggleSymlinkServiceFields('sonarr', true);
                showNotification(`📺 Sonarr détecté: ${detected.sonarr.container}`, 'success');
            }
            
            if (detected.radarr) {
                document.getElementById('symlink-radarr-url').value = detected.radarr.url;
                document.getElementById('symlink-radarr-enabled').checked = true;
                toggleSymlinkServiceFields('radarr', true);
                showNotification(`🎬 Radarr détecté: ${detected.radarr.container}`, 'success');
            }
            
            if (!detected.sonarr && !detected.radarr) {
                showNotification('ℹ️ Aucun service détecté automatiquement', 'warning');
            }
        } else {
            showNotification('❌ Erreur lors de la détection: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur détection services symlinks:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function testSymlinkServices() {
    const config = {
        sonarr_enabled: document.getElementById('symlink-sonarr-enabled').checked,
        sonarr_url: document.getElementById('symlink-sonarr-url').value,
        sonarr_api_key: document.getElementById('symlink-sonarr-api-key').value,
        radarr_enabled: document.getElementById('symlink-radarr-enabled').checked,
        radarr_url: document.getElementById('symlink-radarr-url').value,
        radarr_api_key: document.getElementById('symlink-radarr-api-key').value
    };
    
    if (!config.sonarr_enabled && !config.radarr_enabled) {
        showNotification('❌ Aucun service activé pour le test', 'warning');
        return;
    }
    
    showNotification('🧪 Test des connexions en cours...', 'info');
    
    fetch('/api/symlink/test/services', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const results = data.results;
            
            Object.entries(results).forEach(([service, result]) => {
                const type = result.success ? 'success' : 'error';
                const icon = service === 'sonarr' ? '📺' : '🎬';
                const message = `${icon} ${service.toUpperCase()}: ${result.message}`;
                showNotification(message, type);
            });
        } else {
            showNotification('❌ Erreur lors du test: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur test services symlinks:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function startSymlinkScan() {
    const mediaPath = document.getElementById('symlink-media-path').value;
    if (!mediaPath.trim()) {
        showNotification('❌ Veuillez configurer le chemin des médias avant de lancer un scan', 'warning');
        return;
    }
    
    if (confirm('Démarrer un nouveau scan des symlinks ?\n\nCela analysera tous les répertoires et liens symboliques dans le chemin configuré.')) {
        showNotification('🔍 Redirection vers le gestionnaire de symlinks...', 'info');
        
        // Rediriger vers la page symlink_tool avec l'onglet scanner actif
        setTimeout(() => {
            window.location.href = '/symlink-tool?tab=scanner';
        }, 1000);
    }
}

// === FONCTIONS *ARRS ===
function saveArrsSettings() {
    const settings = {
        sonarr: {
            enabled: document.getElementById('sonarr-enabled').checked,
            url: document.getElementById('sonarr-url').value,
            apiKey: document.getElementById('sonarr-api').value
        },
        radarr: {
            enabled: document.getElementById('radarr-enabled').checked,
            url: document.getElementById('radarr-url').value,
            apiKey: document.getElementById('radarr-api').value
        }
    };

    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration *Arrs sauvegardée', 'success');
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde *Arrs:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function testArrsConnections() {
    const sonarrEnabled = document.getElementById('sonarr-enabled').checked;
    const radarrEnabled = document.getElementById('radarr-enabled').checked;
    
    if (!sonarrEnabled && !radarrEnabled) {
        showNotification('❌ Aucun service activé pour le test', 'error');
        return;
    }
    
    // Récupérer les données actuelles des champs
    const testData = {};
    
    if (sonarrEnabled) {
        testData.sonarr = {
            enabled: true,
            url: document.getElementById('sonarr-url').value.trim(),
            apiKey: document.getElementById('sonarr-api').value.trim()
        };
    }
    
    if (radarrEnabled) {
        testData.radarr = {
            enabled: true,
            url: document.getElementById('radarr-url').value.trim(),
            apiKey: document.getElementById('radarr-api').value.trim()
        };
    }
    
    showNotification('🧪 Test des connexions en cours...', 'info');
    
    fetch('/api/arr/test-connections', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(testData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.results) {
            let messages = [];
            
            // Analyser les résultats pour chaque service
            if (data.results.sonarr) {
                const result = data.results.sonarr;
                messages.push(`📺 Sonarr: ${result.message}`);
            }
            
            if (data.results.radarr) {
                const result = data.results.radarr;
                messages.push(`🎬 Radarr: ${result.message}`);
            }
            
            // Déterminer le type de notification basé sur les résultats
            const hasFailures = Object.values(data.results).some(result => !result.success);
            const notificationType = hasFailures ? 'warning' : 'success';
            
            showNotification(messages.join('\n'), notificationType);
        } else {
            showNotification('❌ Erreur lors du test: ' + (data.message || data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur test connexions *Arrs:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

// === FONCTIONS AUTOMATISATION ===
function saveAutomationSettings() {
    const settings = {
        autoSyncEnabled: document.getElementById('auto-sync-enabled').checked,
        syncInterval: parseInt(document.getElementById('sync-interval').value),
        autoCleanupEnabled: document.getElementById('auto-cleanup-enabled').checked
    };

    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration Automatisation sauvegardée', 'success');
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde Automatisation:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

// === CHARGEMENT INITIAL ===
document.addEventListener('DOMContentLoaded', function() {
    // Gestion de l'affichage des champs de services symlinks
    document.getElementById('symlink-sonarr-enabled').addEventListener('change', function() {
        toggleSymlinkServiceFields('sonarr', this.checked);
    });
    
    document.getElementById('symlink-radarr-enabled').addEventListener('change', function() {
        toggleSymlinkServiceFields('radarr', this.checked);
    });
    
    // Vérifier si le token est déjà présent (depuis le .env)
    const initialToken = document.getElementById('api-token').value;
    if (initialToken.trim()) {
        // Token présent depuis le .env, tester automatiquement la connexion
        setTimeout(() => {
            testApiConnection();
        }, 500);
    }
    
    // Charger les paramètres symlinks
    loadSymlinkSettings();
    
    // Charger les paramètres actuels depuis l'API
    fetch('/api/settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                
                // Paramètres Debrid - ne pas écraser si déjà présent depuis .env
                if (settings.apiToken && !initialToken.trim()) {
                    document.getElementById('api-token').value = settings.apiToken;
                    testApiConnection();
                }
                
                // Paramètres *Arrs - ne pas écraser si déjà pré-remplis
                if (settings.sonarr) {
                    // Ne remplir que si les champs sont vides
                    if (!document.getElementById('sonarr-enabled').checked && settings.sonarr.enabled) {
                        document.getElementById('sonarr-enabled').checked = settings.sonarr.enabled;
                    }
                    if (!document.getElementById('sonarr-url').value && settings.sonarr.url) {
                        document.getElementById('sonarr-url').value = settings.sonarr.url;
                    }
                    if (!document.getElementById('sonarr-api').value && settings.sonarr.apiKey) {
                        document.getElementById('sonarr-api').value = settings.sonarr.apiKey;
                    }
                }
                if (settings.radarr) {
                    // Ne remplir que si les champs sont vides
                    if (!document.getElementById('radarr-enabled').checked && settings.radarr.enabled) {
                        document.getElementById('radarr-enabled').checked = settings.radarr.enabled;
                    }
                    if (!document.getElementById('radarr-url').value && settings.radarr.url) {
                        document.getElementById('radarr-url').value = settings.radarr.url;
                    }
                    if (!document.getElementById('radarr-api').value && settings.radarr.apiKey) {
                        document.getElementById('radarr-api').value = settings.radarr.apiKey;
                    }
                }
                
                // Paramètres Automatisation
                if (settings.autoSyncEnabled !== undefined) {
                    document.getElementById('auto-sync-enabled').checked = settings.autoSyncEnabled;
                }
                if (settings.syncInterval) {
                    document.getElementById('sync-interval').value = settings.syncInterval;
                }
                if (settings.autoCleanupEnabled !== undefined) {
                    document.getElementById('auto-cleanup-enabled').checked = settings.autoCleanupEnabled;
                }
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des paramètres:', error);
        });
    
    // Test automatique de la connexion API au changement du token
    document.getElementById('api-token').addEventListener('blur', testApiConnection);
});

// === GESTION DES TYPES D'ERREURS ===

// Variables globales pour les types d'erreurs
let currentErrorTypes = {};
let filteredErrorTypes = {};
let editingErrorType = null;

// Fonctions utilitaires
function showToast(message, type) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 100);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => container.removeChild(toast), 300);
    }, 3000);
}

function apiCall(url, options = {}) {
    return fetch(url, {
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        },
        ...options
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    });
}

// Chargement des données pour les types d'erreurs
function loadErrorTypes() {
    apiCall('/api/arr/error-types')
        .then(response => {
            if (response.success) {
                currentErrorTypes = response.error_types;
                filteredErrorTypes = {...currentErrorTypes};
                renderErrorTypes();
            } else {
                showToast('Erreur chargement types d\'erreurs: ' + response.error, 'error');
            }
        })
        .catch(error => {
            showToast('Erreur API: ' + error.message, 'error');
        });
}

function loadErrorStatistics() {
    apiCall('/api/arr/error-statistics')
        .then(response => {
            if (response.success) {
                const stats = response.statistics;
                document.getElementById('error-total-types').textContent = stats.total_types;
                document.getElementById('error-enabled-types').textContent = stats.enabled_types;
                document.getElementById('error-detections-today').textContent = stats.detections_today;
                
                const autoCorrectCount = Object.values(stats.by_type)
                    .filter(type => type.auto_correct && type.enabled).length;
                document.getElementById('error-auto-correct-types').textContent = autoCorrectCount;
            }
        })
        .catch(error => {
            console.error('Erreur chargement statistiques:', error);
        });
}

// Rendu de l'interface des types d'erreurs
function renderErrorTypes() {
    const container = document.getElementById('error-types-list');
    container.innerHTML = '';
    
    for (const [typeName, config] of Object.entries(filteredErrorTypes)) {
        const item = createErrorTypeItem(typeName, config);
        container.appendChild(item);
    }
}

function createErrorTypeItem(typeName, config) {
    const itemDiv = document.createElement('div');
    const severityClass = `severity-${config.severity}`;
    const disabledClass = config.enabled ? '' : 'disabled';
    
    itemDiv.className = `error-type-item ${severityClass} ${disabledClass}`;
    
    itemDiv.innerHTML = `
        <div class="error-type-header">
            <h3 class="error-type-title">${config.name}</h3>
            <div class="error-type-badges">
                <span class="badge badge-${getSeverityBadgeClass(config.severity)}">${config.severity.toUpperCase()}</span>
                <span class="badge badge-${config.enabled ? 'success' : 'secondary'}">${config.enabled ? 'Activé' : 'Désactivé'}</span>
            </div>
        </div>
        
        <p class="error-type-description">${config.description}</p>
        
        <div class="error-type-patterns">
            <strong>Patterns (${config.detection_patterns.length}):</strong>
            <div class="pattern-list">
                ${config.detection_patterns.slice(0, 3).map(pattern => 
                    `<div class="pattern-item">${pattern}</div>`
                ).join('')}
                ${config.detection_patterns.length > 3 ? 
                    `<small style="color: var(--text-muted);">... et ${config.detection_patterns.length - 3} autres</small>` : ''
                }
            </div>
        </div>
        
        <div class="error-type-actions-list">
            <strong>Actions (${config.actions.length}):</strong>
            <div class="action-list">
                ${config.actions.slice(0, 2).map(action => 
                    `<div class="action-item ${action.enabled ? '' : 'disabled'}">
                        <span class="action-name">${action.name}</span>
                        <span class="action-priority">priorité: ${action.priority}</span>
                    </div>`
                ).join('')}
                ${config.actions.length > 2 ? 
                    `<small style="color: var(--text-muted);">... et ${config.actions.length - 2} autres</small>` : ''
                }
            </div>
        </div>
        
        <div class="error-type-controls">
            <div class="error-type-meta">
                Max âge: ${config.max_age_hours}h | Intervalle: ${config.min_interval_minutes}min
            </div>
            <div class="error-type-buttons">
                <button class="btn btn-outline-primary" onclick="editErrorType('${typeName}')">
                    ✏️ Modifier
                </button>
                <button class="btn btn-${config.enabled ? 'warning' : 'success'}" onclick="toggleErrorType('${typeName}')">
                    ${config.enabled ? '⏸️ Désactiver' : '▶️ Activer'}
                </button>
            </div>
        </div>
    `;
    
    return itemDiv;
}

function getSeverityBadgeClass(severity) {
    switch(severity) {
        case 'low': return 'info';
        case 'medium': return 'warning';
        case 'high': return 'danger';
        case 'critical': return 'danger';
        default: return 'secondary';
    }
}

// Filtrage des types d'erreurs
function filterErrorTypes() {
    const statusFilter = document.getElementById('error-filter-status').value;
    const severityFilter = document.getElementById('error-filter-severity').value;
    
    filteredErrorTypes = {};
    
    for (const [typeName, config] of Object.entries(currentErrorTypes)) {
        let includeType = true;
        
        if (statusFilter) {
            if (statusFilter === 'enabled' && !config.enabled) includeType = false;
            if (statusFilter === 'disabled' && config.enabled) includeType = false;
        }
        
        if (severityFilter && config.severity !== severityFilter) {
            includeType = false;
        }
        
        if (includeType) {
            filteredErrorTypes[typeName] = config;
        }
    }
    
    renderErrorTypes();
}

// Actions sur les types d'erreurs
function toggleErrorType(typeName) {
    const config = currentErrorTypes[typeName];
    const newStatus = !config.enabled;
    
    apiCall(`/api/arr/error-types/${typeName}`, {
        method: 'PUT',
        body: JSON.stringify({
            ...config,
            enabled: newStatus
        })
    })
    .then(response => {
        if (response.success) {
            showToast(`Type d'erreur ${newStatus ? 'activé' : 'désactivé'}: ${typeName}`, 'success');
            loadErrorTypes();
            loadErrorStatistics();
        } else {
            showToast('Erreur: ' + response.error, 'error');
        }
    })
    .catch(error => {
        showToast('Erreur API: ' + error.message, 'error');
    });
}

function editErrorType(typeName) {
    editingErrorType = typeName;
    const config = currentErrorTypes[typeName];
    
    showErrorConfigModal(config, typeName);
}

function createNewErrorType() {
    editingErrorType = null;
    
    const defaultConfig = {
        name: "",
        description: "",
        enabled: true,
        detection_patterns: [],
        status_filters: [],
        severity: "medium",
        auto_correct: true,
        max_age_hours: 24,
        min_interval_minutes: 5,
        actions: [],
        conditions: {}
    };
    
    showErrorConfigModal(defaultConfig, null);
}

// Test de détection
function testErrorDetection() {
    const errorMessage = document.getElementById('error-test-message').value.trim();
    
    if (!errorMessage) {
        showToast('Entrez un message d\'erreur à tester', 'warning');
        return;
    }
    
    const testItem = {
        errorMessage: errorMessage,
        status: 'failed',
        id: 'test-123',
        title: 'Test Item'
    };
    
    apiCall('/api/arr/test-error-detection', {
        method: 'POST',
        body: JSON.stringify({test_item: testItem})
    })
    .then(response => {
        if (response.success) {
            const result = response.result;
            
            if (result.detected_error_type) {
                showToast(`Type détecté: ${result.detected_error_type} (${result.would_process ? 'sera traité' : 'ne sera pas traité'})`, 'success');
            } else {
                showToast('Aucun type d\'erreur détecté pour ce message', 'info');
            }
        } else {
            showToast('Erreur test: ' + response.error, 'error');
        }
    })
    .catch(error => {
        showToast('Erreur API: ' + error.message, 'error');
    });
}

// === GESTION DU MODAL DE CONFIGURATION ===
function showErrorConfigModal(config, typeName) {
    const modal = document.getElementById('error-config-modal');
    const modalBody = document.getElementById('error-modal-body');
    const modalTitle = document.getElementById('error-modal-title');
    
    modalTitle.textContent = typeName ? `Modifier: ${config.name}` : 'Nouveau Type d\'Erreur';
    modalBody.innerHTML = generateErrorConfigForm(config, typeName);
    // Pré-remplir les actions dans le container
    if (config.actions && Array.isArray(config.actions)) {
        try {
            // petites protections: normaliser les propriétés
            const actions = config.actions.map(a => ({
                name: a.name || a["name"] || '',
                enabled: (typeof a.enabled === 'boolean') ? a.enabled : true,
                priority: a.priority || 1,
                delay_seconds: a.delay_seconds || a.delay_seconds === 0 ? a.delay_seconds : (a.delay || 0),
                max_retries: a.max_retries || 3,
                parameters: a.parameters || a.params || {}
            }));
            // vider container (au cas où)
            const container = document.getElementById('actions-container');
            if (container) container.innerHTML = '';
            actions.forEach(act => addActionRow(act));
        } catch (e) {
            console.warn('Erreur pré-remplissage actions:', e);
        }
    }
    modal.classList.add('show');
}

function closeErrorConfigModal() {
    const modal = document.getElementById('error-config-modal');
    modal.classList.remove('show');
    editingErrorType = null;
}

function generateErrorConfigForm(config, typeName) {
    return `
        <form id="error-type-form">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nom du type:</label>
                    <input type="text" class="form-control" id="config-name" value="${config.name}" ${typeName ? 'readonly' : ''}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Sévérité:</label>
                    <select class="form-select" id="config-severity">
                        <option value="low" ${config.severity === 'low' ? 'selected' : ''}>Faible</option>
                        <option value="medium" ${config.severity === 'medium' ? 'selected' : ''}>Moyenne</option>
                        <option value="high" ${config.severity === 'high' ? 'selected' : ''}>Haute</option>
                        <option value="critical" ${config.severity === 'critical' ? 'selected' : ''}>Critique</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Description:</label>
                <textarea class="form-control" id="config-description" rows="2">${config.description}</textarea>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        <input type="checkbox" id="config-enabled" ${config.enabled ? 'checked' : ''}> Activé
                    </label>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        <input type="checkbox" id="config-auto-correct" ${config.auto_correct ? 'checked' : ''}> Auto-correction
                    </label>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Âge maximum (heures):</label>
                    <input type="number" class="form-control" id="config-max-age" value="${config.max_age_hours}" min="1" max="168">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Intervalle minimum (minutes):</label>
                    <input type="number" class="form-control" id="config-min-interval" value="${config.min_interval_minutes}" min="1" max="1440">
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Patterns de détection (un par ligne):</label>
                <textarea class="form-control" id="config-patterns" rows="4" placeholder="Exemple: qBittorrent.*stalled">${config.detection_patterns.join('\\n')}</textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Filtres de statut (séparés par des virgules):</label>
                <input type="text" class="form-control" id="config-status-filters" value="${config.status_filters.join(', ')}" placeholder="downloading, queued, failed">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Actions:</label>
                <div id="actions-container" style="margin-bottom:8px;">
                    <!-- action rows seront ajoutées dynamiquement -->
                </div>
                <div style="display:flex; gap:8px;">
                    <button type="button" class="btn btn-secondary" onclick="addActionRow()">➕ Ajouter une action</button>
                    <small style="align-self:center; color:var(--text-muted);">Réordonner et modifier priorité, délai, paramètres JSON</small>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="closeErrorConfigModal()">Annuler</button>
                <div>
                    ${typeName ? `<button type="button" class="btn btn-danger" onclick="deleteErrorType('${typeName}')">🗑️ Supprimer</button>` : ''}
                    <button type="button" class="btn btn-success" onclick="saveErrorType()">💾 Sauvegarder</button>
                </div>
            </div>
        </form>
    `;
}

// === ACTIONS EDITOR HELPERS ===
function addActionRow(action) {
    const container = document.getElementById('actions-container');
    if (!container) return;

    const idx = container.children.length;
    const a = action || {name: '', enabled: true, priority: 1, delay_seconds: 0, max_retries: 3, parameters: {}};

    const row = document.createElement('div');
    row.className = 'action-editor-row';
    row.dataset.idx = idx;
    row.innerHTML = `
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <input type="text" class="form-control action-name" placeholder="action name" value="${a.name}">
            <label style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" class="action-enabled" ${a.enabled ? 'checked' : ''}> Activé
            </label>
            <input type="number" class="form-control action-priority" style="width:90px;" min="0" value="${a.priority}" title="Priorité">
            <input type="number" class="form-control action-delay" style="width:120px;" min="0" value="${a.delay_seconds}" title="Délai (s)">
            <button type="button" class="btn btn-secondary" onclick="moveActionUp(this)">↑</button>
            <button type="button" class="btn btn-secondary" onclick="moveActionDown(this)">↓</button>
            <button type="button" class="btn btn-danger" onclick="removeActionRow(this)">✖</button>
        </div>
        <div>
            <label class="form-label">Paramètres (JSON) :</label>
            <textarea class="form-control action-params" rows="2">${JSON.stringify(a.parameters || {})}</textarea>
        </div>
    `;

    container.appendChild(row);
}

function removeActionRow(btn) {
    const row = btn.closest('.action-editor-row');
    if (row) row.parentNode.removeChild(row);
}

function moveActionUp(btn) {
    const row = btn.closest('.action-editor-row');
    if (!row) return;
    const prev = row.previousElementSibling;
    if (prev) row.parentNode.insertBefore(row, prev);
}

function moveActionDown(btn) {
    const row = btn.closest('.action-editor-row');
    if (!row) return;
    const next = row.nextElementSibling;
    if (next) row.parentNode.insertBefore(next, row);
}

function collectActionsFromForm() {
    const container = document.getElementById('actions-container');
    if (!container) return [];
    const actions = [];
    container.querySelectorAll('.action-editor-row').forEach(row => {
        const name = row.querySelector('.action-name').value.trim();
        if (!name) return; // skip empty names
        const enabled = !!row.querySelector('.action-enabled').checked;
        const priority = parseInt(row.querySelector('.action-priority').value) || 1;
        const delay_seconds = parseInt(row.querySelector('.action-delay').value) || 0;
        let params = {};
        try {
            const p = row.querySelector('.action-params').value.trim();
            params = p ? JSON.parse(p) : {};
        } catch (e) {
            // invalid JSON - ignore and set empty
            params = {};
        }

        actions.push({name, enabled, priority, delay_seconds, max_retries: 3, parameters: params});
    });
    return actions;
}

function saveErrorType() {
    const form = document.getElementById('error-type-form');
    
    const config = {
        name: document.getElementById('config-name').value,
        description: document.getElementById('config-description').value,
        enabled: document.getElementById('config-enabled').checked,
        severity: document.getElementById('config-severity').value,
        auto_correct: document.getElementById('config-auto-correct').checked,
        max_age_hours: parseInt(document.getElementById('config-max-age').value),
        min_interval_minutes: parseInt(document.getElementById('config-min-interval').value),
        detection_patterns: document.getElementById('config-patterns').value
            .split('\\n')
            .map(p => p.trim())
            .filter(p => p.length > 0),
        status_filters: document.getElementById('config-status-filters').value
            .split(',')
            .map(s => s.trim())
            .filter(s => s.length > 0),
        conditions: {},
        actions: collectActionsFromForm()
    };
    
    if (!config.name) {
        showToast('Le nom du type est requis', 'error');
        return;
    }
    
    const url = editingErrorType ? 
        `/api/arr/error-types/${editingErrorType}` : 
        '/api/arr/error-types';
    
    const method = editingErrorType ? 'PUT' : 'POST';
    
    apiCall(url, {
        method: method,
        body: JSON.stringify(config)
    })
    .then(response => {
        if (response.success) {
            showToast(response.message, 'success');
            closeErrorConfigModal();
            loadErrorTypes();
            loadErrorStatistics();
        } else {
            showToast('Erreur: ' + response.error, 'error');
        }
    })
    .catch(error => {
        showToast('Erreur API: ' + error.message, 'error');
    });
}

function deleteErrorType(typeName) {
    if (!confirm(`Êtes-vous sûr de vouloir supprimer le type d'erreur "${typeName}" ?`)) {
        return;
    }
    
    apiCall(`/api/arr/error-types/${typeName}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.success) {
            showToast(response.message, 'success');
            closeErrorConfigModal();
            loadErrorTypes();
            loadErrorStatistics();
        } else {
            showToast('Erreur: ' + response.error, 'error');
        }
    })
    .catch(error => {
        showToast('Erreur API: ' + error.message, 'error');
    });
}

// Export/Import des configurations
function exportErrorConfig() {
    const config = JSON.stringify(currentErrorTypes, null, 2);
    const blob = new Blob([config], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `redriva-error-types-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Configuration exportée', 'success');
}

function importErrorConfig() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedConfig = JSON.parse(e.target.result);
                
                if (confirm('Importer cette configuration remplacera les types d\'erreurs existants. Continuer ?')) {
                    apiCall('/api/arr/error-types/import', {
                        method: 'POST',
                        body: JSON.stringify({config: importedConfig})
                    })
                    .then(response => {
                        if (response.success) {
                            showToast('Configuration importée avec succès', 'success');
                            loadErrorTypes();
                            loadErrorStatistics();
                        } else {
                            showToast('Erreur import: ' + response.error, 'error');
                        }
                    })
                    .catch(error => {
                        showToast('Erreur API: ' + error.message, 'error');
                    });
                }
            } catch (error) {
                showToast('Fichier JSON invalide', 'error');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// Charger les données des types d'erreurs quand l'onglet est activé
function showTab(tabName) {
    // Code existant pour changer d'onglet
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    // Charger les données spécifiques à l'onglet types d'erreurs
    if (tabName === 'error-types') {
        loadErrorTypes();
        loadErrorStatistics();
    }
}

// === ÉVÉNEMENTS GLOBAUX ===
// Fermeture modal sur clic extérieur
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('error-config-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeErrorConfigModal();
            }
        });
    }
});

// Fermeture modal sur Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('error-config-modal');
        if (modal && modal.classList.contains('show')) {
            closeErrorConfigModal();
        }
    }
});
</script>
{% endblock %}
