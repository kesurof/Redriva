{% extends "base.html" %}

{% block title %}Settings - Redriva Web{% endblock %}

{% block content %}
<!-- Conteneur de notifications -->
<div id="toast-container" class="toast-container"></div>

<!-- En-tête avec titre dans une card -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
            ⚙️ Paramètres de Redriva
        </h2>
    </div>
    
    <!-- Navigation horizontale des onglets -->
    <div class="tabs-container">
        <nav class="tabs-nav">
            <button class="tab-btn active" onclick="showTab('general')">🏠 General</button>
            <button class="tab-btn" onclick="showTab('debrid')">🔑 Debrid</button>
            <button class="tab-btn" onclick="showTab('symlinks')">🔗 Symlinks</button>
            <button class="tab-btn" onclick="showTab('arrs')">📺 *Arrs</button>
            <button class="tab-btn" onclick="showTab('automatisation')">⚙️ Automatisation</button>
        </nav>
    </div>
</div>

<div class="settings-container">
    <!-- Onglet General -->
        <!-- Onglet General -->
    <div id="general" class="tab-content active">
        <!-- État du système -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                📊 État du système
            </h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Version :</span>
                    <span class="status-value">1.0.0-alpha</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Base de données :</span>
                    <span class="status-value" id="db-status">✅ Connectée</span>
                </div>
                <div class="status-item">
                    <span class="status-label">API Real-Debrid :</span>
                    <span class="status-value" id="api-status">⏳ Test en cours...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Symlink Manager :</span>
                    <span class="status-value" id="symlink-status">{% if symlink_available %}✅ Disponible{% else %}❌ Indisponible{% endif %}</span>
                </div>
            </div>
        </div>
        <!-- Export/Import -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                💾 Sauvegarde des réglages et Mise à jour
            </h2>
            <div class="settings-actions">
                <button class="btn btn-warning" onclick="exportSettings()">📤 Exporter</button>
                <button class="btn btn-info" onclick="importSettings()">📥 Importer</button>
                <button class="btn btn-secondary" onclick="resetSettings()">🔄 Réinitialiser</button>
                <button class="btn btn-primary" onclick="checkUpdates()">🔍 Vérification MAJ</button>
                <button class="btn btn-secondary" onclick="downloadUpdates()" id="update-btn" style="display:none;">📥 Télécharger</button>
        </div>
    </div>
 </div>

    <!-- Onglet Debrid -->
    <div id="debrid" class="tab-content">
        <!-- Conteneur grid pour les éléments Debrid -->
        <div class="debrid-grid">
            <!-- Configuration API -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    🔑 Configuration API
                </h2>
                <div class="setting-group">
                    <label for="api-token">Token Real-Debrid</label>
                    <div class="input-group">
                        <input type="password" id="api-token" placeholder="Votre token API Real-Debrid" value="{{ config.RD_TOKEN if config.RD_TOKEN else '' }}">
                        <button class="btn btn-secondary" onclick="toggleTokenVisibility()">👁️</button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label for="api-base-url">URL de base API</label>
                    <input type="url" id="api-base-url" value="https://api.real-debrid.com/rest/1.0" readonly>
                </div>
            </div>

            <!-- Infos du compte -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    👤 Informations du compte
                </h2>
                <div class="account-info" id="account-info">
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">Utilisateur :</span>
                            <span class="status-value" id="account-username">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Type :</span>
                            <span class="status-value" id="account-type">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Expiration :</span>
                            <span class="status-value" id="account-expiration">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Points :</span>
                            <span class="status-value" id="account-points">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Debrid -->
        <div class="card">
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveDebridSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet Symlinks -->
    <div id="symlinks" class="tab-content">

        <!-- Configuration système -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                📁 Configuration système
            </h2>
            
            <div class="setting-group">
                <label for="symlink-media-path">Chemin des médias</label>
                <input type="text" id="symlink-media-path" placeholder="Exemple: /app/medias ou /mnt/medias" value="">
                <small>Répertoire racine où seront créés les liens symboliques</small>
            </div>

            <div class="setting-group">
                <label for="symlink-workers">Nombre de workers</label>
                <input type="number" id="symlink-workers" min="1" max="16" value="4">
                <small>Nombre de processus parallèles pour la gestion des symlinks</small>
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveSymlinkSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet *Arrs -->
    <div id="arrs" class="tab-content">
        <!-- Conteneur grid pour les services *Arrs -->
        <div class="arrs-grid">
            <!-- Sonarr -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    📺 Sonarr
                </h2>
                
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="sonarr-enabled"> Activer Sonarr
                    </label>
                </div>

                <div class="setting-group">
                    <label for="sonarr-url">URL Sonarr</label>
                    <input type="url" id="sonarr-url" placeholder="http://localhost:8989">
                    <small>URL de votre instance Sonarr</small>
                </div>

                <div class="setting-group">
                    <label for="sonarr-api">API Key Sonarr</label>
                    <div class="input-group">
                        <input type="password" id="sonarr-api" placeholder="Votre clé API Sonarr">
                        <button class="btn btn-secondary" onclick="toggleApiVisibility('sonarr-api')">👁️</button>
                    </div>
                    <small>Clé API pour communiquer avec Sonarr</small>
                </div>
            </div>

            <!-- Radarr -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                    🎬 Radarr
                </h2>
                
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="radarr-enabled"> Activer Radarr
                    </label>
                </div>

                <div class="setting-group">
                    <label for="radarr-url">URL Radarr</label>
                    <input type="url" id="radarr-url" placeholder="http://localhost:7878">
                    <small>URL de votre instance Radarr</small>
                </div>

                <div class="setting-group">
                    <label for="radarr-api">API Key Radarr</label>
                    <div class="input-group">
                        <input type="password" id="radarr-api" placeholder="Votre clé API Radarr">
                        <button class="btn btn-secondary" onclick="toggleApiVisibility('radarr-api')">👁️</button>
                    </div>
                    <small>Clé API pour communiquer avec Radarr</small>
                </div>
            </div>
        </div>

        <!-- Actions *Arrs -->
        <div class="card">
            <div class="settings-actions">
                <button class="btn btn-secondary" onclick="detectSymlinkServices()">🔍 Auto-détecter les services</button>
                <button class="btn btn-success" onclick="testArrsConnections()">🧪 Tester les connexions</button>
                <button class="btn btn-primary" onclick="saveArrsSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet Automatisation -->
    <div id="automatisation" class="tab-content">
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 12px;">
                ⚙️ Automatisation
            </h2>
            
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="auto-sync-enabled"> Synchronisation automatique
                </label>
                <small>Active la synchronisation automatique des torrents</small>
            </div>

            <div class="setting-group">
                <label for="sync-interval">Intervalle de synchronisation (minutes)</label>
                <input type="number" id="sync-interval" min="5" max="1440" value="30">
                <small>Fréquence de synchronisation automatique</small>
            </div>

            <div class="setting-group">
                <label>
                    <input type="checkbox" id="auto-cleanup-enabled"> Nettoyage automatique
                </label>
                <small>Supprime automatiquement les torrents expirés</small>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveAutomationSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>
</div>

    <!-- Onglet Debrid -->
    <div id="debrid" class="tab-content">
        <!-- Configuration API -->
        <div class="settings-section">
            <h2>🔑 Configuration API</h2>
            <div class="setting-group">
                <label for="api-token">Token Real-Debrid</label>
                <div class="input-group">
                    <input type="password" id="api-token" placeholder="Votre token API Real-Debrid">
                    <button class="btn btn-secondary" onclick="toggleTokenVisibility()">👁️</button>
                </div>
                <small>Token nécessaire pour accéder à l'API Real-Debrid</small>
            </div>
            
            <div class="setting-group">
                <label for="api-base-url">URL de base API</label>
                <input type="url" id="api-base-url" value="https://api.real-debrid.com/rest/1.0" readonly>
                <small>URL de base pour les appels API Real-Debrid</small>
            </div>
        </div>

        <!-- Infos du compte -->
        <div class="settings-section">
            <h2>� Informations du compte</h2>
            <div class="account-info" id="account-info">
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">Utilisateur :</span>
                        <span class="status-value" id="account-username">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Type :</span>
                        <span class="status-value" id="account-type">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Expiration :</span>
                        <span class="status-value" id="account-expiration">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Points :</span>
                        <span class="status-value" id="account-points">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Debrid -->
        <div class="settings-section">
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveDebridSettings()">� Sauvegarder</button>
                <a href="/api-test" class="btn btn-success">🧪 Test API Real-Debrid</a>
            </div>
        </div>
    </div>

    <!-- Onglet Symlinks -->
    <div id="symlinks" class="tab-content">
        <div class="settings-section">
            <h2>� Configuration Symlinks</h2>
            
            <div class="setting-group">
                <label for="media-path">Chemin du répertoire des médias</label>
                <input type="text" id="media-path" placeholder="/chemin/vers/medias">
                <small>Répertoire racine où seront créés les liens symboliques</small>
            </div>

            <div class="setting-group">
                <label for="workers-count">Nombre de workers</label>
                <input type="number" id="workers-count" min="1" max="10" value="3">
                <small>Nombre de processus parallèles pour la création des symlinks</small>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveSymlinkSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet *Arrs -->
    <div id="arrs" class="tab-content">
        <!-- Sonarr -->
        <div class="settings-section">
            <h2>📺 Sonarr</h2>
            
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="sonarr-enabled"> Activer Sonarr
                </label>
            </div>

            <div class="setting-group">
                <label for="sonarr-url">URL Sonarr</label>
                <input type="url" id="sonarr-url" placeholder="http://localhost:8989">
                <small>URL de votre instance Sonarr</small>
            </div>

            <div class="setting-group">
                <label for="sonarr-api">API Key Sonarr</label>
                <div class="input-group">
                    <input type="password" id="sonarr-api" placeholder="Votre clé API Sonarr">
                    <button class="btn btn-secondary" onclick="toggleApiVisibility('sonarr-api')">👁️</button>
                </div>
                <small>Clé API pour communiquer avec Sonarr</small>
            </div>
        </div>

        <!-- Radarr -->
        <div class="settings-section">
            <h2>🎬 Radarr</h2>
            
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="radarr-enabled"> Activer Radarr
                </label>
            </div>

            <div class="setting-group">
                <label for="radarr-url">URL Radarr</label>
                <input type="url" id="radarr-url" placeholder="http://localhost:7878">
                <small>URL de votre instance Radarr</small>
            </div>

            <div class="setting-group">
                <label for="radarr-api">API Key Radarr</label>
                <div class="input-group">
                    <input type="password" id="radarr-api" placeholder="Votre clé API Radarr">
                    <button class="btn btn-secondary" onclick="toggleApiVisibility('radarr-api')">👁️</button>
                </div>
                <small>Clé API pour communiquer avec Radarr</small>
            </div>
        </div>

        <!-- Actions *Arrs -->
        <div class="settings-section">
            <div class="settings-actions">
                <button class="btn btn-success" onclick="testArrsConnections()">🧪 Tester les connexions</button>
                <button class="btn btn-primary" onclick="saveArrsSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Onglet Automatisation -->
    <div id="automatisation" class="tab-content">
        <div class="settings-section">
            <h2>⚙️ Automatisation</h2>
            
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="auto-sync-enabled"> Synchronisation automatique
                </label>
                <small>Active la synchronisation automatique des torrents</small>
            </div>

            <div class="setting-group">
                <label for="sync-interval">Intervalle de synchronisation (minutes)</label>
                <input type="number" id="sync-interval" min="5" max="1440" value="30">
                <small>Fréquence de synchronisation automatique</small>
            </div>

            <div class="setting-group">
                <label>
                    <input type="checkbox" id="auto-cleanup-enabled"> Nettoyage automatique
                </label>
                <small>Supprime automatiquement les torrents expirés</small>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveAutomationSettings()">💾 Sauvegarder</button>
            </div>
        </div>
    </div>
</div>

<style>
/* === VARIABLES CSS === */
:root {
  --primary-color: #2196F3;
  --primary-600: #1976D2;
  --primary-700: #1565C0;
  --primary-gradient: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
  
  --success-color: #4CAF50;
  --success-700: #388E3C;
  --success-gradient: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
  
  --warning-color: #FF9800;
  --warning-700: #e0a800;
  --warning-gradient: linear-gradient(135deg, #FF9800 0%, #e0a800 100%);
  
  --error-color: #f44336;
  --error-700: #c82333;
  --error-gradient: linear-gradient(135deg, #f44336 0%, #c82333 100%);
  
  --text-color: #333333;
  --text-muted: #6c757d;
  --bg-light: #f8f9fa;
  --border-color: #e0e0e0;
  --muted-200: #f0f2f5;
  
  --shadow-light: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-medium: 0 8px 24px rgba(0,0,0,0.12);
  
  --border-radius: 8px;
  --border-radius-lg: 12px;
  
  --transition: all 0.24s cubic-bezier(0.4,0,0.2,1);
  --focus-ring: 0 0 0 4px rgba(33,150,243,0.12);
}

/* === ANIMATIONS === */
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* === BASE STYLES === */
.card {
  background: white;
  border: none;
  border-radius: var(--border-radius-lg);
  margin-bottom: 20px;
  padding: 24px;
  box-shadow: var(--shadow-light);
  border-left: 4px solid var(--primary-color);
  transition: var(--transition);
}
.card:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 8px 16px;
  border: none;
  border-radius: var(--border-radius);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
  box-shadow: var(--shadow-light);
}
.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-medium); }

.btn-primary { background: var(--primary-gradient); color: white; }
.btn-success { background: var(--success-gradient); color: white; }
.btn-warning { background: var(--warning-gradient); color: #212529; }
.btn-danger { background: var(--error-gradient); color: white; }
.btn-secondary { background: linear-gradient(135deg, #6c757d, #5a6268); color: white; }
.btn-info { background: linear-gradient(135deg, #17a2b8, #138496); color: white; }

/* === TOAST SYSTEM === */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1002;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.toast {
  background: white;
  padding: 16px 20px;
  border-radius: var(--border-radius-lg);
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  border-left: 4px solid;
  min-width: 300px;
  transform: translateX(380px);
  opacity: 0;
  transition: var(--transition);
  color: var(--text-color);
  font-weight: 500;
}
.toast.show { transform: translateX(0); opacity: 1; }
.toast.success { border-left-color: var(--success-color); background: linear-gradient(135deg, #f1f8e9, #e8f5e8); color: #2e7d32; }
.toast.error { border-left-color: var(--error-color); background: linear-gradient(135deg, #ffebee, #fde7e7); color: #c62828; }
.toast.warning { border-left-color: var(--warning-color); background: linear-gradient(135deg, #fff8e1, #ffecb3); color: #ef6c00; }
.toast.info { border-left-color: var(--primary-color); background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1565c0; }

/* === ONGLETS === */
.tabs-container {
  margin-top: 20px;
}

.tabs-nav {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--border-color);
  overflow-x: auto;
  background: var(--bg-light);
  padding: 0 20px;
  border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
  border: 2px solid var(--border-color);
  border-bottom: none;
}

.tab-btn {
  background: transparent;
  border: none;
  padding: 16px 20px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-muted);
  border-bottom: 3px solid transparent;
  transition: var(--transition);
  white-space: nowrap;
  position: relative;
}

.tab-btn:hover {
  background: rgba(33, 150, 243, 0.05);
  color: var(--primary-color);
}

.tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: white;
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s ease-in-out;
}

.tab-content.active {
  display: block;
}

/* === SETTINGS CONTAINER === */
.settings-container {
  width: 100%;
  max-width: none;
}

/* === FORM ELEMENTS === */
.setting-group {
  margin-bottom: 20px;
}

.setting-group:last-child {
  margin-bottom: 0;
}

.setting-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-color);
  font-size: 14px;
}

.setting-group input[type="text"],
.setting-group input[type="password"],
.setting-group input[type="url"],
.setting-group input[type="number"],
.setting-group select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  font-size: 14px;
  transition: var(--transition);
  background: white;
}

.setting-group input:focus,
.setting-group select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: var(--focus-ring);
}

.setting-group input[type="checkbox"] {
  margin-right: 8px;
  transform: scale(1.2);
  accent-color: var(--primary-color);
}

.input-group {
  display: flex;
  gap: 8px;
}

.input-group input {
  flex: 1;
}

.input-group .btn {
  flex-shrink: 0;
  padding: 12px 16px;
}

.setting-group small {
  display: block;
  margin-top: 6px;
  color: var(--text-muted);
  font-size: 12px;
  line-height: 1.4;
}

.settings-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 20px;
}

/* === STATUS GRID === */
.status-grid {
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

.status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: var(--bg-light);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.status-item:hover {
  background: rgba(33, 150, 243, 0.05);
  transform: translateY(-1px);
}

.status-label {
  font-weight: 600;
  color: var(--text-color);
  font-size: 14px;
}

.status-value {
  font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
  font-weight: 600;
  font-size: 13px;
  padding: 4px 8px;
  background: white;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

/* === STATS GRID POUR SYMLINKS === */
.stats-grid {
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.stat-card {
  text-align: center;
  padding: 20px;
  border-radius: var(--border-radius-lg);
  color: white;
  border-left: 4px solid;
  background: white;
  box-shadow: var(--shadow-light);
  transition: var(--transition);
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

.stat-card h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-color);
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  margin: 0;
  font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
}

.stat-card.primary {
  border-left-color: var(--primary-color);
}
.stat-card.primary .stat-value {
  color: var(--primary-color);
}

.stat-card.success {
  border-left-color: var(--success-color);
}
.stat-card.success .stat-value {
  color: var(--success-color);
}

.stat-card.warning {
  border-left-color: var(--warning-color);
}
.stat-card.warning .stat-value {
  color: var(--warning-color);
}

.stat-card.danger {
  border-left-color: var(--error-color);
}
.stat-card.danger .stat-value {
  color: var(--error-color);
}

/* === SERVICE CONFIG === */
.service-config {
  padding: 16px;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  margin-bottom: 16px;
  background: var(--bg-light);
  transition: var(--transition);
}

.service-config:hover {
  background: rgba(33, 150, 243, 0.02);
  border-color: var(--primary-color);
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  cursor: pointer;
  color: var(--text-color);
  padding: 8px 0;
  transition: color 0.3s ease;
  margin-bottom: 0;
}

.checkbox-label:hover {
  color: var(--primary-color);
}

.checkbox-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin: 0;
  cursor: pointer;
  accent-color: var(--primary-color);
  transform: scale(1.1);
}

.checkbox-label span {
  user-select: none;
  font-size: 15px;
}

.service-fields {
  margin-top: 16px;
  padding-left: 30px;
  border-left: 3px solid var(--border-color);
  transition: var(--transition);
}

.service-fields.active {
  border-left-color: var(--primary-color);
}

/* === ARRS GRID LAYOUT === */
.arrs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

/* Assurer que les cards dans la grille *Arrs ont la même hauteur */
.arrs-grid .card {
  margin-bottom: 0;
  height: fit-content;
}

/* === DEBRID GRID LAYOUT === */
.debrid-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

/* Assurer que les cards dans la grille Debrid ont la même hauteur */
.debrid-grid .card {
  margin-bottom: 0;
  height: fit-content;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
  .toast-container { bottom: 10px; right: 10px; left: 10px; }
  .toast { max-width: none; min-width: auto; }
  
  /* Forcer une colonne sur mobile pour les services *Arrs */
  .arrs-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  /* Forcer une colonne sur mobile pour les éléments Debrid */
  .debrid-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .tabs-nav {
    flex-wrap: wrap;
    padding: 0 12px;
  }
  
  .tab-btn {
    flex: 1;
    min-width: 120px;
    padding: 12px 16px;
    font-size: 13px;
  }
  
  .settings-actions {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    justify-content: center;
    padding: 12px 16px;
    font-size: 14px;
  }
  
  .status-grid {
    grid-template-columns: 1fr;
  }
  
  .input-group {
    flex-direction: column;
  }
  
  .card {
    padding: 16px;
    margin-bottom: 16px;
  }
}

@media (max-width: 480px) {
  .btn { 
    padding: 10px 12px; 
    font-size: 13px; 
  }
  
  .card { 
    padding: 12px; 
    margin-bottom: 12px; 
  }
  
  .tab-btn {
    padding: 10px 12px;
    font-size: 12px;
  }
  
  .setting-group input {
    padding: 10px;
  }
}
</style>

<script>
// === GESTION DES ONGLETS ===
function showTab(tabName) {
    // Masquer tous les contenus d'onglets
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Désactiver tous les boutons d'onglets
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Afficher l'onglet sélectionné
    document.getElementById(tabName).classList.add('active');
    
    // Activer le bouton correspondant
    event.target.classList.add('active');
}

// === FONCTIONS UTILITAIRES ===
function toggleTokenVisibility() {
    const tokenInput = document.getElementById('api-token');
    const button = tokenInput.nextElementSibling;
    
    if (tokenInput.type === 'password') {
        tokenInput.type = 'text';
        button.textContent = '🙈';
    } else {
        tokenInput.type = 'password';
        button.textContent = '👁️';
    }
}

function toggleApiVisibility(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling;
    
    if (input.type === 'password') {
        input.type = 'text';
        button.textContent = '🙈';
    } else {
        input.type = 'password';
        button.textContent = '👁️';
    }
}

function showNotification(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = message;
    document.getElementById('toast-container').appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// === FONCTIONS GENERAL ===
function checkUpdates() {
    showNotification('🔍 Vérification des mises à jour...', 'info');
    
    fetch('/api/check-updates')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.updateAvailable) {
                    showNotification('📥 Mise à jour disponible !', 'success');
                    document.getElementById('update-btn').style.display = 'inline-flex';
                } else {
                    showNotification('✅ Aucune mise à jour disponible', 'success');
                }
            } else {
                showNotification('❌ Erreur lors de la vérification: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('❌ Erreur de connexion: ' + error.message, 'error');
        });
}

function downloadUpdates() {
    if (confirm('Télécharger et installer la mise à jour ?')) {
        showNotification('📥 Téléchargement en cours...', 'info');
        
        fetch('/api/download-update', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('✅ Mise à jour téléchargée avec succès', 'success');
                } else {
                    showNotification('❌ Erreur lors du téléchargement: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('❌ Erreur de connexion: ' + error.message, 'error');
            });
    }
}

function exportSettings() {
    fetch('/api/settings/export')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `redriva-settings-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showNotification('📤 Paramètres exportés avec succès', 'success');
        })
        .catch(error => {
            showNotification('❌ Erreur lors de l\'export: ' + error.message, 'error');
        });
}

function importSettings() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    fetch('/api/settings/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(settings)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            showNotification('❌ Erreur lors de l\'import: ' + data.error, 'error');
                        }
                    });
                } catch (error) {
                    showNotification('❌ Fichier de configuration invalide', 'error');
                }
            };
            reader.readAsText(file);
        }
    };
    
    input.click();
}

function resetSettings() {
    if (confirm('Êtes-vous sûr de vouloir réinitialiser tous les paramètres ?')) {
        fetch('/api/settings/reset', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showNotification('❌ Erreur lors de la réinitialisation: ' + data.error, 'error');
            }
        });
    }
}

// === FONCTIONS DEBRID ===
function saveDebridSettings() {
    const settings = {
        apiToken: document.getElementById('api-token').value
    };

    if (!settings.apiToken.trim()) {
        showNotification('❌ Veuillez saisir un token API', 'error');
        return;
    }

    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            return response.text().then(text => {
                throw new Error(`Réponse non-JSON reçue: ${text}`);
            });
        }
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration Debrid sauvegardée', 'success');
            // Test automatique de la connexion après sauvegarde
            setTimeout(() => {
                testApiConnection();
                loadAccountInfo();
            }, 500);
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde Debrid:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function loadAccountInfo() {
    // Cette fonction est maintenant un alias vers loadAccountInfoViaProxy
    loadAccountInfoViaProxy();
}

function testApiConnection() {
    const token = document.getElementById('api-token').value;
    if (!token) {
        document.getElementById('api-status').textContent = '❌ Token manquant';
        return;
    }
    
    document.getElementById('api-status').textContent = '⏳ Test en cours...';
    
    // Utiliser d'abord l'endpoint local test-connection
    fetch('/api/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ token: token })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            return response.text().then(text => {
                throw new Error(`Réponse non-JSON: ${text}`);
            });
        }
    })
    .then(data => {
        console.log('Test API response:', data);
        if (data && data.success) {
            document.getElementById('api-status').textContent = '✅ Connecté';
            // Charger les infos du compte via proxy RD
            loadAccountInfoViaProxy();
        } else {
            document.getElementById('api-status').textContent = '❌ Échec: ' + (data.error || 'Token invalide');
        }
    })
    .catch(error => {
        console.error('Erreur test connexion:', error);
        document.getElementById('api-status').textContent = '❌ Erreur: ' + error.message;
    });
}

function loadAccountInfoViaProxy() {
    const token = document.getElementById('api-token').value;
    if (!token) return;
    
    // Essayer avec le proxy RD si disponible
    fetch('/api/proxy-rd', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            endpoint: '/user',
            method: 'GET',
            body: null
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Proxy RD indisponible: HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data && data.id) {
            document.getElementById('account-username').textContent = data.username || data.email || `User ${data.id}`;
            document.getElementById('account-type').textContent = data.type || 'Premium';
            
            // Formater la date d'expiration
            const formattedExpiration = formatExpirationDate(data.expiration);
            document.getElementById('account-expiration').textContent = formattedExpiration;
            
            document.getElementById('account-points').textContent = data.points ? data.points.toString() : '-';
        } else {
            throw new Error('Données utilisateur invalides');
        }
    })
    .catch(error => {
        console.warn('Erreur chargement infos compte via proxy:', error);
        // Fallback : remettre les valeurs par défaut
        document.getElementById('account-username').textContent = '-';
        document.getElementById('account-type').textContent = '-';
        document.getElementById('account-expiration').textContent = '-';
        document.getElementById('account-points').textContent = '-';
    });
}

// === UTILITAIRE FORMATAGE DATE ===
function formatExpirationDate(dateString) {
    if (!dateString || dateString === '-') {
        return '-';
    }
    
    try {
        // Essayer de parser la date (format ISO ou timestamp)
        let date;
        if (typeof dateString === 'number') {
            // Timestamp Unix
            date = new Date(dateString * 1000);
        } else {
            // String ISO ou autre format
            date = new Date(dateString);
        }
        
        // Vérifier si la date est valide
        if (isNaN(date.getTime())) {
            return dateString; // Retourner la valeur originale si impossible à parser
        }
        
        // Formater en français : jour mois année - heure
        const options = {
            day: 'numeric',
            month: 'long', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Europe/Paris'
        };
        
        return date.toLocaleDateString('fr-FR', options).replace(' à ', ' - ');
        
    } catch (error) {
        console.warn('Erreur formatage date expiration:', error);
        return dateString; // Retourner la valeur originale en cas d'erreur
    }
}

// === FONCTIONS SYMLINKS ===
function saveSymlinkSettings() {
    const settings = {
        mediaPath: document.getElementById('media-path').value,
        workersCount: parseInt(document.getElementById('workers-count').value)
    };

    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration Symlinks sauvegardée', 'success');
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde Symlinks:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

// === FONCTIONS SYMLINKS ===
function saveSymlinkSettings() {
    const settings = {
        symlink: {
            media_path: document.getElementById('symlink-media-path').value,
            workers: parseInt(document.getElementById('symlink-workers').value),
            sonarr_enabled: document.getElementById('symlink-sonarr-enabled').checked,
            sonarr_url: document.getElementById('symlink-sonarr-url').value,
            sonarr_api_key: document.getElementById('symlink-sonarr-api-key').value,
            radarr_enabled: document.getElementById('symlink-radarr-enabled').checked,
            radarr_url: document.getElementById('symlink-radarr-url').value,
            radarr_api_key: document.getElementById('symlink-radarr-api-key').value
        }
    };

    fetch('/api/symlink/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings.symlink)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration Symlinks sauvegardée', 'success');
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde Symlinks:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function loadSymlinkSettings() {
    // Charger la configuration symlink
    fetch('/api/symlink/config')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.config) {
                const config = data.config;
                
                // Charger les champs de configuration
                if (config.media_path) {
                    document.getElementById('symlink-media-path').value = config.media_path;
                }
                if (config.workers) {
                    document.getElementById('symlink-workers').value = config.workers;
                }
                
                // Services Sonarr
                if (config.sonarr_enabled !== undefined) {
                    document.getElementById('symlink-sonarr-enabled').checked = config.sonarr_enabled;
                    toggleSymlinkServiceFields('sonarr', config.sonarr_enabled);
                }
                if (config.sonarr_url) {
                    document.getElementById('symlink-sonarr-url').value = config.sonarr_url;
                }
                if (config.sonarr_api_key) {
                    document.getElementById('symlink-sonarr-api-key').value = config.sonarr_api_key;
                }
                
                // Services Radarr
                if (config.radarr_enabled !== undefined) {
                    document.getElementById('symlink-radarr-enabled').checked = config.radarr_enabled;
                    toggleSymlinkServiceFields('radarr', config.radarr_enabled);
                }
                if (config.radarr_url) {
                    document.getElementById('symlink-radarr-url').value = config.radarr_url;
                }
                if (config.radarr_api_key) {
                    document.getElementById('symlink-radarr-api-key').value = config.radarr_api_key;
                }
            }
        })
        .catch(error => {
            console.error('Erreur chargement config symlinks:', error);
        });
    
    // Charger les statistiques
    loadSymlinkStats();
}

function loadSymlinkStats() {
    fetch('/api/symlink/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.stats) {
                const stats = data.stats;
                
                document.getElementById('symlink-total-scans').textContent = stats.total_scans || 0;
                document.getElementById('symlink-last-scan').textContent = stats.last_scan || 'Aucun';
                document.getElementById('symlink-total-issues').textContent = stats.total_issues || 0;
                document.getElementById('symlink-broken-links').textContent = stats.broken_links || 0;
            }
        })
        .catch(error => {
            console.warn('Erreur chargement stats symlinks:', error);
            // Valeurs par défaut en cas d'erreur
            document.getElementById('symlink-total-scans').textContent = '0';
            document.getElementById('symlink-last-scan').textContent = 'Aucun';
            document.getElementById('symlink-total-issues').textContent = '0';
            document.getElementById('symlink-broken-links').textContent = '0';
        });
}

function toggleSymlinkServiceFields(service, enabled) {
    const fieldsContainer = document.getElementById(`symlink-${service}-fields`);
    if (fieldsContainer) {
        fieldsContainer.style.display = enabled ? 'block' : 'none';
        if (enabled) {
            fieldsContainer.classList.add('active');
        } else {
            fieldsContainer.classList.remove('active');
        }
    }
}

function detectSymlinkServices() {
    showNotification('🔍 Détection des services en cours...', 'info');
    
    fetch('/api/symlink/services/detect', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const detected = data.detected;
            
            if (detected.sonarr) {
                document.getElementById('symlink-sonarr-url').value = detected.sonarr.url;
                document.getElementById('symlink-sonarr-enabled').checked = true;
                toggleSymlinkServiceFields('sonarr', true);
                showNotification(`📺 Sonarr détecté: ${detected.sonarr.container}`, 'success');
            }
            
            if (detected.radarr) {
                document.getElementById('symlink-radarr-url').value = detected.radarr.url;
                document.getElementById('symlink-radarr-enabled').checked = true;
                toggleSymlinkServiceFields('radarr', true);
                showNotification(`🎬 Radarr détecté: ${detected.radarr.container}`, 'success');
            }
            
            if (!detected.sonarr && !detected.radarr) {
                showNotification('ℹ️ Aucun service détecté automatiquement', 'warning');
            }
        } else {
            showNotification('❌ Erreur lors de la détection: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur détection services symlinks:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function testSymlinkServices() {
    const config = {
        sonarr_enabled: document.getElementById('symlink-sonarr-enabled').checked,
        sonarr_url: document.getElementById('symlink-sonarr-url').value,
        sonarr_api_key: document.getElementById('symlink-sonarr-api-key').value,
        radarr_enabled: document.getElementById('symlink-radarr-enabled').checked,
        radarr_url: document.getElementById('symlink-radarr-url').value,
        radarr_api_key: document.getElementById('symlink-radarr-api-key').value
    };
    
    if (!config.sonarr_enabled && !config.radarr_enabled) {
        showNotification('❌ Aucun service activé pour le test', 'warning');
        return;
    }
    
    showNotification('🧪 Test des connexions en cours...', 'info');
    
    fetch('/api/symlink/test/services', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const results = data.results;
            
            Object.entries(results).forEach(([service, result]) => {
                const type = result.success ? 'success' : 'error';
                const icon = service === 'sonarr' ? '📺' : '🎬';
                const message = `${icon} ${service.toUpperCase()}: ${result.message}`;
                showNotification(message, type);
            });
        } else {
            showNotification('❌ Erreur lors du test: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur test services symlinks:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function startSymlinkScan() {
    const mediaPath = document.getElementById('symlink-media-path').value;
    if (!mediaPath.trim()) {
        showNotification('❌ Veuillez configurer le chemin des médias avant de lancer un scan', 'warning');
        return;
    }
    
    if (confirm('Démarrer un nouveau scan des symlinks ?\n\nCela analysera tous les répertoires et liens symboliques dans le chemin configuré.')) {
        showNotification('🔍 Redirection vers le gestionnaire de symlinks...', 'info');
        
        // Rediriger vers la page symlink_tool avec l'onglet scanner actif
        setTimeout(() => {
            window.location.href = '/symlink-tool?tab=scanner';
        }, 1000);
    }
}

// === FONCTIONS *ARRS ===
function saveArrsSettings() {
    const settings = {
        sonarr: {
            enabled: document.getElementById('sonarr-enabled').checked,
            url: document.getElementById('sonarr-url').value,
            apiKey: document.getElementById('sonarr-api').value
        },
        radarr: {
            enabled: document.getElementById('radarr-enabled').checked,
            url: document.getElementById('radarr-url').value,
            apiKey: document.getElementById('radarr-api').value
        }
    };

    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration *Arrs sauvegardée', 'success');
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde *Arrs:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

function testArrsConnections() {
    const sonarrEnabled = document.getElementById('sonarr-enabled').checked;
    const radarrEnabled = document.getElementById('radarr-enabled').checked;
    
    if (!sonarrEnabled && !radarrEnabled) {
        showNotification('❌ Aucun service activé pour le test', 'error');
        return;
    }
    
    showNotification('🧪 Test des connexions en cours...', 'info');
    
    // Pour l'instant, on simule un test réussi car l'endpoint n'existe peut-être pas encore
    setTimeout(() => {
        let results = [];
        if (sonarrEnabled) results.push('Sonarr: ✅ Connecté');
        if (radarrEnabled) results.push('Radarr: ✅ Connecté');
        
        showNotification(`✅ Tests simulés:\n${results.join('\n')}`, 'success');
    }, 1000);
}

// === FONCTIONS AUTOMATISATION ===
function saveAutomationSettings() {
    const settings = {
        autoSyncEnabled: document.getElementById('auto-sync-enabled').checked,
        syncInterval: parseInt(document.getElementById('sync-interval').value),
        autoCleanupEnabled: document.getElementById('auto-cleanup-enabled').checked
    };

    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('✅ Configuration Automatisation sauvegardée', 'success');
        } else {
            showNotification('❌ Erreur lors de la sauvegarde: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde Automatisation:', error);
        showNotification('❌ Erreur de connexion: ' + error.message, 'error');
    });
}

// === CHARGEMENT INITIAL ===
document.addEventListener('DOMContentLoaded', function() {
    // Gestion de l'affichage des champs de services symlinks
    document.getElementById('symlink-sonarr-enabled').addEventListener('change', function() {
        toggleSymlinkServiceFields('sonarr', this.checked);
    });
    
    document.getElementById('symlink-radarr-enabled').addEventListener('change', function() {
        toggleSymlinkServiceFields('radarr', this.checked);
    });
    
    // Vérifier si le token est déjà présent (depuis le .env)
    const initialToken = document.getElementById('api-token').value;
    if (initialToken.trim()) {
        // Token présent depuis le .env, tester automatiquement la connexion
        setTimeout(() => {
            testApiConnection();
        }, 500);
    }
    
    // Charger les paramètres symlinks
    loadSymlinkSettings();
    
    // Charger les paramètres actuels depuis l'API
    fetch('/api/settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                
                // Paramètres Debrid - ne pas écraser si déjà présent depuis .env
                if (settings.apiToken && !initialToken.trim()) {
                    document.getElementById('api-token').value = settings.apiToken;
                    testApiConnection();
                }
                
                // Paramètres *Arrs
                if (settings.sonarr) {
                    document.getElementById('sonarr-enabled').checked = settings.sonarr.enabled || false;
                    document.getElementById('sonarr-url').value = settings.sonarr.url || '';
                    document.getElementById('sonarr-api').value = settings.sonarr.apiKey || '';
                }
                if (settings.radarr) {
                    document.getElementById('radarr-enabled').checked = settings.radarr.enabled || false;
                    document.getElementById('radarr-url').value = settings.radarr.url || '';
                    document.getElementById('radarr-api').value = settings.radarr.apiKey || '';
                }
                
                // Paramètres Automatisation
                if (settings.autoSyncEnabled !== undefined) {
                    document.getElementById('auto-sync-enabled').checked = settings.autoSyncEnabled;
                }
                if (settings.syncInterval) {
                    document.getElementById('sync-interval').value = settings.syncInterval;
                }
                if (settings.autoCleanupEnabled !== undefined) {
                    document.getElementById('auto-cleanup-enabled').checked = settings.autoCleanupEnabled;
                }
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des paramètres:', error);
        });
    
    // Test automatique de la connexion API au changement du token
    document.getElementById('api-token').addEventListener('blur', testApiConnection);
});
</script>
{% endblock %}
