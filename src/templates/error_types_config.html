{% extends "base.html" %}

{% block title %}Configuration Types d'Erreurs - Redriva{% endblock %}

{% block content %}

<!-- Conteneur de notifications -->
<div id="toast-container" class="toast-container"></div>

<style>
/* === VARIABLES CSS === */
:root {
  --primary-color: #2196F3;
  --primary-600: #1976D2;
  --primary-700: #1565C0;
  --primary-gradient: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);

  --success-color: #4CAF50;
  --success-700: #388E3C;
  --success-gradient: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);

  --warning-color: #FF9800;
  --warning-700: #e0a800;
  --warning-gradient: linear-gradient(135deg, #FF9800 0%, #e0a800 100%);

  --error-color: #f44336;
  --error-700: #c82333;
  --error-gradient: linear-gradient(135deg, #f44336 0%, #c82333 100%);

  --text-color: #333333;
  --text-muted: #6c757d;
  --bg-light: #f8f9fa;
  --border-color: #e0e0e0;
  --muted-200: #f0f2f5;

  --shadow-light: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-medium: 0 8px 24px rgba(0,0,0,0.12);

  --border-radius: 8px;
  --border-radius-lg: 12px;

  --transition: all 0.24s cubic-bezier(0.4,0,0.2,1);
  --focus-ring: 0 0 0 4px rgba(33,150,243,0.12);
}

/* === ANIMATIONS === */
@keyframes spin { 
  from { transform: rotate(0deg); } 
  to { transform: rotate(360deg); } 
}
@keyframes slideIn { 
  from { transform: translateX(100%); opacity: 0; } 
  to { transform: translateX(0); opacity: 1; } 
}
@keyframes slideDown { 
  from { opacity: 0; transform: translateY(-10px); } 
  to { opacity: 1; transform: translateY(0); } 
}
@keyframes fadeIn { 
  from { opacity: 0; } 
  to { opacity: 1; } 
}

/* === COMPOSANTS === */
.card {
  background: #ffffff; 
  border: none; 
  border-radius: var(--border-radius-lg); 
  padding: 24px; 
  box-shadow: var(--shadow-light); 
  border-left: 4px solid var(--primary-color); 
  transition: var(--transition);
  margin-bottom: 20px;
}
.card:hover { 
  transform: translateY(-2px); 
  box-shadow: var(--shadow-medium); 
}

.btn {
  display: inline-flex; 
  align-items: center; 
  gap: 8px; 
  padding: 8px 16px; 
  border: none; 
  border-radius: var(--border-radius); 
  font-size: 13px; 
  font-weight: 600; 
  cursor: pointer; 
  transition: var(--transition); 
  box-shadow: var(--shadow-light);
}
.btn:hover { 
  transform: translateY(-1px); 
  box-shadow: var(--shadow-medium); 
}
.btn-primary { background: var(--primary-gradient); color: #fff; }
.btn-success { background: var(--success-gradient); color: #fff; }
.btn-warning { background: var(--warning-gradient); color: #212529; }
.btn-danger { background: var(--error-gradient); color: #fff; }
.btn-secondary { background: #6c757d; color: #fff; }
.btn-outline-primary { 
  background: transparent; 
  color: var(--primary-color); 
  border: 1px solid var(--primary-color); 
}
.btn-outline-primary:hover { 
  background: var(--primary-color); 
  color: #fff; 
}

.badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}
.badge-success { background: var(--success-color); color: #fff; }
.badge-secondary { background: #6c757d; color: #fff; }
.badge-danger { background: var(--error-color); color: #fff; }
.badge-warning { background: var(--warning-color); color: #212529; }
.badge-info { background: var(--primary-color); color: #fff; }

.form-control, .form-select {
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  transition: var(--transition);
  width: 100%;
}
.form-control:focus, .form-select:focus {
  outline: none;
  box-shadow: var(--focus-ring);
  border-color: var(--primary-color);
}

.form-label {
  display: block;
  margin-bottom: 4px;
  font-weight: 600;
  color: var(--text-color);
}

.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1002;
}

.toast {
  min-width: 300px;
  padding: 16px 20px;
  border-radius: var(--border-radius-lg);
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  border-left: 4px solid;
  margin-bottom: 10px;
  transform: translateX(100%);
  opacity: 0;
  transition: var(--transition);
}
.toast.show {
  transform: translateX(0);
  opacity: 1;
}
.toast.success {
  background: linear-gradient(135deg,#f1f8e9 0%,#e8f5e8 100%);
  border-left-color: var(--success-color);
  color: var(--success-700);
}
.toast.error {
  background: linear-gradient(135deg,#ffebee 0%,#fde7e7 100%);
  border-left-color: var(--error-color);
  color: var(--error-700);
}
.toast.warning {
  background: linear-gradient(135deg,#fff8e1 0%,#ffecb3 100%);
  border-left-color: var(--warning-color);
  color: var(--warning-700);
}
.toast.info {
  background: linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%);
  border-left-color: var(--primary-color);
  color: var(--primary-700);
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal.show {
  display: flex;
}

.modal-content {
  background: #fff;
  border-radius: var(--border-radius-lg);
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  padding: 20px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-color);
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
}

.btn-close {
  background: transparent;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-muted);
}

/* Styles sp√©cifiques √† la page */
.error-type-card {
  border-left-color: var(--success-color);
}
.error-type-card.severity-medium {
  border-left-color: var(--warning-color);
}
.error-type-card.severity-high {
  border-left-color: var(--error-color);
}
.error-type-card.severity-critical {
  border-left-color: #721c24;
}
.error-type-card.disabled {
  opacity: 0.6;
  border-left-color: #6c757d;
}

.action-item {
  background: var(--bg-light);
  padding: 12px;
  border-radius: var(--border-radius);
  margin-bottom: 8px;
  border-left: 3px solid var(--primary-color);
}
.action-item.disabled {
  opacity: 0.5;
  border-left-color: #6c757d;
}

.pattern-item {
  background: var(--muted-200);
  padding: 8px 12px;
  border-radius: var(--border-radius);
  margin-bottom: 4px;
  font-family: monospace;
  font-size: 13px;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
  .card { padding: 16px; }
  .btn { padding: 6px 12px; }
  .modal-content { width: 95%; height: 100vh; border-radius: 0; }
}

@media (max-width: 480px) {
  .btn { padding: 4px 8px; }
  .card { padding: 12px; }
}

/* === LAYOUT === */
.container-fluid { padding: 20px; }
.row { display: flex; flex-wrap: wrap; margin: -10px; }
.col-12 { width: 100%; padding: 10px; }
.col-md-6 { width: 50%; padding: 10px; }
.col-md-4 { width: 33.333%; padding: 10px; }
.col-md-8 { width: 66.666%; padding: 10px; }
.col-md-3 { width: 25%; padding: 10px; }

.d-flex { display: flex; }
.justify-content-between { justify-content: space-between; }
.align-items-center { align-items: center; }
.text-center { text-align: center; }
.mb-4 { margin-bottom: 24px; }
.mb-3 { margin-bottom: 16px; }
.mt-4 { margin-top: 24px; }
.w-100 { width: 100%; }

@media (max-width: 768px) {
  .col-md-6, .col-md-4, .col-md-8, .col-md-3 { width: 100%; }
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>üéõÔ∏è Configuration des Types d'Erreurs</h2>
                <div>
                    <button class="btn btn-primary" onclick="createNewErrorType()">
                        ‚ûï Nouveau Type
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportConfig()">
                        üì§ Exporter
                    </button>
                    <button class="btn btn-outline-primary" onclick="importConfig()">
                        üì• Importer
                    </button>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <h3 id="total-types" style="color: var(--primary-color); margin: 0;">0</h3>
                        <p style="margin: 8px 0 0; color: var(--text-muted);">Types Total</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <h3 id="enabled-types" style="color: var(--success-color); margin: 0;">0</h3>
                        <p style="margin: 8px 0 0; color: var(--text-muted);">Activ√©s</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <h3 id="detections-today" style="color: var(--warning-color); margin: 0;">0</h3>
                        <p style="margin: 8px 0 0; color: var(--text-muted);">D√©tections Aujourd'hui</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <h3 id="auto-correct-types" style="color: var(--error-color); margin: 0;">0</h3>
                        <p style="margin: 8px 0 0; color: var(--text-muted);">Auto-Corrections</p>
                    </div>
                </div>
            </div>

            <!-- Filtres -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <h5 style="margin-bottom: 16px;">üîç Filtres</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Statut:</label>
                                <select id="filter-status" class="form-select" onchange="filterErrorTypes()">
                                    <option value="">Tous</option>
                                    <option value="enabled">Activ√©s</option>
                                    <option value="disabled">D√©sactiv√©s</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">S√©v√©rit√©:</label>
                                <select id="filter-severity" class="form-select" onchange="filterErrorTypes()">
                                    <option value="">Toutes</option>
                                    <option value="low">Faible</option>
                                    <option value="medium">Moyenne</option>
                                    <option value="high">Haute</option>
                                    <option value="critical">Critique</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <h5 style="margin-bottom: 16px;">üß™ Test de D√©tection</h5>
                        <textarea id="test-error-message" class="form-control" placeholder="Entrez un message d'erreur pour tester la d√©tection..." rows="3"></textarea>
                        <button class="btn btn-outline-primary mt-3" onclick="testErrorDetection()" style="width: 100%;">
                            üîç Tester la D√©tection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Liste des types d'erreurs -->
            <div id="error-types-container" class="row">
                <!-- Les types d'erreurs seront charg√©s ici -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de configuration -->
<div id="config-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Configuration Type d'Erreur</h3>
            <button class="btn-close" onclick="closeConfigModal()">&times;</button>
        </div>
        <div id="modal-body">
            <!-- Le contenu du modal sera g√©n√©r√© dynamiquement -->
        </div>
    </div>
</div>

<script>
// Variables globales
let currentErrorTypes = {};
let filteredErrorTypes = {};
let editingErrorType = null;

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    loadErrorTypes();
    loadStatistics();
});

// Fonctions utilitaires
function showToast(message, type) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 100);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => container.removeChild(toast), 300);
    }, 3000);
}

function apiCall(url, options = {}) {
    return fetch(url, {
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        },
        ...options
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    });
}

// Chargement des donn√©es
function loadErrorTypes() {
    apiCall('/api/arr/error-types')
        .then(response => {
            if (response.success) {
                currentErrorTypes = response.error_types;
                filteredErrorTypes = {...currentErrorTypes};
                renderErrorTypes();
            } else {
                showToast('Erreur chargement types d\'erreurs: ' + response.error, 'error');
            }
        })
        .catch(error => {
            showToast('Erreur API: ' + error.message, 'error');
        });
}

function loadStatistics() {
    apiCall('/api/arr/error-statistics')
        .then(response => {
            if (response.success) {
                const stats = response.statistics;
                document.getElementById('total-types').textContent = stats.total_types;
                document.getElementById('enabled-types').textContent = stats.enabled_types;
                document.getElementById('detections-today').textContent = stats.detections_today;
                
                // Compter les types avec auto-correction
                const autoCorrectCount = Object.values(stats.by_type)
                    .filter(type => type.auto_correct && type.enabled).length;
                document.getElementById('auto-correct-types').textContent = autoCorrectCount;
            }
        })
        .catch(error => {
            console.error('Erreur chargement statistiques:', error);
        });
}

// Rendu de l'interface
function renderErrorTypes() {
    const container = document.getElementById('error-types-container');
    container.innerHTML = '';
    
    for (const [typeName, config] of Object.entries(filteredErrorTypes)) {
        const card = createErrorTypeCard(typeName, config);
        container.appendChild(card);
    }
}

function createErrorTypeCard(typeName, config) {
    const cardDiv = document.createElement('div');
    cardDiv.className = 'col-md-6';
    
    const severityClass = `severity-${config.severity}`;
    const disabledClass = config.enabled ? '' : 'disabled';
    
    cardDiv.innerHTML = `
        <div class="card error-type-card ${severityClass} ${disabledClass}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 style="margin: 0;">${config.name}</h5>
                <div>
                    <span class="badge badge-${getSeverityBadgeClass(config.severity)}">${config.severity.toUpperCase()}</span>
                    <span class="badge badge-${config.enabled ? 'success' : 'secondary'}">${config.enabled ? 'Activ√©' : 'D√©sactiv√©'}</span>
                </div>
            </div>
            
            <p style="color: var(--text-muted); margin-bottom: 16px;">${config.description}</p>
            
            <div style="margin-bottom: 16px;">
                <strong>Patterns de d√©tection (${config.detection_patterns.length}):</strong>
                <div style="max-height: 100px; overflow-y: auto; margin-top: 8px;">
                    ${config.detection_patterns.slice(0, 3).map(pattern => 
                        `<div class="pattern-item">${pattern}</div>`
                    ).join('')}
                    ${config.detection_patterns.length > 3 ? 
                        `<small style="color: var(--text-muted);">... et ${config.detection_patterns.length - 3} autres</small>` : ''
                    }
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <strong>Actions (${config.actions.length}):</strong>
                <div style="max-height: 100px; overflow-y: auto; margin-top: 8px;">
                    ${config.actions.slice(0, 2).map(action => 
                        `<div class="action-item ${action.enabled ? '' : 'disabled'}">
                            ${action.name} (priorit√©: ${action.priority})
                        </div>`
                    ).join('')}
                    ${config.actions.length > 2 ? 
                        `<small style="color: var(--text-muted);">... et ${config.actions.length - 2} autres</small>` : ''
                    }
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <div>
                    <small style="color: var(--text-muted);">
                        Max √¢ge: ${config.max_age_hours}h | Intervalle: ${config.min_interval_minutes}min
                    </small>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="editErrorType('${typeName}')" style="padding: 4px 8px; font-size: 12px;">
                        ‚úèÔ∏è Modifier
                    </button>
                    <button class="btn btn-${config.enabled ? 'warning' : 'success'}" onclick="toggleErrorType('${typeName}')" style="padding: 4px 8px; font-size: 12px;">
                        ${config.enabled ? '‚è∏Ô∏è D√©sactiver' : '‚ñ∂Ô∏è Activer'}
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return cardDiv;
}

function getSeverityBadgeClass(severity) {
    switch(severity) {
        case 'low': return 'info';
        case 'medium': return 'warning';
        case 'high': return 'danger';
        case 'critical': return 'danger';
        default: return 'secondary';
    }
}

// Filtrage
function filterErrorTypes() {
    const statusFilter = document.getElementById('filter-status').value;
    const severityFilter = document.getElementById('filter-severity').value;
    
    filteredErrorTypes = {};
    
    for (const [typeName, config] of Object.entries(currentErrorTypes)) {
        let includeType = true;
        
        if (statusFilter) {
            if (statusFilter === 'enabled' && !config.enabled) includeType = false;
            if (statusFilter === 'disabled' && config.enabled) includeType = false;
        }
        
        if (severityFilter && config.severity !== severityFilter) {
            includeType = false;
        }
        
        if (includeType) {
            filteredErrorTypes[typeName] = config;
        }
    }
    
    renderErrorTypes();
}

// Actions sur les types d'erreurs
function toggleErrorType(typeName) {
    const config = currentErrorTypes[typeName];
    const newStatus = !config.enabled;
    
    apiCall(`/api/arr/error-types/${typeName}`, {
        method: 'PUT',
        body: JSON.stringify({
            ...config,
            enabled: newStatus
        })
    })
    .then(response => {
        if (response.success) {
            showToast(`Type d'erreur ${newStatus ? 'activ√©' : 'd√©sactiv√©'}: ${typeName}`, 'success');
            loadErrorTypes();
            loadStatistics();
        } else {
            showToast('Erreur: ' + response.error, 'error');
        }
    })
    .catch(error => {
        showToast('Erreur API: ' + error.message, 'error');
    });
}

function editErrorType(typeName) {
    editingErrorType = typeName;
    const config = currentErrorTypes[typeName];
    
    showConfigModal(config, typeName);
}

function createNewErrorType() {
    editingErrorType = null;
    
    const defaultConfig = {
        name: "",
        description: "",
        enabled: true,
        detection_patterns: [],
        status_filters: [],
        severity: "medium",
        auto_correct: true,
        max_age_hours: 24,
        min_interval_minutes: 5,
        actions: [],
        conditions: {}
    };
    
    showConfigModal(defaultConfig, null);
}

// Modal de configuration
function showConfigModal(config, typeName) {
    const modal = document.getElementById('config-modal');
    const modalBody = document.getElementById('modal-body');
    
    modalBody.innerHTML = generateConfigForm(config, typeName);
    modal.classList.add('show');
}

function closeConfigModal() {
    const modal = document.getElementById('config-modal');
    modal.classList.remove('show');
    editingErrorType = null;
}

function generateConfigForm(config, typeName) {
    return `
        <form id="error-type-form">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nom du type:</label>
                    <input type="text" class="form-control" id="config-name" value="${config.name}" ${typeName ? 'readonly' : ''}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">S√©v√©rit√©:</label>
                    <select class="form-select" id="config-severity">
                        <option value="low" ${config.severity === 'low' ? 'selected' : ''}>Faible</option>
                        <option value="medium" ${config.severity === 'medium' ? 'selected' : ''}>Moyenne</option>
                        <option value="high" ${config.severity === 'high' ? 'selected' : ''}>Haute</option>
                        <option value="critical" ${config.severity === 'critical' ? 'selected' : ''}>Critique</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Description:</label>
                <textarea class="form-control" id="config-description" rows="2">${config.description}</textarea>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        <input type="checkbox" id="config-enabled" ${config.enabled ? 'checked' : ''}> Activ√©
                    </label>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        <input type="checkbox" id="config-auto-correct" ${config.auto_correct ? 'checked' : ''}> Auto-correction
                    </label>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">√Çge maximum (heures):</label>
                    <input type="number" class="form-control" id="config-max-age" value="${config.max_age_hours}" min="1" max="168">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Intervalle minimum (minutes):</label>
                    <input type="number" class="form-control" id="config-min-interval" value="${config.min_interval_minutes}" min="1" max="1440">
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Patterns de d√©tection (un par ligne):</label>
                <textarea class="form-control" id="config-patterns" rows="4" placeholder="Exemple: qBittorrent.*stalled">${config.detection_patterns.join('\\n')}</textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Filtres de statut (s√©par√©s par des virgules):</label>
                <input type="text" class="form-control" id="config-status-filters" value="${config.status_filters.join(', ')}" placeholder="downloading, queued, failed">
            </div>
            
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">Annuler</button>
                <div>
                    ${typeName ? `<button type="button" class="btn btn-danger" onclick="deleteErrorType('${typeName}')">üóëÔ∏è Supprimer</button>` : ''}
                    <button type="button" class="btn btn-success" onclick="saveErrorType()">üíæ Sauvegarder</button>
                </div>
            </div>
        </form>
    `;
}

function saveErrorType() {
    const form = document.getElementById('error-type-form');
    const formData = new FormData(form);
    
    const config = {
        name: document.getElementById('config-name').value,
        description: document.getElementById('config-description').value,
        enabled: document.getElementById('config-enabled').checked,
        severity: document.getElementById('config-severity').value,
        auto_correct: document.getElementById('config-auto-correct').checked,
        max_age_hours: parseInt(document.getElementById('config-max-age').value),
        min_interval_minutes: parseInt(document.getElementById('config-min-interval').value),
        detection_patterns: document.getElementById('config-patterns').value
            .split('\n')
            .map(p => p.trim())
            .filter(p => p.length > 0),
        status_filters: document.getElementById('config-status-filters').value
            .split(',')
            .map(s => s.trim())
            .filter(s => s.length > 0),
        conditions: {},
        actions: editingErrorType ? currentErrorTypes[editingErrorType].actions : []
    };
    
    if (!config.name) {
        showToast('Le nom du type est requis', 'error');
        return;
    }
    
    const url = editingErrorType ? 
        `/api/arr/error-types/${editingErrorType}` : 
        '/api/arr/error-types';
    
    const method = editingErrorType ? 'PUT' : 'POST';
    
    apiCall(url, {
        method: method,
        body: JSON.stringify(config)
    })
    .then(response => {
        if (response.success) {
            showToast(response.message, 'success');
            closeConfigModal();
            loadErrorTypes();
            loadStatistics();
        } else {
            showToast('Erreur: ' + response.error, 'error');
        }
    })
    .catch(error => {
        showToast('Erreur API: ' + error.message, 'error');
    });
}

function deleteErrorType(typeName) {
    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le type d'erreur "${typeName}" ?`)) {
        return;
    }
    
    apiCall(`/api/arr/error-types/${typeName}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.success) {
            showToast(response.message, 'success');
            closeConfigModal();
            loadErrorTypes();
            loadStatistics();
        } else {
            showToast('Erreur: ' + response.error, 'error');
        }
    })
    .catch(error => {
        showToast('Erreur API: ' + error.message, 'error');
    });
}

// Test de d√©tection
function testErrorDetection() {
    const errorMessage = document.getElementById('test-error-message').value.trim();
    
    if (!errorMessage) {
        showToast('Entrez un message d\'erreur √† tester', 'warning');
        return;
    }
    
    const testItem = {
        errorMessage: errorMessage,
        status: 'failed',
        id: 'test-123',
        title: 'Test Item'
    };
    
    apiCall('/api/arr/test-error-detection', {
        method: 'POST',
        body: JSON.stringify({test_item: testItem})
    })
    .then(response => {
        if (response.success) {
            const result = response.result;
            
            if (result.detected_error_type) {
                showToast(`Type d√©tect√©: ${result.detected_error_type} (${result.would_process ? 'sera trait√©' : 'ne sera pas trait√©'})`, 'success');
            } else {
                showToast('Aucun type d\'erreur d√©tect√© pour ce message', 'info');
            }
        } else {
            showToast('Erreur test: ' + response.error, 'error');
        }
    })
    .catch(error => {
        showToast('Erreur API: ' + error.message, 'error');
    });
}

// Export/Import
function exportConfig() {
    const config = JSON.stringify(currentErrorTypes, null, 2);
    const blob = new Blob([config], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `redriva-error-types-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Configuration export√©e', 'success');
}

function importConfig() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedConfig = JSON.parse(e.target.result);
                
                if (confirm('Importer cette configuration remplacera les types d\'erreurs existants. Continuer ?')) {
                    apiCall('/api/arr/error-types/import', {
                        method: 'POST',
                        body: JSON.stringify({config: importedConfig})
                    })
                    .then(response => {
                        if (response.success) {
                            showToast('Configuration import√©e avec succ√®s', 'success');
                            loadErrorTypes();
                            loadStatistics();
                        } else {
                            showToast('Erreur import: ' + response.error, 'error');
                        }
                    })
                    .catch(error => {
                        showToast('Erreur API: ' + error.message, 'error');
                    });
                }
            } catch (error) {
                showToast('Fichier JSON invalide', 'error');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// Fermeture modal sur clic ext√©rieur
document.getElementById('config-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeConfigModal();
    }
});

// Fermeture modal sur Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeConfigModal();
    }
});
</script>

{% endblock %}
