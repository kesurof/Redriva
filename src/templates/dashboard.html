{% extends "base.html" %}

{% block title %}Dashboard - Redriva Web{% endblock %}

{% block content %}
<!-- Messages de notification -->
<div id="toast-container" class="toast-container"></div>

<!-- Modal de confirmation -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmTitle">Confirmer l'action</h3>
        <p id="confirmMessage">Êtes-vous sûr de vouloir effectuer cette action ?</p>
        <div class="modal-actions">
            <button id="confirmBtn" class="btn btn-primary">Confirmer</button>
            <button id="cancelBtn" class="btn">Annuler</button>
        </div>
    </div>
</div>

<!-- En-tête du dashboard -->
<div class="card">
    <h2 style="margin: 0; color: #333; font-weight: 600; display: flex; align-items: center; gap: 12px;">
        🚀 Dashboard Redriva
    </h2>
    <p style="margin: 8px 0 0 0; color: #6c757d;">Tableau de bord de gestion et surveillance</p>
</div>

<!-- Navigation par onglets -->
<div class="tabs-container">
    <div class="tabs-nav">
        <button class="tab-item active" data-tab="overview" onclick="switchTab('overview')">📊 Vue d'ensemble</button>
        <button class="tab-item" data-tab="actions" onclick="switchTab('actions')">🔄 Actions</button>
        <button class="tab-item" data-tab="system" onclick="switchTab('system')">ℹ️ Système</button>
    </div>
</div>

<!-- Onglet Vue d'ensemble -->
<div id="overview-tab" class="tab-pane active">
    <!-- Cartes statistiques Material Design -->
    <div class="detail-grid">
        <div class="card info-card interactive" onclick="navigateToTorrents('')" title="Voir tous les torrents">
            <h3 class="card-title">📁 Torrents totaux</h3>
            <div class="info-table">
                <div class="info-row">
                    <span class="info-label">Total dans la base:</span>
                    <span class="info-value stats-number">{{ stats.total_torrents|default(0) }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Action:</span>
                    <span class="info-value">
                        <span class="action-link">Voir tous les torrents →</span>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card status-card interactive" onclick="showDetailsModal()" title="Voir les détails de couverture">
            <h3 class="card-title">📋 Couverture des détails</h3>
            <div class="info-table">
                <div class="info-row">
                    <span class="info-label">Pourcentage:</span>
                    <span class="info-value stats-number">{{ "%.1f"|format(stats.coverage|default(0)) }}%</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Avec détails:</span>
                    <span class="info-value">{{ stats.total_details|default(0) }} torrents</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Action:</span>
                    <span class="info-value">
                        <span class="action-link">Voir les détails →</span>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card warning-card interactive" onclick="navigateToTorrents('downloading')" title="Voir les torrents actifs">
            <h3 class="card-title">⬇️ Torrents actifs</h3>
            <div class="info-table">
                <div class="info-row">
                    <span class="info-label">En cours:</span>
                    <span class="info-value stats-number">{{ stats.active_count|default(0) }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Statut:</span>
                    <span class="info-value">En traitement</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Action:</span>
                    <span class="info-value">
                        <span class="action-link">Voir les actifs →</span>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card error-card interactive" onclick="navigateToTorrents('error')" title="Voir les torrents en erreur">
            <h3 class="card-title">❌ Torrents en erreur</h3>
            <div class="info-table">
                <div class="info-row">
                    <span class="info-label">Erreurs:</span>
                    <span class="info-value stats-number">{{ stats.error_count|default(0) }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Statut:</span>
                    <span class="info-value">Nécessite attention</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Action:</span>
                    <span class="info-value">
                        <span class="action-link">Résoudre les erreurs →</span>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card error-card interactive" onclick="navigateToTorrents('unavailable')" title="Voir les fichiers indisponibles">
            <h3 class="card-title">📂 Fichiers indisponibles</h3>
            <div class="info-table">
                <div class="info-row">
                    <span class="info-label">Liens morts:</span>
                    <span class="info-value stats-number">{{ stats.unavailable_files|default(0) }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Statut:</span>
                    <span class="info-value">Erreurs 503/404/24</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Action:</span>
                    <span class="info-value">
                        <span class="action-link">Gérer les indisponibles →</span>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card warning-card interactive" onclick="navigateToTorrents('incomplete')" title="Voir les torrents avec détails manquants">
            <h3 class="card-title">⚠️ Détails manquants</h3>
            <div class="info-table">
                <div class="info-row">
                    <span class="info-label">Torrents sans détails:</span>
                    <span class="info-value stats-number">{{ stats.incomplete_torrents|default(0) }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Statut:</span>
                    <span class="info-value">Pas de données RD</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Action:</span>
                    <span class="info-value">
                        <span class="action-link">Analyser les manquants →</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Onglet Actions -->
<div id="actions-tab" class="tab-pane">
    <!-- Section Synchronisation -->
    <div class="card action-card">
        <h3 class="card-title">🔄 Actions de synchronisation</h3>
        <div class="actions-grid">
            <button onclick="executeSyncAction('/sync/smart', '🧠 Synchronisation intelligente')" class="btn btn-primary action-button">
                <div class="action-icon">🧠</div>
                <div class="action-content">
                    <strong>Sync intelligent</strong>
                    <span>Mode recommandé - Analyse et traite selon les priorités</span>
                </div>
            </button>
            
            <button onclick="executeSyncAction('/sync/fast', '🚀 Synchronisation complète')" class="btn btn-success action-button">
                <div class="action-icon">🚀</div>
                <div class="action-content">
                    <strong>Sync complet</strong>
                    <span>Première installation ou resync complet</span>
                </div>
            </button>
            
            <button onclick="executeSyncAction('/sync/torrents', '📋 Vue d\'ensemble')" class="btn btn-info action-button">
                <div class="action-icon">📋</div>
                <div class="action-content">
                    <strong>Vue d'ensemble</strong>
                    <span>Mise à jour rapide de la liste des torrents</span>
                </div>
            </button>
            
            <button onclick="refreshStatistics()" class="btn btn-warning action-button">
                <div class="action-icon">📊</div>
                <div class="action-content">
                    <strong>Rafraîchir statistiques</strong>
                    <span>Corrige les statistiques après suppressions</span>
                </div>
            </button>
            
            <button onclick="executeSyncAction('/api/health/check_all', '🔍 Vérifier santé des fichiers')" class="btn btn-info action-button">
                <div class="action-icon">🔍</div>
                <div class="action-content">
                    <strong>Vérifier santé fichiers</strong>
                    <span>Teste tous les liens pour détecter les indisponibles</span>
                </div>
            </button>
            
            <button onclick="executeSyncAction('/api/health/cleanup', '🧹 Nettoyer fichiers morts')" class="btn btn-danger action-button">
                <div class="action-icon">🧹</div>
                <div class="action-content">
                    <strong>Nettoyer indisponibles</strong>
                    <span>Supprime les torrents avec liens morts + notifie Sonarr/Radarr</span>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Onglet Système -->
<div id="system-tab" class="tab-pane">
    <!-- Section Informations statiques -->
    <div class="card system-info">
        <h3 class="card-title">📊 Informations système</h3>
        <div class="info-grid">
            <!-- Couverture -->
            <div class="info-item">
                <div class="info-icon">📊</div>
                <div class="info-content">
                    <strong>Couverture détails</strong>
                    <span>{{ "%.1f"|format((stats.total_details / stats.total_torrents * 100) if stats.total_torrents > 0 else 0) }}%</span>
                </div>
            </div>
            
            <!-- Volume total -->
            <div class="info-item">
                <div class="info-icon">💾</div>
                <div class="info-content">
                    <strong>Volume total</strong>
                    <span>{{ stats.total_size|default("N/A") }}</span>
                </div>
            </div>
            
            <!-- Activité récente 24h -->
            <div class="info-item">
                <div class="info-icon">🆕</div>
                <div class="info-content">
                    <strong>Nouveaux (24h)</strong>
                    <span>{{ stats.recent_24h|default(0) }}</span>
                </div>
            </div>
            
            <!-- Activité récente 7j -->
            <div class="info-item">
                <div class="info-icon">📅</div>
                <div class="info-content">
                    <strong>Nouveaux (7j)</strong>
                    <span>{{ stats.recent_7d|default(0) }}</span>
                </div>
            </div>
            
            <!-- Token Real-Debrid -->
            <div class="info-item">
                <div class="info-icon">🔑</div>
                <div class="info-content">
                    <strong>Token Real-Debrid</strong>
                    <span class="status-indicator ready">Configuré</span>
                </div>
            </div>
            
            <!-- Version Python -->
            <div class="info-item">
                <div class="info-icon">🐍</div>
                <div class="info-content">
                    <strong>Version Python</strong>
                    <span>{{ python_version|default("3.x") }}</span>
                </div>
            </div>
            
            <!-- Environnement -->
            <div class="info-item">
                <div class="info-icon">🐳</div>
                <div class="info-content">
                    <strong>Environnement</strong>
                    <span>{{ 'Docker' if is_docker else 'Local' }}</span>
                </div>
            </div>
            
            <!-- Statut des tâches -->
            <div class="info-item">
                <div class="info-icon">🕒</div>
                <div class="info-content">
                    <strong>Statut système</strong>
                    <span class="status-indicator {{ 'running' if task_status.running else 'ready' }}">
                        {{ 'En cours' if task_status.running else 'Prêt' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Styles Material Design pour le dashboard harmonisé */

/* Variables CSS pour cohérence */
:root {
    --primary-color: #007bff;
    --primary-gradient: linear-gradient(135deg, #007bff, #0056b3);
    --success-color: #28a745;
    --success-gradient: linear-gradient(135deg, #28a745, #1e7e34);
    --warning-color: #ffc107;
    --warning-gradient: linear-gradient(135deg, #ffc107, #e0a800);
    --danger-color: #dc3545;
    --danger-gradient: linear-gradient(135deg, #dc3545, #c82333);
    --info-color: #17a2b8;
    --info-gradient: linear-gradient(135deg, #17a2b8, #138496);
    --text-color: #2c3e50;
    --border-radius: 12px;
    --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --card-hover-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Système de notifications toast */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.toast {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    padding: 16px;
    margin-bottom: 10px;
    border-left: 4px solid;
    min-width: 300px;
    animation: slideIn 0.3s ease;
}

.toast.success { border-left-color: var(--success-color); }
.toast.error { border-left-color: var(--danger-color); }
.toast.info { border-left-color: var(--info-color); }
.toast.warning { border-left-color: var(--warning-color); }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* Modal de confirmation */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1001;
    animation: fadeIn 0.2s ease;
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: var(--border-radius);
    padding: 24px;
    min-width: 400px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Navigation par onglets */
.tabs-container {
    margin: 20px 0;
}

.tabs-nav {
    display: flex;
    gap: 4px;
    background: #f8f9fa;
    padding: 6px;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
}

.tab-item {
    flex: 1;
    padding: 12px 20px;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    color: #6c757d;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tab-item:hover {
    background: rgba(0, 123, 255, 0.1);
    color: var(--primary-color);
}

.tab-item.active {
    background: white;
    color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
}

/* Onglets de contenu - Transition simple */
.tab-pane {
    display: none !important;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.tab-pane.active {
    display: block !important;
    opacity: 1;
}

/* Optimisation GPU pour les effets de survol uniquement */
.card:hover, .info-item:hover, .action-button:hover {
    will-change: transform, box-shadow;
}

.card, .info-item, .action-button {
    will-change: auto;
}

/* Grille détails Material Design */
.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

/* Cards Material Design */
.card {
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    border: 1px solid rgba(220, 226, 231, 0.8);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
}

.card:hover {
    box-shadow: var(--card-hover-shadow);
    transform: translateY(-2px);
}

.card.interactive {
    cursor: pointer;
}

.card.interactive:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

/* Styles de cards spécifiques */
.card.info-card { border-left: 4px solid var(--primary-color); }
.card.status-card { border-left: 4px solid var(--success-color); }
.card.warning-card { border-left: 4px solid var(--warning-color); }
.card.error-card { border-left: 4px solid var(--danger-color); }
.card.action-card { border-left: 4px solid var(--info-color); }
.card.system-info { border-left: 4px solid #6f42c1; }

/* Titres des cards */
.card-title {
    font-size: 1.3em;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f1f3f4;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Tables d'informations */
.info-table {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f1f3f4;
    transition: var(--transition);
}

.info-row:last-child {
    border-bottom: none;
}

.info-row:hover {
    background: #f8f9fa;
    border-radius: 8px;
    margin: 0 -12px;
    padding: 12px;
}

.info-label {
    font-weight: 500;
    color: #6c757d;
    min-width: 140px;
}

.info-value {
    color: var(--text-color);
    font-weight: 500;
    text-align: right;
    flex: 1;
}

.stats-number {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--primary-color);
}

.action-link {
    color: var(--primary-color);
    font-size: 0.9em;
    transition: var(--transition);
}

.action-link:hover {
    color: var(--success-color);
    transform: translateX(3px);
}

/* Grille d'actions */
.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

/* Boutons d'action Material Design */
.action-button {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
    box-shadow: var(--card-shadow);
    font-family: inherit;
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--card-hover-shadow);
}

.action-button.btn-primary {
    background: var(--primary-gradient);
    color: white;
}

.action-button.btn-success {
    background: var(--success-gradient);
    color: white;
}

.action-button.btn-info {
    background: var(--info-gradient);
    color: white;
}

.action-button.btn-warning {
    background: var(--warning-gradient);
    color: white;
}

.action-button.btn-danger {
    background: var(--danger-gradient);
    color: white;
}

.action-icon {
    font-size: 2.2em;
    opacity: 0.9;
    flex-shrink: 0;
}

.action-content {
    flex: 1;
}

.action-content strong {
    display: block;
    font-size: 1.2em;
    margin-bottom: 6px;
    font-weight: 600;
}

.action-content span {
    font-size: 0.95em;
    opacity: 0.9;
    line-height: 1.4;
}

/* Grille d'informations système */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 18px;
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: var(--border-radius);
    border: 1px solid #e9ecef;
    transition: var(--transition);
}

.info-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--card-shadow);
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
}

.info-icon {
    font-size: 2em;
    flex-shrink: 0;
}

.info-content {
    flex: 1;
}

.info-content strong {
    display: block;
    font-size: 0.95em;
    color: #6c757d;
    margin-bottom: 4px;
    font-weight: 500;
}

.info-content span {
    font-size: 1.2em;
    font-weight: 600;
    color: var(--text-color);
}

/* Indicateurs de statut */
.status-indicator {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9em;
    font-weight: 500;
    display: inline-block;
}

.status-indicator.running {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    color: #856404;
    border: 1px solid #ffeaa7;
}

.status-indicator.ready {
    background: linear-gradient(135deg, #d4edda, #a8e6cf);
    color: #155724;
    border: 1px solid #a8e6cf;
}

.status-indicator.warning {
    background: linear-gradient(135deg, #ffe6cc, #ffcc99);
    color: #cc7a00;
    border: 1px solid #ffcc99;
}

/* Boutons harmonisés */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: var(--transition);
    font-family: inherit;
    font-size: 0.95em;
}

.btn-primary {
    background: var(--primary-gradient);
    color: white;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
}

.btn:not(.btn-primary) {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.btn:not(.btn-primary):hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

/* Responsive Design */
@media (max-width: 768px) {
    .detail-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .actions-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .tabs-nav {
        flex-direction: column;
        gap: 2px;
    }
    
    .tab-item {
        justify-content: flex-start;
    }
    
    .card {
        padding: 20px;
    }
    
    .action-button {
        padding: 16px;
    }
    
    .info-item {
        padding: 15px;
    }
    
    .modal-content {
        min-width: 90%;
        margin: 20px;
    }
}
</style>

<script>
// Gestion des onglets
function switchTab(tabName) {
    console.log('🔄 Changement vers onglet:', tabName);
    
    // Désactiver tous les onglets et leurs contenus
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
        // Réinitialiser les animations des éléments
        pane.querySelectorAll('.animate').forEach(el => {
            el.classList.remove('animate');
        });
    });
    
    // Activer l'onglet et le contenu sélectionnés
    const tabElement = document.querySelector(`[data-tab="${tabName}"]`);
    const tabPane = document.getElementById(`${tabName}-tab`);
    
    if (tabElement && tabPane) {
        tabElement.classList.add('active');
        tabPane.classList.add('active');
        
        // Animer les nouveaux éléments après un court délai
        setTimeout(() => {
            const elements = tabPane.querySelectorAll('.card, .info-item, .action-button');
            elements.forEach((element, index) => {
                setTimeout(() => {
                    element.classList.add('animate');
                }, index * 80);
            });
        }, 100);
        
        console.log('✅ Onglet activé:', tabName);
    } else {
        console.error('❌ Éléments introuvables pour:', tabName);
    }
}

// Fonctions de navigation
function navigateToTorrents(status) {
    if (status) {
        window.location.href = `/torrents?status=${status}`;
    } else {
        window.location.href = '/torrents';
    }
}

function showDetailsModal() {
    showToast('info', 'Informations détaillées', 'Cette section affiche le pourcentage de torrents avec des détails complets.');
}

// Fonction d'exécution des actions de synchronisation
function executeSyncAction(url, actionName) {
    showConfirmModal(
        'Confirmer la synchronisation',
        `Voulez-vous vraiment lancer : ${actionName} ?`,
        () => {
            showToast('info', 'Action lancée', `${actionName} en cours d'exécution...`);
            
            fetch(url)
                .then(response => {
                    if (response.ok) {
                        showToast('success', 'Succès', `${actionName} démarrée`);
                        // Recharger la page après 10 secondes pour voir les nouveaux stats
                        setTimeout(() => location.reload(), 10000);
                    } else {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                })
                .catch(error => {
                    showToast('error', 'Erreur', `Échec du démarrage de ${actionName}`);
                });
        }
    );
}

// Système de notifications toast harmonisé
function showToast(type, title, message) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <strong>${title}</strong><br>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    // Supprimer automatiquement après 5 secondes
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => {
            if (container.contains(toast)) {
                container.removeChild(toast);
            }
        }, 300);
    }, 5000);
}

// Système de modal de confirmation harmonisé
function showConfirmModal(title, message, onConfirm) {
    const modal = document.getElementById('confirmModal');
    const titleEl = document.getElementById('confirmTitle');
    const messageEl = document.getElementById('confirmMessage');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    
    modal.style.display = 'block';
    
    const handleConfirm = () => {
        modal.style.display = 'none';
        onConfirm();
        cleanup();
    };
    
    const handleCancel = () => {
        modal.style.display = 'none';
        cleanup();
    };
    
    const cleanup = () => {
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
    };
    
    confirmBtn.addEventListener('click', handleConfirm);
    cancelBtn.addEventListener('click', handleCancel);
    
    // Fermer avec Escape
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            handleCancel();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
    
    // Fermer en cliquant à l'extérieur
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            handleCancel();
        }
    });
}

// Fonction pour rafraîchir les statistiques
function refreshStatistics() {
    showConfirmModal(
        'Rafraîchir les statistiques',
        'Cette action va corriger les statistiques après les suppressions. Continuer ?',
        () => {
            showToast('info', 'Correction en cours', 'Mise à jour des statistiques...');
            
            fetch('/api/fix_deleted_status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Statistiques corrigées', `${data.fixed_count} torrent(s) corrigé(s)`);
                        // Recharger la page pour voir les nouvelles statistiques
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        throw new Error(data.error || 'Erreur inconnue');
                    }
                })
                .catch(error => {
                    showToast('error', 'Erreur', `Échec de la correction: ${error.message}`);
                });
        }
    );
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Dashboard chargé');
    
    // Gestion des interactions tactiles sur mobile
    if ('ontouchstart' in window) {
        const interactiveCards = document.querySelectorAll('.card.interactive');
        interactiveCards.forEach(card => {
            card.addEventListener('touchstart', function() {
                this.style.transform = 'translateY(-2px) scale(0.98)';
            });
            
            card.addEventListener('touchend', function() {
                this.style.transform = '';
            });
        });
    }
    
    // Amélioration de l'accessibilité - navigation clavier pour les onglets
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
        
        // Rendre les onglets focusables
        tab.setAttribute('tabindex', '0');
    });
    
    // Amélioration de l'accessibilité - navigation clavier pour les cartes interactives
    document.querySelectorAll('.card.interactive').forEach(card => {
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'button');
        
        card.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
});
</script>
{% endblock %}
