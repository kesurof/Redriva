#!/bin/bash

# Script d'arrÃªt d'urgence pour Redriva
# Utilisation: ./stop-redriva
# Ce script arrÃªte tous les services et processus Redriva en cours

echo "ğŸ›‘ ArrÃªt d'urgence de Redriva..."

# Fonction pour afficher les messages avec couleurs
print_status() {
    case $1 in
        "info")    echo -e "\033[1;34m[INFO]\033[0m $2" ;;
        "success") echo -e "\033[1;32m[OK]\033[0m $2" ;;
        "warning") echo -e "\033[1;33m[WARN]\033[0m $2" ;;
        "error")   echo -e "\033[1;31m[ERROR]\033[0m $2" ;;
        *)         echo "$2" ;;
    esac
}

# ArrÃªter les processus Python Redriva
print_status "info" "Recherche des processus Redriva..."

# ArrÃªter le serveur web principal
WEB_PIDS=$(pgrep -f "python.*src/web.py")
if [ ! -z "$WEB_PIDS" ]; then
    print_status "info" "ArrÃªt du serveur web Redriva (PIDs: $WEB_PIDS)..."
    echo "$WEB_PIDS" | xargs kill -TERM 2>/dev/null
    sleep 2
    
    # VÃ©rifier si les processus sont toujours actifs
    REMAINING_WEB=$(pgrep -f "python.*src/web.py")
    if [ ! -z "$REMAINING_WEB" ]; then
        print_status "warning" "ArrÃªt forcÃ© du serveur web..."
        echo "$REMAINING_WEB" | xargs kill -KILL 2>/dev/null
    fi
    print_status "success" "Serveur web arrÃªtÃ©"
else
    print_status "info" "Aucun serveur web Redriva en cours"
fi

# ArrÃªter les processus main.py
MAIN_PIDS=$(pgrep -f "python.*src/main.py")
if [ ! -z "$MAIN_PIDS" ]; then
    print_status "info" "ArrÃªt des processus main.py (PIDs: $MAIN_PIDS)..."
    echo "$MAIN_PIDS" | xargs kill -TERM 2>/dev/null
    sleep 2
    
    REMAINING_MAIN=$(pgrep -f "python.*src/main.py")
    if [ ! -z "$REMAINING_MAIN" ]; then
        print_status "warning" "ArrÃªt forcÃ© des processus main.py..."
        echo "$REMAINING_MAIN" | xargs kill -KILL 2>/dev/null
    fi
    print_status "success" "Processus main.py arrÃªtÃ©s"
else
    print_status "info" "Aucun processus main.py en cours"
fi

# ArrÃªter tous les autres processus Python liÃ©s Ã  Redriva
OTHER_PIDS=$(pgrep -f "python.*redriva" | grep -v $$)
if [ ! -z "$OTHER_PIDS" ]; then
    print_status "info" "ArrÃªt d'autres processus Redriva (PIDs: $OTHER_PIDS)..."
    echo "$OTHER_PIDS" | xargs kill -TERM 2>/dev/null
    sleep 2
    
    REMAINING_OTHER=$(pgrep -f "python.*redriva" | grep -v $$)
    if [ ! -z "$REMAINING_OTHER" ]; then
        print_status "warning" "ArrÃªt forcÃ© d'autres processus..."
        echo "$REMAINING_OTHER" | xargs kill -KILL 2>/dev/null
    fi
    print_status "success" "Autres processus Redriva arrÃªtÃ©s"
fi

# ArrÃªter les processus Docker si ils existent
print_status "info" "VÃ©rification des conteneurs Docker..."
if command -v docker &> /dev/null; then
    REDRIVA_CONTAINERS=$(docker ps -q --filter "name=redriva" 2>/dev/null)
    if [ ! -z "$REDRIVA_CONTAINERS" ]; then
        print_status "info" "ArrÃªt des conteneurs Docker Redriva..."
        echo "$REDRIVA_CONTAINERS" | xargs docker stop 2>/dev/null
        print_status "success" "Conteneurs Docker arrÃªtÃ©s"
    else
        print_status "info" "Aucun conteneur Docker Redriva en cours"
    fi
    
    # VÃ©rifier docker-compose dans le rÃ©pertoire ssdv2
    if [ -f "ssdv2/docker-compose.yml" ]; then
        print_status "info" "VÃ©rification docker-compose dans ssdv2/..."
        cd ssdv2 && docker-compose down 2>/dev/null && cd .. || true
        print_status "success" "Docker-compose ssdv2 arrÃªtÃ©"
    fi
else
    print_status "info" "Docker non disponible"
fi

# Nettoyer les fichiers de verrouillage potentiels
print_status "info" "Nettoyage des fichiers temporaires..."
find . -name "*.lock" -type f -delete 2>/dev/null || true
find . -name "*.pid" -type f -delete 2>/dev/null || true

# LibÃ©rer le port 5000 si occupÃ© par d'autres processus
PORT_5000=$(lsof -ti:5000 2>/dev/null)
if [ ! -z "$PORT_5000" ]; then
    print_status "warning" "Port 5000 occupÃ© par le processus $PORT_5000, libÃ©ration..."
    kill -TERM $PORT_5000 2>/dev/null || true
    sleep 1
    PORT_5000_REMAINING=$(lsof -ti:5000 2>/dev/null)
    if [ ! -z "$PORT_5000_REMAINING" ]; then
        kill -KILL $PORT_5000_REMAINING 2>/dev/null || true
    fi
    print_status "success" "Port 5000 libÃ©rÃ©"
fi

# VÃ©rification finale
print_status "info" "VÃ©rification finale..."
REMAINING_PROCESSES=$(pgrep -f "python.*src/(web|main).py" 2>/dev/null)
if [ -z "$REMAINING_PROCESSES" ]; then
    print_status "success" "âœ… Tous les services Redriva ont Ã©tÃ© arrÃªtÃ©s avec succÃ¨s"
else
    print_status "error" "âš ï¸ Certains processus sont encore actifs: $REMAINING_PROCESSES"
    print_status "info" "Vous pouvez les arrÃªter manuellement avec: kill -9 $REMAINING_PROCESSES"
fi

# Afficher un rÃ©sumÃ©
echo ""
echo "ğŸ“Š RÃ©sumÃ© de l'arrÃªt:"
echo "   â€¢ Serveur web Redriva: arrÃªtÃ©"
echo "   â€¢ Processus main.py: arrÃªtÃ©"
echo "   â€¢ Conteneurs Docker: vÃ©rifiÃ©s"
echo "   â€¢ Port 5000: libÃ©rÃ©"
echo "   â€¢ Fichiers temporaires: nettoyÃ©s"
echo ""
print_status "info" "Pour redÃ©marrer Redriva:"
print_status "info" "  â€¢ Interface web: python src/web.py"
print_status "info" "  â€¢ CLI: python src/main.py --help"
print_status "info" "  â€¢ Docker: cd ssdv2 && docker-compose up -d"
echo ""
print_status "success" "ğŸ ArrÃªt terminÃ©"
