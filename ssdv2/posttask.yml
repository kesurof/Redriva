---
- name: "Wait for Redriva container to be running"
  shell: |
    for i in {1..15}; do
      if docker ps --filter "name={{ pgrole }}" --filter "status=running" | grep -q "{{ pgrole }}"; then
        exit 0
      fi
      sleep 1
    done
    exit 1
  register: container_check
  ignore_errors: yes

- name: "Get container status details"
  shell: "docker ps --filter 'name={{ pgrole }}' --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
  register: container_status
  when: container_check.rc == 0

- name: "Display deployment success"
  debug:
    msg: |
      ğŸš€ REDRIVA DÃ‰PLOYÃ‰ AVEC SUCCÃˆS !
      =================================
      
      ğŸŒ Interface Web: http://{{ domain | default(ansible_default_ipv4.address) }}:{{ port | default('8000') }}
      ğŸ“ Config Path: {{ settings.storage }}/docker/{{ lookup('env','USER') }}/{{ pgrole }}/config
      ğŸ’¾ Data Path: {{ settings.storage }}/docker/{{ lookup('env','USER') }}/{{ pgrole }}/data
      
      ğŸ“Š Status Container:
      {{ container_status.stdout }}
      
      ğŸ”§ Configuration initiale:
      â€¢ Rendez-vous sur l'interface web pour configurer vos torrents
      â€¢ Configurez vos rÃ©pertoires source et destination
      â€¢ Activez le nettoyage intelligent des liens symboliques
      
      ğŸ“‹ Commandes utiles:
      â€¢ sudo docker logs {{ pgrole }}             (voir les logs)
      â€¢ sudo docker restart {{ pgrole }}          (redÃ©marrer le service)
      â€¢ sudo docker exec -it {{ pgrole }} bash    (accÃ¨s au conteneur)
      
      âœ… Container dÃ©marrÃ© avec succÃ¨s !
      ğŸŒ L'interface web devrait Ãªtre accessible immÃ©diatement
  when: container_check.rc == 0

- name: "Display error if container failed to start"
  debug:
    msg: |
      âŒ ERREUR LORS DU DÃ‰MARRAGE DE REDRIVA
      =====================================
      
      Le container n'a pas pu dÃ©marrer. Actions de dÃ©pannage :
      
      ğŸ” VÃ©rifiez les logs :
      sudo docker logs {{ pgrole }}
      
      ğŸ”§ VÃ©rifiez les permissions :
      ls -la {{ settings.storage }}/docker/{{ lookup('env','USER') }}/{{ pgrole }}/
      
      ğŸ”„ Essayez de redÃ©marrer :
      sudo docker restart {{ pgrole }}
      
      ğŸ“ VÃ©rifiez l'espace disque disponible
      
      ğŸ”§ VÃ©rifiez la configuration Docker :
      sudo docker inspect {{ pgrole }}
  when: container_check.rc != 0
