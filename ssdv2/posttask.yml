---
- name: "Wait for container to be ready"
  wait_for:
    host: "127.0.0.1"
    port: 5000
    timeout: 60
  ignore_errors: yes

- name: "Test health endpoint"
  uri:
    url: "http://localhost:5000/api/health"
    method: GET
    timeout: 10
  register: health_check
  ignore_errors: yes

- name: "Check if token is default"
  shell: grep -q "your_real_debrid_token_here" "{{ settings.storage }}/docker/{{ lookup('env','USER') }}/{{ pgrole }}/config/.env"
  register: default_token_check
  ignore_errors: yes
  changed_when: false

- name: "Prompt for Real-Debrid token"
  pause:
    prompt: |
      
      ğŸ”‘ Configuration du token Real-Debrid
      =====================================
      
      Veuillez coller votre token Real-Debrid ci-dessous :
      (Obtenez-le sur : https://real-debrid.com/apitoken)
      
      Token
  register: rd_token_input
  when: default_token_check.rc == 0

- name: "Update .env file with token"
  lineinfile:
    path: "{{ settings.storage }}/docker/{{ lookup('env','USER') }}/{{ pgrole }}/config/.env"
    regexp: '^RD_TOKEN='
    line: "RD_TOKEN={{ rd_token_input.user_input }}"
    backup: yes
  when: rd_token_input.user_input is defined and rd_token_input.user_input != ""

- name: "Restart container after token update"
  docker_container:
    name: "{{ pgrole }}"
    state: started
    restart: yes
  when: rd_token_input.user_input is defined and rd_token_input.user_input != ""

- name: "Display deployment status"
  debug:
    msg: |
      ğŸš€ DÃ©ploiement Redriva terminÃ© !
      =================================
      
      {% if health_check.status == 200 %}
      âœ… Status: OpÃ©rationnel
      {% else %}
      âš ï¸  Status: En cours de dÃ©marrage
      {% endif %}
      
      {% if rd_token_input.user_input is defined and rd_token_input.user_input != "" %}
      ğŸ”‘ Token configurÃ©: âœ…
      {% else %}
      ğŸ”‘ Token: âš ï¸  Configurez manuellement dans le fichier .env
      {% endif %}
      
      ğŸŒ Interface web: https://{{ sub[pgrole][pgrole] if sub_enabled else pgrole }}.{{ user.domain }}
      ğŸ“Š Health check: http://localhost:5000/api/health
      
      ğŸ“ Configuration:
        - Ã‰ditez: {{ settings.storage }}/docker/{{ lookup('env','USER') }}/{{ pgrole }}/config/.env
        - Token RD: https://real-debrid.com/apitoken
        - Logs: docker logs {{ pgrole }}
      
      ğŸ”§ Commandes utiles:
        - Sync: docker exec {{ pgrole }} python src/main.py --sync-smart
        - Stats: docker exec {{ pgrole }} python src/main.py --stats --compact
        - Restart: docker restart {{ pgrole }}
